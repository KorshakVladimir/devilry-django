.. _devilry_qualifiesforexam:

============================================
:mod:`devilry_qualifiesforexam`
============================================

Database models, APIs and UI for qualifying students for final exams.


.. _qualifiesforexam-uiworkflow:

#######################################################
UI workflow
#######################################################
How users are qualified for final exam i plugin-based. The subject/period admin is taken through
a wizard with the following steps/pages:

1. If no configuration exists for the period:
       List the title and description of each plugin (see :ref:`qualifiesforexam-plugins` below),
       and let the user select the plugin they want to use. The selection is stored in
       :attr:`QualifiesForFinalExamPeriodStatus.plugin`.
   If a configuration exists for the period:
       Show the overview of the semester (basically the same as the preview described as page 3 below).
       Includes a button to change the configuration. Clicking this button will show the list
       of plugins, just like when no configuration exists, with the previously used plugin
       selected. The *change*-button is only available on active periods.
2. Completely controlled by the plugin. May be more than one page if that should be needed by
   the plugin. The plugin can also just redirect directly to the next page if it does not require
   any input from the user. We supply a footer with save and back buttons that should be the same
   for all plugins.
3. Preview the results with the option to save or go back to the previous page.



.. _qualifiesforexam-plugins:

#######################################################
Plugins
#######################################################
A plugin is a regular Django app.


.. _qualifiesforexam-plugins-what:

The role of the plugin
======================
A plugin is basically one or more Django views that, for the qualifies-for-exam system, acts like
a black box with the following input and output:

- The input is a dict store by the qualifies-for-exam system in the users session (``request.session``):

    ``periodid``
        The ID of the class:`devilry.apps.core.models.Period`.
    ``pluginsessionid``
        An ID that is generated by the qualifies-for-exam system. It is used to ensure that
        we do not get session key collisions when using the wizard from multiple browser windows at
        the same time.

- The output is a :class:`devilry_qualifiesforexam.pluginhelpers.PreviewData`-object stored in the
  users session (``request.session``) under the ``qualifiesforexam-<pluginsessionid>`` key. The
  output object is used by the REST-api that generates the preview-data.


Registering an app as a qualifiesforexam plugin
===============================================
Add something like the following to ``yourapp/devilry_plugin.py``::

    from devilry_qualifiesforexam.registry import qualifiesforexam_plugins
    from django.core.urlresolvers import reverse
    from django.utils.translation import ugettext_lazy as _

    qualifiesforexam_plugins.add(
        id='myapp',
        url=reverse('myapp-myplugin'), # The url of the view to use for step/page 2 in the workflow - the input parameters (see above) is added to this url.
        title=_('My plugin'),
        description=_('Does <strong>this</strong> and <em>that</em>.')
    )



Configure available plugins
===========================
Available plugins are configured in ``settings.DEVILRY_QUALIFIESFOREXAM_PLUGINS``, which is
a list of plugin ids. Note that the apps containing the plugin must also be in
``settings.INSTALLED_APPS``, and the urls must be registered.
The plugins are shown in listed order on page 1 of the wizard described in the
:ref:`qualifiesforexam-uiworkflow`.

.. note::
    You can safely remove plugins from ``settings.DEVILRY_QUALIFIESFOREXAM_PLUGINS``.
    They will simply not be available in the list of plugins in the
    :ref:`qualifiesforexam-uiworkflow`.




#######################################################
Plugin helpers
#######################################################

.. py:class:: devilry_qualifiesforexam.pluginhelpers.PreviewData(passing_relatedstudentids)

    Stores the output from a plugin.

    :param passing_relatedstudentids: See :attr:`.passing_relatedstudentids`.

    .. py:attribute:: passing_relatedstudentids

        List of the IDs of all :class:`devilry.apps.core.models.RelatedStudent` that
        qualifies for final exams according to the plugin that generated the data.



.. py:function:: devilry_qualifiesforexam.pluginhelpers.create_sessionkey(pluginsessionid)

    Generate the session key for the plugin output as described in
    :ref:`qualifiesforexam-plugins-what`.


.. py:class:: devilry_qualifiesforexam.pluginhelpers.QualifiesForExamViewMixin

    A mixin class that simplifies the common tasks for all plugin views (getting input and setting
    output). It basically turns the input and output steps described in
    :ref:`qualifiesforexam-plugins-what` into two simple methods.

    .. py:attribute:: periodid

        The ID of the period --- set by :meth:`.get_plugin_input`.

    .. py:attribute:: period

        The period object loaded using the :func:`django.shortcuts.get_object_or_404` ---
        set by :meth:`.get_plugin_input`.

    .. py:attribute:: pluginsessionid

        The pluginsessionid described in :ref:`qualifiesforexam-plugins-what` ---
        set by :meth:`.get_plugin_input`.

    .. py:method:: get_plugin_input

        Reads the parameters (periodid and pluginsessionid) from
        the querystring and store them as in the following instance
        variables: :attr:`.periodid`.

    .. py:method:: save_plugin_output(*args, **kwargs)

        Shortcut that saves a :class:`.PreviewData` in the session key generated
        using :func:`.create_sessionkey`. Args and kwargs are forwarded to :class:`.PreviewData`.



#######################################################
Plugins shipped with Devilry
#######################################################

``devilry_qualifiesforexam_approved``
==========================================
TODO







.. _qualifiesforexam-models:

#######################################################
Database models
#######################################################


.. py:class:: devilry_qualifiesforexam.models.QualifiesForFinalExamPeriodStatus

    Every time the admin updates qualifies-for-exam on a period, we save new object of this
    database model.

    This gives us a history of changes, and it makes it possible for subject/period admins
    to communicate simple information to whoever it is that is responsible for handling
    examinations.


    .. py:attribute:: period

        Database foreign key to the :class:`devilry.apps.core.models.Period` that the
        status is for.

    .. py:attribute:: status

        Database char field that accepts the following values:
    
        - ``ready`` is used to indicate the the entire period is ready for export/use.
        - ``almostready`` is used to indicate that the period is almost ready for export/use, and
          that the exceptions are explained in the :attr:`.message`.
        - ``notready`` is used to indicate that the period has no useful data yet. This is typically
          only used when the period used to be *ready* or *almostready*, but had to be retracted
          for a reason explained in the status

    .. py:attribute:: createtime

        Database datetime field where we store when we added the status.

    .. py:attribute:: message

        Database field with an optional message about the status change.

    .. py:attribute:: user

        Database foreign key to the user that made the status change.

    .. py:attribute:: plugin

        Database char field that stores the id of the plugin (see :ref:`qualifiesforexam-plugins`)
        that was used to change the status.

    .. py:attribute:: pluginsettings

        A text field where plugins can store their settings, typically in some structured
        format like JSON, XML or YAML.



.. py:class:: devilry_qualifiesforexam.models.QualifiesForFinalExam

    .. py:attribute:: relatedstudent

        Database one-to-one relation to :class:`devilry.apps.core.models.RelatedStudent`.

    .. py:attribute:: qualifies

        Boolean database field telling if the student qualifies or not.

    .. py:attribute:: status

        Foreign key to a :class:`.QualifiesForFinalExamPeriodStatus`.