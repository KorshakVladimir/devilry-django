.. _devilry_qualifiesforexam:

============================================
:mod:`devilry_qualifiesforexam`
============================================

Database models, APIs and UI for qualifying students for final exams.


.. _qualifiesforexam-uiworkflow:

#######################################################
UI workflow
#######################################################
How users are qualified for final exam i plugin-based. The subject/period admin is taken through
a wizard with the following steps/pages:

1. If no configuration exists for the period:
       List the title and description of each plugin (see :ref:`qualifiesforexam-plugins` below),
       and let the user select the plugin they want to use. The selection is stored in
       :attr:`QualifiesForFinalExamPeriodStatus.plugin`.
   If a configuration exists for the period:
       Show the overview of the semester (basically the same as the preview described as page 3 below).
       Includes a button to change the configuration. Clicking this button will show the list
       of plugins, just like when no configuration exists, with the previously used plugin
       selected. The *change*-button is only available on active periods.
2. Completely controlled by the plugin. May be more than one page if that should be needed by
   the plugin. The plugin can also just redirect directly to the next page if it does not require
   any input from the user. We supply a footer with save and back buttons that should be the same
   for all plugins.
3. Preview the results with the option to save or go back to the previous page.



.. _qualifiesforexam-plugins:

#######################################################
Plugins
#######################################################
A plugin is a regular Django app.


.. _qualifiesforexam-plugins-what:

The role of the plugin
======================
A plugin is basically one or more Django views that, for the qualifies-for-exam system, acts like
a black box with the following input and output:

- The input is a dict store by the qualifies-for-exam system in the users session (``request.session``):

    ``periodid``
        The ID of the class:`devilry.apps.core.models.Period`.
    ``pluginsessionid``
        An ID that is generated by the qualifies-for-exam system. It is used to ensure that
        we do not get session key collisions when using the wizard from multiple browser windows at
        the same time.

- The output is a :class:`devilry_qualifiesforexam.pluginhelpers.PreviewData`-object stored in the
  users session (``request.session``) under the ``qualifiesforexam-<pluginsessionid>`` key. The
  output object is used by the REST-api that generates the preview-data.


Registering an app as a qualifiesforexam plugin
===============================================
Add something like the following to ``yourapp/devilry_plugin.py``::

    from devilry_qualifiesforexam.registry import qualifiesforexam_plugins
    from django.core.urlresolvers import reverse
    from django.utils.translation import ugettext_lazy as _

    qualifiesforexam_plugins.add(
        id='myapp',
        url=reverse('myapp-myplugin'), # The url of the view to use for step/page 2 in the workflow - the input parameters (see above) is added to this url.
        title=_('My plugin'),
        description=_('Does <strong>this</strong> and <em>that</em>.')
    )


Create the view
===============

See :ref:`qualifiesforexam-pluginhelpers` and take a look at the sourcecode for
``devilry_qualifiesforexam_approved`` (in the ``src/`` directory of the Devilry sources).


Configure available plugins
===========================
Available plugins are configured in ``settings.DEVILRY_QUALIFIESFOREXAM_PLUGINS``, which is
a list of plugin ids. Note that the apps containing the plugin must also be in
``settings.INSTALLED_APPS``, and the urls must be registered.
The plugins are shown in listed order on page 1 of the wizard described in the
:ref:`qualifiesforexam-uiworkflow`.

.. note::
    You can safely remove plugins from ``settings.DEVILRY_QUALIFIESFOREXAM_PLUGINS``.
    They will simply not be available in the list of plugins in the
    :ref:`qualifiesforexam-uiworkflow`.



.. _qualifiesforexam-pluginhelpers:

#######################################################
Plugin helpers
#######################################################

.. py:currentmodule:: devilry_qualifiesforexam.pluginhelpers

The QualifiesForExamPluginViewMixin class
=========================================

:class:`~devilry_qualifiesforexam.pluginhelpers.QualifiesForExamPluginViewMixin` is a mixin class
that simplifies the common tasks for all plugin views (getting input and setting
output).


Basic usage
-----------

Basic usage of the class turns the input and output steps described in
:ref:`qualifiesforexam-plugins-what` into two methods:
:meth:`get_plugin_input_and_authenticate`, :meth:`.save_plugin_output`. Those two
methods greatly simplify writing plugins. For example, we can create a view like this::

    from django.views.generic import View
    class MyPluginView(View, QualifiesForExamPluginViewMixin):
        def post(self, request):
            try:
                self.get_plugin_input_and_authenticate()
            except PermissionDenied:
                return HttpResponseForbidden()
            # Your code to detect passing students
            passing_relatedstudentsids = [1,2,3]
            self.save_plugin_output(passing_relatedstudentsids)
            return HttpResponseRedirect(self.get_preview_url())


.. _qualifiesforexam-pluginhelpers-completeexample:

A more complete example
-----------------------

The example above is quite simple, but it can be made even simpler if you use
:meth:`.handle_save_results_and_redirect_to_preview_request` and override
:meth:`student_qualifies_for_exam`::

    from django.views.generic import View
    class MyPluginView(View, QualifiesForExamPluginViewMixin):
        def post(self, request):
            return self.handle_save_results_and_redirect_to_preview_request()

        def student_qualifies_for_exam(self, aggregated_relstudentinfo):
            # Test if the student in the AggreatedRelatedStudentInfo qualifies.
            # Typically something like this (all students must pass all assignments):
            for grouplist in aggregated_relstudentinfo.iter_groups_by_assignment():
                feedback = grouplist.get_feedback_with_most_points()
                if not feedback or not feedback.is_passing_grade:
                    return False
            return True



.. py:class:: devilry_qualifiesforexam.pluginhelpers.QualifiesForExamPluginViewMixin

    .. py:attribute:: periodid

        The ID of the period --- set by :meth:`.get_plugin_input`.

    .. py:attribute:: period

        The period object loaded using the :func:`django.shortcuts.get_object_or_404` ---
        set by :meth:`.get_plugin_input`.

    .. py:attribute:: pluginsessionid

        The pluginsessionid described in :ref:`qualifiesforexam-plugins-what` ---
        set by :meth:`.get_plugin_input`.

    .. py:method:: get_plugin_input_and_authenticate

        Reads the parameters (periodid and pluginsessionid) from
        the querystring and store them as in the following instance
        variables: :attr:`.periodid`, :attr:`.period`, :attr:`.pluginsessionid`.

        :raise: :exc:`django.core.exceptions.PermissionDenied` if the request user is not
            administrator on the period.

    .. py:method:: save_plugin_output(*args, **kwargs)

        Shortcut that saves a :class:`.PreviewData` in the session key generated
        using :func:`.create_sessionkey`. Args and kwargs are forwarded to :class:`.PreviewData`.

    .. py:method:: get_preview_url

        Get the preview URL - the URL you must redirect to after saving the output
        (:meth:`.save_plugin_output`) to proceed to the preview.

    .. py:method:: redirect_to_preview_url

        Returns a ``HttpResponseRedirect`` that redirects to :meth:`.get_preview_url`.

    .. py:method:: student_qualifies_for_exam

        Must be implemented in subclasses if you use :meth:`get_relatedstudents_that_qualify_for_exam`.
        See :ref:`qualifiesforexam-pluginhelpers-completeexample`.

        :return: Does the student qualify for exam?
        :rtype: bool

    .. py:method:: get_relatedstudents_that_qualify_for_exam

        Uses :ref:`utils_groups_groupedby_relatedstudent_and_assignment` to aggregate all data
        for all students in the period. Loops through the resulting
        :class:`~devilry.utils.groups_groupedby_relatedstudent_and_assignment.AggreatedRelatedStudentInfo`-objects
        and sends them to :meth:`.student_qualifies_for_exam`.

        :return:
            A list with the ids of all relatedstudents for which
            :meth:`.student_qualifies_for_exam` returned ``True``.

    .. py:method:: handle_save_results_and_redirect_to_preview_request

        See :ref:`qualifiesforexam-pluginhelpers-completeexample`.



Other helpers
=============

.. py:class:: devilry_qualifiesforexam.pluginhelpers.PreviewData(passing_relatedstudentids)

    Stores the output from a plugin. You should not need to use this directly. Use
    :meth:`.QualifiesForExamPluginViewMixin.save_plugin_output` instead.

    :param passing_relatedstudentids: See :attr:`.passing_relatedstudentids`.

    .. py:attribute:: passing_relatedstudentids

        List of the IDs of all :class:`devilry.apps.core.models.RelatedStudent` that
        qualifies for final exams according to the plugin that generated the data.



.. py:function:: devilry_qualifiesforexam.pluginhelpers.create_sessionkey(pluginsessionid)

    Generate the session key for the plugin output as described in
    :ref:`qualifiesforexam-plugins-what`. You should not need to use this directly. Use
    :meth:`.QualifiesForExamPluginViewMixin.get_plugin_input_and_authenticate` instead.





#######################################################
Plugins shipped with Devilry
#######################################################

``devilry_qualifiesforexam_approved``
==========================================
TODO







.. _qualifiesforexam-models:

#######################################################
Database models
#######################################################

.. py:currentmodule:: devilry_qualifiesforexam.models

.. py:class:: devilry_qualifiesforexam.models.QualifiesForFinalExamPeriodStatus

    Every time the admin updates qualifies-for-exam on a period, we save new object of this
    database model.

    This gives us a history of changes, and it makes it possible for subject/period admins
    to communicate simple information to whoever it is that is responsible for handling
    examinations.


    .. py:attribute:: period

        Database foreign key to the :class:`devilry.apps.core.models.Period` that the
        status is for.

    .. py:attribute:: status

        Database char field that accepts the following values:
    
        - ``ready`` is used to indicate the the entire period is ready for export/use.
        - ``almostready`` is used to indicate that the period is almost ready for export/use, and
          that the exceptions are explained in the :attr:`.message`.
        - ``notready`` is used to indicate that the period has no useful data yet. This is typically
          only used when the period used to be *ready* or *almostready*, but had to be retracted
          for a reason explained in the status

    .. py:attribute:: createtime

        Database datetime field where we store when we added the status.

    .. py:attribute:: message

        Database field with an optional message about the status change.

    .. py:attribute:: user

        Database foreign key to the user that made the status change.

    .. py:attribute:: plugin

        Database char field that stores the id of the plugin (see :ref:`qualifiesforexam-plugins`)
        that was used to change the status.

    .. py:attribute:: pluginsettings

        A text field where plugins can store their settings, typically in some structured
        format like JSON, XML or YAML.



.. py:class:: devilry_qualifiesforexam.models.QualifiesForFinalExam

    .. py:attribute:: relatedstudent

        Database one-to-one relation to :class:`devilry.apps.core.models.RelatedStudent`.

    .. py:attribute:: qualifies

        Boolean database field telling if the student qualifies or not.
        This may be ``None`` (``NULL``), if the status is ``almostready``,
        to mark students as not ready for export.

    .. py:attribute:: status

        Foreign key to a :class:`.QualifiesForFinalExamPeriodStatus`.