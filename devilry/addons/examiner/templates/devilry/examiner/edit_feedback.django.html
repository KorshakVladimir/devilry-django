{% extends "devilry/examiner/delivery-base.django.html" %}
{% comment %} vim: set ts=2 sts=2 et sw=2: {% endcomment %}
{% load i18n %}
{% load inlinestyles %}

{% block title %}{% trans "Feedback" %}{% endblock %}
{% block heading %}
  {% with delivery.assignment_group.get_candidates|emphasize as candidates %}
    {% with delivery.assignment_group.parentnode.long_name|emphasize as assignment %}
      {% blocktrans %}
        Feedback for {{ candidates }} on {{ assignment }}
      {% endblocktrans %}
    {% endwith %}
  {% endwith %}
{% endblock %}

{% block edit_feedback_breadcrumb %}
  <li class='current'><a href='#'>
    {{ delivery.number }}: {{ delivery.time_of_delivery|date:"DATETIME_FORMAT" }}
  </a></li>
{% endblock %}

{% block customcss %}
<style type="text/css">
  ul.deliverylist {
    list-style:none;
    padding: 0;
    margin: 0;
  }
  ul.deliverylist li {
    clear:both;
    margin: 0;
    padding: 5px 10px;
  }
  .deliveryinfo {
    margin-left: 35px;
  }
  .deliverynumber {
    float: left;
    color: #888;
    font-size: 1.8em;
  }
  .deadlineheader {
    margin-top: 25px;
    font-size: 1.2em;
  }

  ul.files-list {
    margin: 0;
    padding: 0;
    list-style: none;
  }

  #metainfo {
    float: right;
    width: 250px;
  }
  .metainfo-item {
    margin-top: 0;
    margin-bottom: 10px;
  }
  #mainframe {
    margin-right: 290px;
  }
  .mainframe-fillwidth {
    margin-right: 0 !important;
  }
  .hidden {
    display: none !important;
  }

  #metainfo .vertical_infotable {
    width: 99.9%;
  }

  dl.deliveries_by_deadline {
    margin-left: 0;
  }
  .deliveries_by_deadline dt {
  }
  .deliveries_by_deadline dd {
    padding: 0;
    margin: 0 0 0 0;
  }
  .deliveries_by_deadline ul {
    list-style:none;
    padding: 0; margin: 0;
  }

  .selected-delivery {
    font-weight: bold;
  }
  .selected-delivery .deliverynumber {
    color: #333;
  }
  .selected-delivery .deliverydate {
    color: #333;
  }
  .deliveries_by_deadline a {
  }

  .text label {
    display: none !important;
  }
  .text .form-field {
    margin-left: 0 !important;
  }


  .nocolor .status_not_corrected,
  .nocolor .status_corrected_not_published,
  .nocolor .status_corrected_and_published
  {
    color: #444 !important;
  }
</style>
{% endblock %}


{% block customjs %}
  <script type="text/javascript">
    function toggleSidebar() {
      $("#metainfo").toggleClass("hidden");
      $("#mainframe").toggleClass("mainframe-fillwidth");
      $("#show-metainfo").toggleClass("hidden");
      $("#hide-metainfo").toggleClass("hidden");
      return false;
    }
    $(function(){
        $("#show-metainfo")
          .addClass("ui-priority-secondary")
          .click(toggleSidebar)
          .button({
            icons: {primary: "ui-icon-triangle-1-w"}
          });
        $("#hide-metainfo")
          .addClass("ui-priority-secondary")
          .click(toggleSidebar)
          .button({
            icons: {primary: "ui-icon-triangle-1-e"}
          });

        $("#theform").data("initialValues", $("#theform").serialize());
        $('.checkformchanges').click(function(e) {
            if($("#theform").data("initialValues") != $("#theform").serialize()) {
              var ok = confirm("{% trans "You have unsaved changes. Are you sure you want to continue?" %}");
              if(!ok) {
                e.preventDefault();
              }
            }
          });

        $('#metainfo').hover(
          function(e) {
            $(this).removeClass("nocolor");
          },
          function(e) {
            $(this).addClass("nocolor");
          }
        );

      });
  </script>
{% endblock %}

{% block content %}

{% comment %}
{% if delivery.assignment_group.parentnode.grade_plugin == "grade_rstschema:rstschemagrade" %}
  <p class='warning-message'>There are issues with <em>Internet Explorer<em> and
  <em>Opera</em> and the grade plugin used on this assignment. We reccommend
  you use Firefox, Safari or Chrome.</p>
{% endif %}
{% endcomment %}

<div id="metainfo" class="nocolor">
  {% if after_deadline %}
    <div class="warning-message metainfo-item">
      {% blocktrans with diff_days|big as diff_days and diff_hours|big as diff_hours and diff_minutes|big as diff_minutes %}
        This delivery was made {{ diff_days }} days, {{ diff_hours }} hours
        and {{ diff_minutes }} minutes after the deadline.
      {% endblocktrans %}
    </div>
  {% endif %}

  {% if delivery.assignment_group.deliveries.count > 1 %}
    <div id="deadlinesbox" class="booring-message metainfo-item">
      <h2 class="messageheader">{% trans "Deliveries" %}</h2>
      {% include "devilry/examiner/include/deliveries_by_deadline.django.html" %}
    
	  {% if delivery.filemetas.count > 1 %}
	  {% trans "Download all deliveries:" %}
	  <a href='{% url devilry-examiner-download_group_deliveries_as_tar delivery.id %}'>
		TAR
	  </a>
	  |<a href='{% url devilry-examiner-download_group_deliveries_as_zip delivery.id %}'>
		ZIP
	  </a>
	  {% endif %}
	</div>
  {% endif %}

  <div class="booring-message metainfo-item">
    <h2 class="messageheader">{% trans "Delivery" %}</h2>
    <dl>
      <dt>{% trans "Files" %}</dt>
      <dd>
        <ul class='files-list'>
          {% for filemeta in delivery.filemetas.all %}
            <li>
              <a href='{% url devilry-ui-download_file filemeta.id %}'
                  {% if filemeta.filename|length > 25 %}
                    title="{{ filemeta.filename }}" class="tooltip-hover"
                  {% endif %}>
                {{ filemeta.filename|trunc_filename:25 }}
              </a>
              <span class='unimportant'>({{ filemeta.size|filesizeformat }})</span>
            </li>
          {% endfor %}
        </ul>
      </dd>

      <dt>{% trans "Download all files" %}</dt>
      <dd>
        {% if delivery.filemetas.count > 1 %}
          <a href='{% url devilry-examiner-download_delivery_as_tar delivery.id %}'>
          TAR
          </a>
          |<a href='{% url devilry-examiner-download_delivery_as_zip delivery.id %}'>
          ZIP
          </a>
        {% endif %}
      </dd>

      <dt style="margin-top:15px">{% trans "Time of delivery" %}</dt>
      <dd>{{ delivery.time_of_delivery|date:"DATETIME_FORMAT"}}</dd>
      {% if not delivery.assignment_group.parentnode.anonymous %}
        <dt>{% trans "Delivered by" %}</dt>
        <dd>{{ delivery.delivered_by.username }}</dd>
      {% endif %}
    </dl>
  </div>

  <div class="booring-message metainfo-item">
    <h2 class="messageheader">{% trans "Feedback" %}</h2>
    <dl>
      {% if delivery.feedback %}
        <dt>{% trans "Grade" %}</dt>
        <dd> {{ delivery.feedback.get_grade_as_short_string }} </dd>
        <dt>{% trans "Feedback last modified" %}</dt>
        <dd> {{ delivery.feedback.last_modified|date:"DATETIME_FORMAT"}} </dd>
        <dt>{% trans "Feedback last modified by" %}</dt>
        <dd> {{ delivery.feedback.last_modified_by }} </dd>
      {% endif %}
      <dt>{% trans "Status" %}</dt>
      <dd> {{ delivery|status }} </dd>
    </dl>
  </div>
</div>

<div id="mainframe">
  <div>
    <div style="float:right;">
      <a href="#" id="show-metainfo" class="hidden">
        {% trans "Show sidebar" %}
      </a>
      <a href="#" id="hide-metainfo">
        {% trans "Hide sidebar" %}
      </a>
    </div>
    <div>
      {% if next_notcorrected or prev_notcorrected %}
        {% if prev_notcorrected %}
          <a class="tooltip-hover button ui-priority-secondary checkformchanges"
              href="{% url devilry-examiner-edit-feedback prev_notcorrected.id %}"
              title="{% trans "Go to previous 'not corrected' group on this assignment without saving" %}">
            {% trans "Previous" %}</a>
        {% endif %}
        {% if next_notcorrected %}
          <a class="tooltip-hover button ui-priority-secondary checkformchanges"
              href="{% url devilry-examiner-edit-feedback next_notcorrected.id %}"
              title="{% trans "Go to next 'not corrected' group on this assignment without saving" %}">
            {% trans "Next" %}</a>
        {% endif %}
      {% else %}
        <div style="height: 30px;">&nbsp;</div>
      {% endif %}
    </div>
  </div>

{% if delivery.assignment_group.is_open %}
  {% if show_deadline_hint %}
    {% url devilry-examiner-create_deadline delivery.assignment_group.id as create_deadline_url %}
    {% url devilry-examiner-close_assignmentgroup delivery.assignment_group.id as close_group_url %}
    <p class='info-message'>
      {% blocktrans %}
        You have published a feedback, but have not given the group a new deadline. You should 
        <a href="{{ create_deadline_url }}">create a new deadline</a> or 
        <a href="{{ close_group_url }}">close for more deliveries</a> 
        if the group doesn't need to submit a new delivery. 
        Closing the group leave the students on this group unable to add
        more deliveries, and make the grade on the latest delivery the final grade
      {% endblocktrans %}
    </p>
  {% endif %}
  {% else %}
    {% url devilry-examiner-open_assignmentgroup delivery.assignment_group.id as open_group_url %}
    <p class='info-message'>
    {% blocktrans %}
        This group is closed for deliveries. <a href="{{ open_group_url }}">Open the group</a> 
        to allow students to add new deliveries. 
		{% endblocktrans %}
  </p>
{% endif %}

  <form method='post' id="theform"
      action='{% url devilry-examiner-edit-feedback delivery.id %}'>
    {% block formfields %}
      {% block gradeformfieldset %}
        <fieldset class='stdfieldset'>
          <h2 class='legend'>{% trans "Grade" %}</h2>
          {% block gradeform %}
            {% with grade_form as form %}
              {% include "devilry/ui/include/form-list.django.html" %}
            {% endwith %}
          {% endblock %}
        </fieldset>
      {% endblock %}

      {% with feedback_form as form %}
        <fieldset class='stdfieldset'>
          <h2 class='legend'>{% trans "Feedback" %}</h2>
          <div class='help-box'>
            {% with "http://docutils.sourceforge.net/docs/user/rst/quickref.html" as docurl %}
              <p>{% blocktrans %}
                Feedback text should be formatted using <em>ReStructured Text</em>
                (a simple markup language). Use the buttons above the text
                area for the most common markup, and read <a href="{{ docurl }}">the
                documentation</a> if you need more advanced markup. The rightmost
                button above the text-area provides you with a preview.
              {% endblocktrans %}</p>
            {% endwith %}
          </div>
          {% include "devilry/ui/include/form-list.django.html" %}
        </fieldset>
      {% endwith %}
    {% endblock formfields %}
    
    <div class='button-row'>
      <input type='submit' name='save'
        class='button default ui-priority-primary tooltip-hover'
        title="{% trans "Save and reload this page. Use this to save when making long feedbacks." %}"
        value='{% trans "Save" %}'/>
    </div>
  </form>
</div>

{% endblock content %}
