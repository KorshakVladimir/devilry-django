<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='devilry-extjshelpers-RestfulSimplifiedEditPanel'>/** Apanel for editing RestfulSimplified models. */
</span>Ext.define('devilry.extjshelpers.RestfulSimplifiedEditPanel', {
    extend: 'Ext.panel.Panel',
    alias: 'widget.restfulsimplified_editpanel',
    requires: ['devilry.extjshelpers.RestSubmit'],

    config: {
<span id='devilry-extjshelpers-RestfulSimplifiedEditPanel-cfg-modelname'>        /**
</span>         * @cfg
         * The name of the ``Ext.data.Model`` to present in the body. (Required).
         */
        modelname: undefined,

<span id='devilry-extjshelpers-RestfulSimplifiedEditPanel-cfg-foreignkeyfieldnames'>        /**
</span>         * @cfg
         * List of foreign key field names in the model. (Required).
         */
        foreignkeyfieldnames: undefined,

<span id='devilry-extjshelpers-RestfulSimplifiedEditPanel-cfg-record'>        /**
</span>         * @cfg
         * A instance of the ``Ext.data.Model`` which should be loaded into the
         * form.
         */
        record: undefined,

<span id='devilry-extjshelpers-RestfulSimplifiedEditPanel-cfg-extrabaronbottom'>        /**
</span>         * @cfg
         * Show the extra-bar (sidebar) at the bottom? Defaults to ``false``,
         * which means that it will be at the right hand side. This bar contains
         * help and error messages.
         */
        extrabaronbottom: false
    },
    cls: 'editform',
    bodyCls: 'editform-body',

    constructor: function(config) {
        this.initConfig(config);
        this.callParent([config]);
    },

    initComponent: function() {
        this.errorlist = Ext.create('devilry.extjshelpers.ErrorList');
        this.model = Ext.ModelManager.getModel(this.model);

        this.editform.frame = false;
        if(this.editform.flex == undefined) {
            this.editform.flex = 15;
        }
        this.editform.border = 0;

        var extrabarCssCls = this.extrabaronbottom? 'extrabaronbottom': 'extrabaronright';
        Ext.apply(this, {
            layout: {
                type: (this.extrabaronbottom? 'vbox': 'hbox'),
                align: 'stretch'
            },

            items: [this.editform, {
                xtype: 'panel',
                frame: false,
                border: false,
                bodyCls: 'editform-sidebar ' + extrabarCssCls,
                flex: 5,
                items: [this.errorlist, {
                    xtype: 'box',
                    html: this.parseHelp()
                }]
            }]
        });
        this.dockedItems = [{
            xtype: 'toolbar',
            dock: 'bottom',
            ui: 'footer',
            defaults: {minWidth: 75},

            items: ['-&gt;', {
                xtype: 'button',
                text: 'Save',
                scale: 'large',
                iconCls: 'icon-save-32',
                listeners: {
                    scope: this,
                    click: this.onSave
                }
            }]
        }];
        this.callParent(arguments);

        if(this.record) {
            this.loadRecord();
        }
    },

    parseHelp: function() {
        if(!this.editform.help) {
            return '';
        }
        var help = '&lt;section class=&quot;helpsection&quot;&gt;';
        var me = this;
        var state = this.record == undefined? 'new': 'existing';
        Ext.Array.each(this.editform.help, function(helpobj) {
            if(Ext.typeOf(helpobj) === 'string') {
                helpobj = {text: helpobj};
            }
            if(helpobj.state == undefined || (helpobj.state == state)) {
                help += Ext.String.format('&lt;p&gt;{0}&lt;/p&gt;', helpobj.text);
            }
        });
        return help + '&lt;/section&gt;';
    },

    onSave: function() {
        this.errorlist.clearErrors();
        this.beforeSave();
    },

    beforeSave: function() {
        this.doSave();
    },

    doSave: function() {
        var me = this;
        this.editform.getForm().doAction('devilryrestsubmit', {
            submitEmptyText: true,
            waitMsg: 'Saving item...',
            model: this.model,
            success: function(form, action) {
                me.onSaveSuccess(form, action);
            },
            failure: function(form, action) {
                me.onSaveFailure(form, action);
            }
        });
    },

    onSaveSuccess: function(form, action) {
        var record = action.record;        
        this.fireEvent('saveSucess', record);
    },

    onSaveFailure: function(record, action) {
        var errormessages = action.operation.responseData.items.errormessages;
        var me = this;
        Ext.each(errormessages, function(errormessage) {
            me.errorlist.addError(errormessage);
        });
    },

    loadRecord: function() {
        this.editform.loadRecord(this.record);
    }
});
</pre>
</body>
</html>
