<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">
<span id='devilry-extjshelpers-assignmentgroup-DeliveryInfo'>/**
</span> * Panel to show Delivery info.
 */
Ext.define('devilry.extjshelpers.assignmentgroup.DeliveryInfo', {
    extend: 'Ext.panel.Panel',
    alias: 'widget.deliveryinfo',
    cls: 'widget-deliveryinfo',
    html: '',
    requires: [
        'devilry.extjshelpers.assignmentgroup.FileMetaBrowserPanel'
    ],

    //width: 500,
    //style: {border: 'none'},

    config: {
<span id='devilry-extjshelpers-assignmentgroup-DeliveryInfo-cfg-filemetastore'>        /**
</span>         * @cfg
         * FileMeta ``Ext.data.Store``. (Required).
         * _Note_ that ``filemetastore.proxy.extraParams`` is changed by this
         * class.
         */
        filemetastore: undefined,

<span id='devilry-extjshelpers-assignmentgroup-DeliveryInfo-cfg-delivery_recordcontainer'>        /**
</span>         * @cfg
         * A {@link devilry.extjshelpers.SingleRecordContainer} for Delivery.
         */
        delivery_recordcontainer: undefined,

<span id='devilry-extjshelpers-assignmentgroup-DeliveryInfo-cfg-deliverymodel'>        /**
</span>         * @cfg
         * Delivery ``Ext.data.Model``.
         */
        deliverymodel: undefined,

<span id='devilry-extjshelpers-assignmentgroup-DeliveryInfo-cfg-assignmentgroup_recordcontainer'>        /**
</span>         * @cfg
         * A {@link devilry.extjshelpers.SingleRecordContainer} for AssignmentGroup.
         */
        assignmentgroup_recordcontainer: undefined
    },

    tpl: Ext.create('Ext.XTemplate',
        '&lt;tpl if=&quot;time_of_delivery&quot;&gt;', // If time_of_delivery is false, the record is not loaded yet
        '    &lt;tpl if=&quot;time_of_delivery &amp;gt; deadline__deadline&quot;&gt;',
        '        &lt;div class=&quot;section warning-small&quot;&gt;',
        '           &lt;h1&gt;After deadline&lt;/h1&gt;',
        '           &lt;p&gt;This delivery was made &lt;strong&gt;after&lt;/strong&gt; the deadline (&lt;em&gt;{deadline__deadline:date}&lt;/em&gt;).&lt;/p&gt;',
        '        &lt;/div&gt;',
        '    &lt;/tpl&gt;',
        '    &lt;tpl if=&quot;!islatestDelivery&quot;&gt;',
        '        &lt;div class=&quot;section warning-small&quot;&gt;',
        '           &lt;h1&gt;Not the latest delivery&lt;/h1&gt;',
        '           &lt;p&gt;',
        '               One or more deliveries has been made &lt;strong&gt;after&lt;/strong&gt; the one you are currently viewing. &lt;em&gt;Normally&lt;/em&gt; the latest delivery is corrected.',
        '               &lt;tpl if=&quot;time_of_delivery &amp;gt; deadline__deadline&quot;&gt;',
        '                   However since this delivery was made after the deadline, an earlier delivery may be corrected instead.',
        '               &lt;/tpl&gt;',
        '               Choose &lt;span class=&quot;menuref&quot;&gt;Other deliveries&lt;/span&gt; in the toolbar to view other deliveries.',
        '           &lt;/p&gt;',
        '        &lt;/div&gt;',
        '    &lt;/tpl&gt;',
        '    &lt;div class=&quot;section info-small&quot;&gt;',
        '       &lt;h1&gt;Delivery number {number}&lt;/h1&gt;',
        '       &lt;p&gt;This delivery was made &lt;em&gt;{time_of_delivery:date}&lt;/em&gt;. Choose &lt;span class=&quot;menuref&quot;&gt;Browse files&lt;/span&gt; in the toolbar to download the delivered files.&lt;/p&gt;',
        '    &lt;/div&gt;',
        '&lt;/tpl&gt;'
    ),

    initComponent: function() {
        this.toolbar = Ext.widget('toolbar', {
            xtype: 'toolbar',
            dock: 'top',
            items: []
        });
        
        Ext.apply(this, {
            hidden: true,
            dockedItems: [this.toolbar]
        });
        this.callParent(arguments);

        this.deliverystore = this.createDeliveryStore();

        if(this.assignmentgroup_recordcontainer.record) {
            this.loadDeliveryStore();
        }
        this.assignmentgroup_recordcontainer.addListener('setRecord', this.loadDeliveryStore, this);

        if(this.delivery_recordcontainer.record) {
            this.onLoadDelivery();
        }
        this.delivery_recordcontainer.addListener('setRecord', this.onLoadSomething, this);
    },

<span id='devilry-extjshelpers-assignmentgroup-DeliveryInfo-method-onLoadSomething'>    /**
</span>     * @private
     */
    onLoadSomething: function() {
        if(this.delivery_recordcontainer.record &amp;&amp; this.deliverystoreLoaded) {
            this.onLoadingComplete();
        }
    },

<span id='devilry-extjshelpers-assignmentgroup-DeliveryInfo-method-loadDeliveryStore'>    /**
</span>     * @private
     * Reload all deliveries on this assignmentgroup.
     * */
    loadDeliveryStore: function() {
        //this.deliverystore.pageSize = 3;
        this.deliverystore.proxy.extraParams.filters = Ext.JSON.encode([{
            field: 'deadline__assignment_group',
            comp: 'exact',
            value: this.assignmentgroup_recordcontainer.record.data.id
        }]);
        this.deliverystore.load({
            scope: this,
            callback: function(records, op, success) {
                if(success) {
                    this.deliverystoreLoaded = true;
                    this.fireEvent('deliveriesLoaded', this.deliverystore);
                    this.onLoadSomething(records);
                } else {
                    throw &quot;Failed to load delivery store.&quot;;
                }
            }
        });
    },

<span id='devilry-extjshelpers-assignmentgroup-DeliveryInfo-method-onLoadingComplete'>    /**
</span>     * @private
     */
    onLoadingComplete: function() {
        var delivery = this.delivery_recordcontainer.record.data;
        var islatestDelivery = this.deliverystore.currentPage == 1 &amp;&amp; this.deliverystore.data.items[0].data.id == delivery.id;

        this.show();
        this.toolbar.removeAll();

        var data = {
            islatestDelivery: islatestDelivery
        };
        Ext.apply(data, delivery);
        this.update(data);

        this.toolbar.add({
            xtype: 'button',
            text: 'Browse files',
            id: 'tooltip-browse-files',
            scale: 'large',
            listeners: {
                scope: this,
                click: this.showFileMetaBrowserWindow,
                render: function() {
                    //Ext.create('devilry.extjshelpers.tooltips.assignmentgroup.BrowseFiles', {});
                }
            }
        });

        this.toolbar.add({
            xtype: 'button',
            id: 'tooltip-other-deliveries',
            text: 'Other deliveries',
            scale: 'large',
            listeners: {
                scope: this,
                click: this.onOtherDeliveries
            }
        });
    },

<span id='devilry-extjshelpers-assignmentgroup-DeliveryInfo-method-createDeliveryStore'>    /**
</span>     * @private
     * */
    createDeliveryStore: function() {
        var deliverystore = Ext.create('Ext.data.Store', {
            model: this.deliverymodel,
            remoteFilter: true,
            remoteSort: true,
            autoSync: true,
            groupField: 'deadline__deadline'
        });

        deliverystore.proxy.extraParams.orderby = Ext.JSON.encode(['-deadline__deadline', '-number']);
        return deliverystore;
    },

<span id='devilry-extjshelpers-assignmentgroup-DeliveryInfo-method-onOtherDeliveries'>    /**
</span>     * @private
     */
    onOtherDeliveries: function(button, notClosable) {
        var deliveriesWindow = Ext.create('Ext.window.Window', {
            title: 'Deliveries by this group',
            height: 500,
            width: 750,
            modal: true,
            layout: 'fit',
            closeAction: 'hide',
            //closable: button != undefined,
            items: {
                xtype: 'deliveriesonsinglegrouplisting',
                store: this.deliverystore,
                delivery_recordcontainer: this.delivery_recordcontainer
            }
        });
        deliveriesWindow.show();
    },

<span id='devilry-extjshelpers-assignmentgroup-DeliveryInfo-method-showFileMetaBrowserWindow'>    /**
</span>     * @private
     */
    showFileMetaBrowserWindow: function(button) {
        var fileBrowser = Ext.create('Ext.window.Window', {
            title: 'Files',
            height: 400,
            width: 500,
            modal: true,
            //animateTarget: button,
            layout: 'fit',
            items: [{
                xtype: 'filemetabrowserpanel',
                border: false,
                filemetastore: this.filemetastore,
                deliveryid: this.delivery_recordcontainer.record.data.id
            }]
        });
        fileBrowser.show();
    }
});
</pre>
</body>
</html>
