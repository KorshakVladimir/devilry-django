<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">Ext.define('devilry.extjshelpers.assignmentgroup.AssignmentGroupInfo', {
    extend: 'Ext.panel.Panel',
    alias: 'widget.assignmentgroupinfo',
    cls: 'widget-assignmentgroupinfo',

    requires: [
        'devilry.extjshelpers.assignmentgroup.AssignmentGroupTodoList',
        'devilry.extjshelpers.assignmentgroup.DeliveriesOnSingleGroupListing',
        'devilry.extjshelpers.assignmentgroup.DeadlinesOnSingleGroupListing',
        'devilry.extjshelpers.assignmentgroup.AssignmentGroupDetails'
    ],

    config: {
<span id='global-cfg-canExamine'>        /**
</span>         * @cfg
         * Enable creation of new feedbacks? Defaults to ``false``.
         * See: {@link devilry.extjshelpers.assignmentgroup.DeliveryInfo#canExamine}.
         *
         * When this is ``true``, the authenticated user still needs to have
         * permission to POST new feedbacks for the view to work.
         */
        canExamine: false,

        assignmentgroup_recordcontainer: undefined,
        delivery_recordcontainer: undefined,
        assignmentgroupstore: undefined,
        deliverymodel: undefined,
        deadlinemodel: undefined
    },

    constructor: function(config) {
        this.initConfig(config);
        this.callParent([config]);
    },


    initComponent: function() {
        var tbarItems = [{
            xtype: 'button',
            menu: [], // To get an arrow
            id: 'tooltip-deliveries',
            text: 'Deadlines',
            scale: 'large',
            enableToggle: true,
            listeners: {
                scope: this,
                click: this.onDeadlines
            }
        }];
        
        if(this.canExamine) {
            var onUncorrectedGroupsBtn = Ext.ComponentManager.create({
                xtype: 'button',
                menu: [], // To get an arrow
                id: 'tooltip-uncorrected-groups',
                text: 'To-do',
                scale: 'large',
                enableToggle: true,
                listeners: {
                    scope: this,
                    click: this.onUncorrectedGroups
                }
            });
            Ext.Array.insert(tbarItems, 0, [onUncorrectedGroupsBtn]);

            this.closeopenbtn = Ext.ComponentManager.create({
                xtype: 'button',
                menu: [], // To get an arrow
                text: '',
                scale: 'large',
                enableToggle: true,
                listeners: {
                    scope: this,
                    click: this.onCloseOrOpenGroup
                }
            });
            Ext.Array.insert(tbarItems, 3, [this.closeopenbtn]);

            if(this.assignmentgroup_recordcontainer.record) {
                this.onSetAssignmentGroup();
            }
            this.assignmentgroup_recordcontainer.addListener('setRecord', this.onSetAssignmentGroup, this);
        }

        Ext.apply(this, {
            tbar: tbarItems,
            items: [{
                xtype: 'assignmentgroupdetails',
                extradata: {
                    canExamine: this.canExamine
                },
                singlerecordontainer: this.assignmentgroup_recordcontainer
            }]
        });

        this.callParent(arguments);
    },


<span id='global-method-onSetAssignmentGroup'>    /**
</span>     * @private
     */
    onSetAssignmentGroup: function() {
        this.closeopenbtn.setText(this.assignmentgroup_recordcontainer.record.data.is_open? 'Close group': 'Open group');
    },

<span id='global-method-onUncorrectedGroups'>    /**
</span>     * @private
     */
    onUncorrectedGroups: function(button) {
        var groupsWindow = Ext.create('Ext.window.Window', {
            title: 'To-do list (Open groups on this assignment)',
            height: 340,
            width: 400,
            modal: true,
            layout: 'fit',
            items: {
                xtype: 'assignmentgrouptodolist',
                assignmentgroup_recordcontainer: this.assignmentgroup_recordcontainer,
                store: this.assignmentgroupstore
            },
            listeners: {
                scope: this,
                close: function() {
                    button.toggle(false);
                }
            }
        });
        groupsWindow.show();
        groupsWindow.alignTo(button, 'bl', [0, 0]);
    },

<span id='global-method-onCloseOrOpenGroup'>    /**
</span>     * @private
     */
    onCloseOrOpenGroup: function(button) {
        if(this.assignmentgroup_recordcontainer.record.data.is_open) {
            this.onCloseGroup(button);
        } else {
            this.onOpenGroup(button);
        }
    },

<span id='global-method-onOpenGroup'>    /**
</span>     * @private
     */
    onOpenGroup: function(button) {
        var win = Ext.MessageBox.show({
            title: 'Are you sure you want to open this group?',
            msg: '&lt;p&gt;This will &lt;strong&gt;allow&lt;/strong&gt; students to add more deliveries. ' +
                'Normally Devilry will close groups automatically when:&lt;/p&gt;'+
                '&lt;ul&gt;' +
                '   &lt;li&gt;you have given a passing grade.&lt;/li&gt;' +
                '   &lt;li&gt;students have failed to get a passing grade more than the configured maximum number of times.&lt;/li&gt;' +
                '&lt;/ul&gt;' +
                '&lt;p&gt;And you normally do not open it again unless you want students to add a new delivery.&lt;/p&gt;',
            buttons: Ext.Msg.YESNO,
            scope: this,
            closable: false,
            fn: function(buttonId) {
                if(buttonId == 'yes') {
                    this.assignmentgroup_recordcontainer.record.data.is_open = true;
                    this.assignmentgroup_recordcontainer.record.save({
                        scope: this,
                        success: function(record) {
                            this.assignmentgroup_recordcontainer.fireSetRecordEvent();
                        },
                        failure: function() {
                            throw &quot;Failed to open group.&quot;
                        }
                    });
                }
                button.toggle(false);
            }
        });
        win.alignTo(button, 'bl', [0, 0]);
    },

<span id='global-method-onCloseGroup'>    /**
</span>     * @private
     */
    onCloseGroup: function(button) {
        var win = Ext.MessageBox.show({
            title: 'Are you sure you want to close this group?',
            msg: '&lt;p&gt;This will &lt;strong&gt;prevent&lt;/strong&gt; students from adding more deliveries. ' +
                'Normally Devilry will close groups automatically when:&lt;/p&gt;'+
                '&lt;ul&gt;' +
                '   &lt;li&gt;you have given a passing grade.&lt;/li&gt;' +
                '   &lt;li&gt;students have failed to get a passing grade more than the configured maximum number of times.&lt;/li&gt;' +
                '&lt;/ul&gt;' +
                '&lt;p&gt;However you may have to close a group manually if no maximum number of tries have been configured, or if you want the current feedback to be stored as the final feedback for this group.&lt;/p&gt;',
            buttons: Ext.Msg.YESNO,
            scope: this,
            closable: false,
            fn: function(buttonId) {
                if(buttonId == 'yes') {
                    this.assignmentgroup_recordcontainer.record.data.is_open = false;
                    this.assignmentgroup_recordcontainer.record.save({
                        scope: this,
                        success: function(record) {
                            this.assignmentgroup_recordcontainer.fireSetRecordEvent();
                        },
                        failure: function() {
                            throw &quot;Failed to close group.&quot;
                        }
                    });
                }
                button.toggle(false);
            }
        });
        win.alignTo(button, 'bl', [0, 0]);
    },

<span id='global-method-onDeadlines'>    /**
</span>     * @private
     */
    onDeadlines: function(button) {
        var deadlinesWindow = Ext.create('Ext.window.Window', {
            title: 'Deadlines for this group',
            width: 600,
            height: 400,
            modal: true,
            layout: 'fit',
            closeAction: 'hide',
            items: {
                xtype: 'deadlinesonsinglegrouplisting',
                assignmentgroup_recordcontainer: this.assignmentgroup_recordcontainer,
                delivery_recordcontainer: this.delivery_recordcontainer,
                deliverymodel: this.deliverymodel,
                deadlinemodel: this.deadlinemodel,
                enableDeadlineCreation: this.canExamine
            },
            listeners: {
                scope: this,
                close: function() {
                    button.toggle(false);
                }
            }
        });
        deadlinesWindow.show();
        deadlinesWindow.alignTo(button, 'bl', [0, 0]);
    }
});
</pre>
</body>
</html>
