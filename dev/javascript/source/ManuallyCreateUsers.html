<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">Ext.define('devilry.administrator.studentsmanager.ManuallyCreateUsers', {
    extend: 'Ext.panel.Panel',
    alias: 'widget.manuallycreateusers',
    frame: false,
    border: false,

    layout: {
        type: 'vbox',
        align: 'stretch' // Child items are stretched to full width
    },

    config: {
<span id='global-cfg-initialLines'>        /**
</span>         * @cfg
         * Lines to fill in on load (one line for each element in the array).
         */
        initialLines: undefined,

        assignmentid: undefined,
        deadlinemodel: undefined,
        suggestedDeadline: undefined
    },

    helptext:
        '&lt;div class=&quot;section helpsection&quot;&gt;' +
        //'   &lt;h1&gt;Help&lt;/h1&gt;' +
        '   &lt;p&gt;Students are organized in &lt;em&gt;assignment groups&lt;/em&gt;. You should specify &lt;strong&gt;one&lt;/strong&gt; &lt;em&gt;assignment group&lt;/em&gt; on each line in the input box.&lt;/p&gt;' +
        '   &lt;h2&gt;Common usage examples&lt;/h2&gt;' +
        '   &lt;h3&gt;Individual deliveries&lt;/h3&gt;' +
        '   &lt;p&gt;Very often, an assignment requires &lt;strong&gt;individual&lt;/strong&gt; deliveries and feedback. In this case, each &lt;em&gt;assignment group&lt;/em&gt; should contain a single student. In this case, the input box should contain something similar to this:&lt;/p&gt;' +
        '   &lt;pre style=&quot;margin-left:30px; border: 1px solid #999; padding: 5px;&quot;&gt;bob\nalice\neve\ndave&lt;/pre&gt;' +

        '   &lt;h3&gt;Group deliveries&lt;/h3&gt;' +
        '   &lt;p&gt;When students are supposed to &lt;strong&gt;cooperate&lt;/strong&gt; on the same assignment, they should be in the same &lt;em&gt;assignment group&lt;/em&gt;. In this case, the input box should contain something similar to this:&lt;/p&gt;' +
        '   &lt;pre style=&quot;margin-left:30px; border: 1px solid #999; padding: 5px;&quot;&gt;bob, alice\neve, dave, charlie&lt;/pre&gt;' +

        '   &lt;h3&gt;Anonymous assignments&lt;/h3&gt;' +
        '   &lt;p&gt;When you have specified the the assignment is anonymous, you may want to give each student a &lt;em&gt;candidate-id&lt;/em&gt; that the examiners will see instead of the username. Specify candidate-id with a colon at the end of each username like this:&lt;/p&gt;' +
        '   &lt;pre style=&quot;margin-left:30px; border: 1px solid #999; padding: 5px;&quot;&gt;bob:10, alice:232\ncharlie:4X23&lt;/pre&gt;' +

        '   &lt;h3&gt;Project groups and group naming&lt;/h3&gt;' +
        '   &lt;p&gt;It is often useful to give an &lt;em&gt;assignment group&lt;/em&gt; a &lt;strong&gt;name&lt;/strong&gt;. The name is primarily intended for project assignments, where it is useful to name a group after their project. However, the name can be used for other purposes, such as &lt;em&gt;tagging&lt;/em&gt; of groups of special interest. Since you can search for groups by name, you can name multiple groups with tags, such as &lt;em&gt;exceptional&lt;/em&gt;, and find these groups using the search field. You specify group name like this:&lt;/p&gt;' +
        '   &lt;pre style=&quot;margin-left:30px; border: 1px solid #999; padding: 5px;&quot;&gt;Secret project:: bob, alice\nTake over world:: eve, dave, charlie&lt;/pre&gt;' +

        '   &lt;h2&gt;Input format explained in detail&lt;/h2&gt;' +
        '   &lt;p&gt;The format used to create the assignment groups is:&lt;/p&gt;' +
        '   &lt;ul&gt;' +
        '       &lt;li&gt;One assignment group on each line.&lt;/li&gt;' +
        '       &lt;li&gt;Each username is separated by a comma.&lt;/li&gt;' +
        '       &lt;li&gt;Group name is identified by two colons at the end of the name, and must be placed at the beginning of the line.&lt;/li&gt;' +
        '       &lt;li&gt;A group name or at least one username is required for each group.&lt;/li&gt;' +
        '       &lt;li&gt;An optional &lt;em&gt;candidate-id&lt;/em&gt; for a candidate is denoted by a colon and the &lt;em&gt;candidate-id&lt;/em&gt; after the username.&lt;/li&gt;' +
        '       &lt;li&gt;A an optional comma-separated list of tags surrounded by parentheses.&lt;/li&gt;' +
        '   &lt;/ul&gt;' +
        '&lt;/div&gt;',

    constructor: function(config) {
        this.initConfig(config);
        this.callParent([config]);
    },

    initComponent: function() {
        this.assignmentGroupModelCls = 'devilry.apps.administrator.simplified.SimplifiedAssignmentGroup';

        var currentValue = &quot;&quot;;
        if(this.initialLines) {
            Ext.each(this.initialLines, function(line, index) {
                currentValue += Ext.String.format('{0}\n', line);
            });
        };

        this.userinput = Ext.widget('textareafield', {
            //hideLabel: true,
            fieldLabel: 'Assignment groups',
            labelAlign: 'top',
            labelWidth: 100,
            labelStyle: 'font-weight:bold',
            emptyText: 'Read the text on your right hand side for help...',
            flex: 10, // Take up all remaining vertical space
            margin: 10,
            value: currentValue
        });
        //this.userinput.setValue('dewey\nlouie:401, hue\n\nSaker azz:: donald, dela:30');
        //this.userinput.setValue('dewey\nlouie:401');
        Ext.apply(this, {
            //items: this.userinput,

            layout: {
                type: 'hbox',
                align: 'stretch'
            },

            items: [this.userinput, {
                flex: 10,
                xtype: 'box',
                padding: 20,
                autoScroll: true,
                html: this.helptext
            }],

            dockedItems: [{
                xtype: 'toolbar',
                dock: 'bottom',
                ui: 'footer',
                items: ['-&gt;', {
                    xtype: 'button',
                    iconCls: 'icon-next-32',
                    scale: 'large',
                    text: 'Select deadline',
                    listeners: {
                        scope: this,
                        click: this.onCreate
                    }
                }]
            }]
        });
        this.callParent(arguments);
    },

<span id='global-method-parseGroupSpec'>    /**
</span>     * @private
     */
    parseGroupSpec: function(groupSpec) {
        groupSpec = Ext.String.trim(groupSpec);
        if(groupSpec == &quot;&quot;) {
            return null;
        }
        groupSpecObj = {
            name: null,
            is_open: true,
            fake_candidates: [],
            fake_examiners: [],
            fake_tags: []
        };

        var nameSplit = groupSpec.split(/\s*::\s*/);
        if(nameSplit.length &gt; 1) {
            groupSpecObj.name = nameSplit[0];
            groupSpec = nameSplit[1];
        }

        var usernamesAndTags = this.statics().parseUsernamesAndTags(groupSpec);
        groupSpecObj.fake_tags = usernamesAndTags.tags;

        Ext.Array.each(usernamesAndTags.usernames, function(candidateSpec) {
            groupSpecObj.fake_candidates.push(devilry.administrator.studentsmanager.StudentsManagerManageGroups.parseCandidateSpec(candidateSpec));
        }, this);
        return groupSpecObj;
    },

<span id='global-method-parseTextToGroupSpec'>    /**
</span>     * @private
     */
    parseTextToGroupSpec: function(rawValue) {
        var asArray = rawValue.split('\n');
        var resultArray = [];
        var me = this;
        Ext.Array.each(asArray, function(groupSpec) {
            var groupSpecObj = me.parseGroupSpec(groupSpec);
            if(groupSpecObj != null) {
                resultArray.push(groupSpecObj);
            }
        });
        return resultArray;
    },

<span id='global-method-createAll'>    /**
</span>     * @private
     */
    createAll: function(parsedArray) {
        this.getEl().mask(Ext.String.format('Saving {0} groups', parsedArray.length));
        this.finishedCounter = 0;
        this.unsuccessful = [];
        this.parsedArray = parsedArray;
        Ext.Array.each(parsedArray, function(groupSpecObj) {
            this.createGroup(groupSpecObj);
        }, this);
    },

<span id='global-method-createGroup'>    /**
</span>     * @private
     */
    createGroup: function(groupSpecObj) {
        var completeGroupSpecObj = {
            parentnode: this.assignmentid
        };
        Ext.apply(completeGroupSpecObj, groupSpecObj);
        var group = Ext.create(this.assignmentGroupModelCls, completeGroupSpecObj);
        group.save({
            scope: this,
            success: this.createDeadline,
            failure: function() {
                this.finishedCounter ++;
                this.unsuccessful.push(groupSpecObj);
                this.getEl().mask(
                    Ext.String.format('Finished saving {0}/{1} groups',
                        this.finishedCounter, this.parsedArray.length, this.parsedArray.length
                    )
                );
                if(this.finishedCounter == this.parsedArray.length) {
                    this.onFinishedSavingAll();
                }
            }
        });
    },

<span id='global-method-createDeadline'>    /**
</span>     * @private
     */
    createDeadline: function(assignmentGroupRecord) {
        devilry.extjshelpers.studentsmanager.StudentsManagerManageDeadlines.createDeadline(
            assignmentGroupRecord, this.deadlineRecord, this.deadlinemodel, {
                scope: this,
                failure: function() {
                    console.error('Failed to save deadline record');
                },
                success: this.onCreateDeadlineSuccess
            }
        );
    },

<span id='global-method-onCreateDeadlineSuccess'>    /**
</span>     * @private
     */
    onCreateDeadlineSuccess: function(record) {
        this.finishedCounter ++;
        this.getEl().mask(Ext.String.format('Finished saving {0}/{1} groups',
            this.finishedCounter, this.parsedArray.length,
            this.parsedArray.length
        ));
        if(this.finishedCounter == this.parsedArray.length) {
            this.onFinishedSavingAll();
        }
    },

<span id='global-method-groupSpecObjToString'>    /**
</span>     * @private
     */
    groupSpecObjToString: function(groupSpecObj) {
        var groupSpecStr = &quot;&quot;;
        if(groupSpecObj.name) {
            groupSpecStr += groupSpecObj.name + &quot;:: &quot;;
        }
        Ext.Array.each(groupSpecObj.fake_candidates, function(candidate, index) {
            groupSpecStr += candidate.username;
            if(candidate.candidate_id) {
                groupSpecStr += ':' + candidate.candidate_id;
            }
            if(index != groupSpecObj.fake_candidates.length-1) {
                groupSpecStr += ', ';
            }
        }, this);
        return groupSpecStr;
    },

<span id='global-method-groupSpecObjArrayToString'>    /**
</span>     * @private
     */
    groupSpecObjArrayToString: function(groupSpecObjArray) {
        var str = &quot;&quot;;
        Ext.Array.each(groupSpecObjArray, function(groupSpecObj) {
            str += this.groupSpecObjToString(groupSpecObj) + '\n';
        }, this);
        return str;
    },

<span id='global-method-onFinishedSavingAll'>    /**
</span>     * @private
     */
    onFinishedSavingAll: function() {
        this.getEl().unmask();
        if(this.unsuccessful.length == 0) {
            this.onSuccess();
        } else {
            this.onFailure();
        }
    },

<span id='global-method-onSuccess'>    /**
</span>     * @private
     */
    onSuccess: function() {
        var me = this;
        Ext.MessageBox.show({
            title: 'Success',
            msg: Ext.String.format('Created {0} assignment groups.', this.finishedCounter),
            buttons: Ext.Msg.OK,
            icon: Ext.Msg.INFO,
            fn: function() {
                me.userinput.setValue('');
                me.up('window').close();
            }
        });
    },

<span id='global-method-onFailure'>    /**
</span>     * @private
     */
    onFailure: function() {
        this.userinput.setValue(this.groupSpecObjArrayToString(this.unsuccessful));
        Ext.MessageBox.show({
            title: 'Error',
            msg: Ext.String.format(
                'Failed to create {0} of {1} assignment groups. This is usually caused by invalid usernames. The groups with errors have been re-added to the input box.',
                this.unsuccessful.length, this.finishedCounter),
            buttons: Ext.Msg.OK,
            icon: Ext.Msg.ERROR
        });
    },

<span id='global-method-onCreate'>    /**
</span>     * @private
     */
    onCreate: function() {
        this.getEl().mask('Parsing input');
        var parsedArray = this.parseTextToGroupSpec(this.userinput.getValue());
        this.getEl().unmask();
        this.selectDeadline(parsedArray);
    },

<span id='global-method-selectDeadline'>    /**
</span>     * @private
     */
    selectDeadline: function(parsedArray) {
        var me = this;
        var createDeadlineWindow = Ext.widget('multicreatenewdeadlinewindow', {
            width: this.up('window').getWidth(),
            height: this.up('window').getHeight(),
            deadlinemodel: this.deadlinemodel,
            suggestedDeadline: this.suggestedDeadline,
            deadlineRecord: this.deadlineRecord,
            onSaveSuccess: function(record) {
                this.close();
                me.deadlineRecord = record;
                me.createAll(parsedArray);
            }
        });
        createDeadlineWindow.show();
    },


    statics: {
        parseUsernamesAndTags: function(rawstr) {
            var tags = [];
            var tagSplit = rawstr.split(/\s*\(\s*/);
            if(tagSplit.length &gt; 1) {
                rawstr = tagSplit[0];
                var tagsString = tagSplit[1];
                tagsString = tagsString.replace(/\)/, &quot;&quot;);
                tags = tagsString.split(/\s*,\s*/);
            }
            return {
                usernames: rawstr.split(/\s*,\s*/),
                tags: tags
            };
        }
    },
});
</pre>
</body>
</html>
