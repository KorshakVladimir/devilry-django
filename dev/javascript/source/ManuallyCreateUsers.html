<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">Ext.define('devilry.administrator.studentsmanager.ManuallyCreateUsers', {
    extend: 'Ext.panel.Panel',
    alias: 'widget.manuallycreateusers',
    frame: false,
    border: false,

    requires: [
        'devilry.extjshelpers.AsyncActionPool'
    ],

    layout: {
        type: 'vbox',
        align: 'stretch' // Child items are stretched to full width
    },

    config: {
<span id='global-cfg-initialLines'>        /**
</span>         * @cfg
         * Lines to fill in on load (one line for each element in the array).
         */
        initialLines: undefined,

        currentGroupRecords: undefined,
        assignmentrecord: undefined,
        deadlinemodel: undefined,
        suggestedDeadline: undefined
    },

    helptext:
        '&lt;div class=&quot;section helpsection&quot;&gt;' +
        //'   &lt;h1&gt;Help&lt;/h1&gt;' +
        '   &lt;p&gt;Students are organized in &lt;em&gt;assignment groups&lt;/em&gt;. You should specify &lt;strong&gt;one&lt;/strong&gt; &lt;em&gt;assignment group&lt;/em&gt; on each line in the input box.&lt;/p&gt;' +
        '   &lt;p&gt;Check &lt;strong&gt;Ignore duplicates&lt;/strong&gt; to ignore any assignment groups that contains students that already has an assignment group on this assignment.&lt;/p&gt;' +
        '   &lt;h2&gt;Common usage examples&lt;/h2&gt;' +
        '   &lt;h3&gt;Individual deliveries&lt;/h3&gt;' +
        '   &lt;p&gt;Very often, an assignment requires &lt;strong&gt;individual&lt;/strong&gt; deliveries and feedback. In this case, each &lt;em&gt;assignment group&lt;/em&gt; should contain a single student. In this case, the input box should contain something similar to this:&lt;/p&gt;' +
        '   &lt;pre style=&quot;margin-left:30px; border: 1px solid #999; padding: 5px;&quot;&gt;bob\nalice\neve\ndave&lt;/pre&gt;' +

        '   &lt;h3&gt;Group deliveries&lt;/h3&gt;' +
        '   &lt;p&gt;When students are supposed to &lt;strong&gt;cooperate&lt;/strong&gt; on the same assignment, they should be in the same &lt;em&gt;assignment group&lt;/em&gt;. In this case, the input box should contain something similar to this:&lt;/p&gt;' +
        '   &lt;pre style=&quot;margin-left:30px; border: 1px solid #999; padding: 5px;&quot;&gt;bob, alice\neve, dave, charlie&lt;/pre&gt;' +

        '   &lt;h3&gt;Anonymous assignments&lt;/h3&gt;' +
        '   &lt;p&gt;When you have specified the the assignment is anonymous, you may want to give each student a &lt;em&gt;candidate-id&lt;/em&gt; that the examiners will see instead of the username. Specify candidate-id with a colon at the end of each username like this:&lt;/p&gt;' +
        '   &lt;pre style=&quot;margin-left:30px; border: 1px solid #999; padding: 5px;&quot;&gt;bob:10, alice:232\ncharlie:4X23&lt;/pre&gt;' +

        '   &lt;h3&gt;Project groups and group naming&lt;/h3&gt;' +
        '   &lt;p&gt;It is often useful to give an &lt;em&gt;assignment group&lt;/em&gt; a &lt;strong&gt;name&lt;/strong&gt;. The name is primarily intended for project assignments, where it is useful to name a group after their project. However, the name can be used for other purposes, such as &lt;em&gt;tagging&lt;/em&gt; of groups of special interest. Since you can search for groups by name, you can name multiple groups with tags, such as &lt;em&gt;exceptional&lt;/em&gt;, and find these groups using the search field. You specify group name like this:&lt;/p&gt;' +
        '   &lt;pre style=&quot;margin-left:30px; border: 1px solid #999; padding: 5px;&quot;&gt;Secret project:: bob, alice\nTake over world:: eve, dave, charlie&lt;/pre&gt;' +

        '   &lt;h2&gt;Input format explained in detail&lt;/h2&gt;' +
        '   &lt;p&gt;The format used to create the assignment groups is:&lt;/p&gt;' +
        '   &lt;ul&gt;' +
        '       &lt;li&gt;One assignment group on each line.&lt;/li&gt;' +
        '       &lt;li&gt;Each username is separated by a comma.&lt;/li&gt;' +
        '       &lt;li&gt;Group name is identified by two colons at the end of the name, and must be placed at the beginning of the line.&lt;/li&gt;' +
        '       &lt;li&gt;A group name or at least one username is required for each group.&lt;/li&gt;' +
        '       &lt;li&gt;An optional &lt;em&gt;candidate-id&lt;/em&gt; for a candidate is denoted by a colon and the &lt;em&gt;candidate-id&lt;/em&gt; after the username.&lt;/li&gt;' +
        '       &lt;li&gt;A an optional comma-separated list of tags surrounded by parentheses.&lt;/li&gt;' +
        '   &lt;/ul&gt;' +
        '&lt;/div&gt;',

    constructor: function(config) {
        this.initConfig(config);
        this.callParent([config]);
    },

    initComponent: function() {
        this.assignmentGroupModelCls = 'devilry.apps.administrator.simplified.SimplifiedAssignmentGroup';

        var currentValue = &quot;&quot;;
        if(this.initialLines) {
            Ext.each(this.initialLines, function(line, index) {
                currentValue += Ext.String.format('{0}\n', line);
            });
        };

        this.userinput = Ext.widget('textareafield', {
            //hideLabel: true,
            fieldLabel: 'Assignment groups',
            labelAlign: 'top',
            labelWidth: 100,
            labelStyle: 'font-weight:bold',
            emptyText: 'Read the text on your right hand side for help...',
            flex: 10,
            value: currentValue
        });

        this.clearDupsCheck = Ext.widget('checkbox', {
            boxLabel: &quot;Ignore duplicates?&quot;,
            checked: true
        });
        //this.userinput.setValue('dewey\nlouie:401, hue\n\nSaker azz:: donald, dela:30');
        //this.userinput.setValue('dewey\nlouie:401');
        Ext.apply(this, {
            //items: this.userinput,

            layout: {
                type: 'hbox',
                align: 'stretch'
            },

            items: [{
                margin: 10,
                flex: 10,
                xtype: 'panel',
                border: false,
                layout: {
                    type: 'vbox',
                    align: 'stretch'
                },
                items: [this.userinput, this.clearDupsCheck],
            }, {
                flex: 10,
                xtype: 'box',
                padding: 20,
                autoScroll: true,
                html: this.helptext
            }],

            dockedItems: [{
                xtype: 'toolbar',
                dock: 'bottom',
                ui: 'footer',
                items: ['-&gt;', {
                    xtype: 'button',
                    iconCls: this.assignmentrecord.get('delivery_types') == 1? 'icon-save-32': 'icon-next-32',
                    scale: 'large',
                    text: this.assignmentrecord.get('delivery_types') == 1? 'Create groups': 'Select deadline',
                    listeners: {
                        scope: this,
                        click: this.onCreate
                    }
                }]
            }]
        });
        this.callParent(arguments);
    },

<span id='global-method-parseGroupSpec'>    /**
</span>     * @private
     */
    parseGroupSpec: function(groupSpec) {
        groupSpec = Ext.String.trim(groupSpec);
        if(groupSpec == &quot;&quot;) {
            return null;
        }
        groupSpecObj = {
            name: null,
            is_open: true,
            fake_candidates: [],
            fake_examiners: [],
            fake_tags: []
        };

        var nameSplit = groupSpec.split(/\s*::\s*/);
        if(nameSplit.length &gt; 1) {
            groupSpecObj.name = nameSplit[0];
            groupSpec = nameSplit[1];
        }

        var usernamesAndTags = this.statics().parseUsernamesAndTags(groupSpec);
        groupSpecObj.fake_tags = usernamesAndTags.tags;

        Ext.Array.each(usernamesAndTags.usernames, function(candidateSpec) {
            groupSpecObj.fake_candidates.push(devilry.administrator.studentsmanager.StudentsManagerManageGroups.parseCandidateSpec(candidateSpec));
        }, this);
        return groupSpecObj;
    },

<span id='global-method-parseTextToGroupSpec'>    /**
</span>     * @private
     */
    parseTextToGroupSpec: function(rawValue) {
        var asArray = rawValue.split('\n');
        var resultArray = [];
        var me = this;
        Ext.Array.each(asArray, function(groupSpec) {
            var groupSpecObj = me.parseGroupSpec(groupSpec);
            if(groupSpecObj != null) {
                resultArray.push(groupSpecObj);
            }
        });
        return resultArray;
    },

<span id='global-method-createAll'>    /**
</span>     * @private
     */
    createAll: function(parsedArray) {
        this.getEl().mask(Ext.String.format('Saving {0} groups', parsedArray.length));
        this.finishedCounter = 0;
        this.unsuccessful = [];
        this.parsedArray = parsedArray;
        Ext.Array.each(this.parsedArray, function(groupSpecObj) {
            this.createGroup(groupSpecObj);
        }, this);
    },

<span id='global-method-clearDuplicates'>    /**
</span>     * @private
     */
    clearDuplicates: function(parsedArray) {
        var current_usernames = []
        Ext.each(this.currentGroupRecords, function(groupRecord) {
            var group_usernames = groupRecord.data.candidates__student__username;
            current_usernames = Ext.Array.merge(current_usernames, group_usernames);
        });

        var uniqueGroupSpecObjs = [];
        var new_usernames = [];
        Ext.Array.each(parsedArray, function(groupSpecObj) {
            var dups = false;
            Ext.Array.each(groupSpecObj.fake_candidates, function(candidate) {
                if(Ext.Array.contains(current_usernames, candidate.username) || Ext.Array.contains(new_usernames, candidate.username)) {
                    dups = true;
                }
            }, this);
            if(!dups) {
                Ext.Array.each(groupSpecObj.fake_candidates, function(candidate) {
                    new_usernames.push(candidate.username);
                });
                uniqueGroupSpecObjs.push(groupSpecObj);
            }
        }, this);

        return uniqueGroupSpecObjs;
    },


    _createGroupCallback: function(pool, groupSpecObj) {
        var completeGroupSpecObj = {
            parentnode: this.assignmentrecord.data.id
        };
        Ext.apply(completeGroupSpecObj, groupSpecObj);
        var group = Ext.create(this.assignmentGroupModelCls, completeGroupSpecObj);
        group.save({
            scope: this,
            callback: function(records, op) {
                pool.notifyTaskCompleted();
                if(op.success) {
                    this.createDeadline(records);
                } else {
                    this.finishedCounter ++;
                    this.unsuccessful.push(groupSpecObj);
                    this.getEl().mask(
                        Ext.String.format('Finished saving {0}/{1} groups',
                            this.finishedCounter, this.parsedArray.length, this.parsedArray.length
                        )
                    );
                    if(this.finishedCounter == this.parsedArray.length) {
                        this.onFinishedSavingAll();
                    }
                }
            }
        });
    },

<span id='global-method-createGroup'>    /**
</span>     * @private
     */
    createGroup: function(groupSpecObj) {
        devilry.extjshelpers.AsyncActionPool.add({
            scope: this,
            args: [groupSpecObj],
            callback: this._createGroupCallback
        });
    },

    _createDeadlineCallback: function(pool, assignmentGroupRecord) {
        devilry.extjshelpers.studentsmanager.StudentsManagerManageDeadlines.createDeadline(
            assignmentGroupRecord, this.deadlineRecord, this.deadlinemodel, {
                scope: this,
                callback: function(records, op) {
                    pool.notifyTaskCompleted();
                    if(op.success) {
                        this.onCreateDeadlineSuccess();
                    } else {
                        console.error('Failed to save deadline record');
                    }
                }
            }
        );
    },

<span id='global-method-createDeadline'>    /**
</span>     * @private
     */
    createDeadline: function(assignmentGroupRecord) {
        if(this.assignmentrecord.get('delivery_types') == 1) {
            // For non-electronic assignments, a &quot;dummy deadline&quot; is created automatically
            this.onCreateDeadlineSuccess();
        } else {
            devilry.extjshelpers.AsyncActionPool.add({
                scope: this,
                args: [assignmentGroupRecord],
                callback: this._createDeadlineCallback
            });
        }
    },

<span id='global-method-onCreateDeadlineSuccess'>    /**
</span>     * @private
     */
    onCreateDeadlineSuccess: function() {
        this.finishedCounter ++;
        this.getEl().mask(Ext.String.format('Finished saving {0}/{1} groups',
            this.finishedCounter, this.parsedArray.length,
            this.parsedArray.length
        ));
        if(this.finishedCounter == this.parsedArray.length) {
            this.onFinishedSavingAll();
        }
    },

<span id='global-method-groupSpecObjToString'>    /**
</span>     * @private
     */
    groupSpecObjToString: function(groupSpecObj) {
        var groupSpecStr = &quot;&quot;;
        if(groupSpecObj.name) {
            groupSpecStr += groupSpecObj.name + &quot;:: &quot;;
        }
        Ext.Array.each(groupSpecObj.fake_candidates, function(candidate, index) {
            groupSpecStr += candidate.username;
            if(candidate.candidate_id) {
                groupSpecStr += ':' + candidate.candidate_id;
            }
            if(index != groupSpecObj.fake_candidates.length-1) {
                groupSpecStr += ', ';
            }
        }, this);
        return groupSpecStr;
    },

<span id='global-method-groupSpecObjArrayToString'>    /**
</span>     * @private
     */
    groupSpecObjArrayToString: function(groupSpecObjArray) {
        var str = &quot;&quot;;
        Ext.Array.each(groupSpecObjArray, function(groupSpecObj) {
            str += this.groupSpecObjToString(groupSpecObj) + '\n';
        }, this);
        return str;
    },

<span id='global-method-onFinishedSavingAll'>    /**
</span>     * @private
     */
    onFinishedSavingAll: function() {
        this.getEl().unmask();
        if(this.unsuccessful.length == 0) {
            this.onSuccess();
        } else {
            this.onFailure();
        }
    },

<span id='global-method-onSuccess'>    /**
</span>     * @private
     */
    onSuccess: function() {
        var me = this;
        Ext.MessageBox.show({
            title: 'Success',
            msg: Ext.String.format('Created {0} assignment groups.', this.finishedCounter),
            buttons: Ext.Msg.OK,
            icon: Ext.Msg.INFO,
            fn: function() {
                me.userinput.setValue('');
                me.up('window').close();
            }
        });
    },

<span id='global-method-onFailure'>    /**
</span>     * @private
     */
    onFailure: function() {
        this.userinput.setValue(this.groupSpecObjArrayToString(this.unsuccessful));
        Ext.MessageBox.show({
            title: 'Error',
            msg: Ext.String.format(
                'Failed to create {0} of {1} assignment groups. This is usually caused by invalid usernames. The groups with errors have been re-added to the input box.',
                this.unsuccessful.length, this.finishedCounter),
            buttons: Ext.Msg.OK,
            icon: Ext.Msg.ERROR
        });
    },

<span id='global-method-onCreate'>    /**
</span>     * @private
     */
    onCreate: function() {
        this.getEl().mask('Parsing input');
        var parsedArray = this.parseTextToGroupSpec(this.userinput.getValue());
        this.getEl().unmask();
        var clearDuplicates = this.clearDupsCheck.getValue();
        if(clearDuplicates) {
            cleanedParsedArray = this.clearDuplicates(parsedArray);
            var diff = Ext.Array.difference(parsedArray, cleanedParsedArray);
            var me = this;
            if(diff.length &gt; 0) {
                this.showClearedDuplicatesInfoWindow(cleanedParsedArray, diff);
            } else {
                this.checkForNoGroups(parsedArray);
            }
        } else {
            this.checkForNoGroups(parsedArray);
        }
    },

<span id='global-method-showClearedDuplicatesInfoWindow'>    /**
</span>     * @private
     */
    showClearedDuplicatesInfoWindow: function(cleanedParsedArray, diff) {
        var me = this;
        var msg = Ext.create('Ext.XTemplate',
            '&lt;div class=&quot;section helpsection&quot;&gt;',
            '&lt;p&gt;The groups listed below contains at least one student that already has a group on this assignment. If you choose &lt;em&gt;Next&lt;/em&gt;, these groups will be ignored. Choose &lt;em&gt;Cancel&lt;/em&gt; to return to the &lt;em&gt;Create assignment groups&lt;/em&gt; window.&lt;/p&gt;',
            '&lt;ul&gt;',
            '   &lt;tpl for=&quot;diff&quot;&gt;&lt;li&gt;',
            '       &lt;tpl if=&quot;name&quot;&gt;',
            '           {name}:: ',
            '       &lt;/tpl&gt;',
            '       &lt;tpl for=&quot;fake_candidates&quot;&gt;',
            '           {username}&lt;tpl if=&quot;candidate_id&quot;&gt;{candidate_id}&lt;/tpl&gt;&lt;tpl if=&quot;xindex &amp;lt; xcount&quot;&gt;, &lt;/tpl&gt;',
            '       &lt;/tpl&gt;',
            '       &lt;tpl if=&quot;fake_tags.length &amp;gt; 0&quot;&gt;',
            '          (&lt;tpl for=&quot;fake_tags&quot;&gt;',
            '              {.}&lt;tpl if=&quot;xindex &amp;lt; xcount&quot;&gt;, &lt;/tpl&gt;',
            '          &lt;/tpl&gt;)',
            '       &lt;/tpl&gt;',
            '   &lt;/tpl&gt;&lt;/li&gt;',
            '&lt;/ul&gt;&lt;/div&gt;'
        ).apply({diff: diff});
        Ext.widget('window', {
            width: 500,
            height: 400,
            modal: true,
            title: 'Confirm clear duplicates',
            layout: 'fit',
            items: {
                xtype: 'panel',
                border: false,
                autoScroll: true,
                html: msg
            },
            dockedItems: [{
                xtype: 'toolbar',
                dock: 'bottom',
                ui: 'footer',
                items: [{
                    xtype: 'button',
                    scale: 'large',
                    text: 'Cancel',
                    listeners: {
                        click: function() {
                            this.up('window').close();
                        }
                    }
                }, '-&gt;', {
                    xtype: 'button',
                    iconCls: 'icon-next-32',
                    scale: 'large',
                    text: 'Next',
                    listeners: {
                        click: function() {
                            this.up('window').close();
                            me.checkForNoGroups(cleanedParsedArray, 'No groups where created because all groups contained students that already have a group, and you chose to ignore duplicates.');
                        }
                    }
                }]
            }]
        }).show();
    },

<span id='global-method-checkForNoGroups'>    /**
</span>     * @private
     */
    checkForNoGroups: function(parsedArray, noGroupsMsg) {
        if(parsedArray.length == 0) {
            var msg = noGroupsMsg || 'You must add at least one group in the &lt;em&gt;assignment groups&lt;/em&gt; box.';
            Ext.MessageBox.alert('No assignment groups created', msg);
            this.up('window').close();
        } else {
            if(this.assignmentrecord.get('delivery_types') == 1) {
                this.createAll(parsedArray);
            } else {
                this.selectDeadline(parsedArray);
            }
        }
    },

    selectDeadline: function(parsedArray) {
        var me = this;
        var createDeadlineWindow = Ext.widget('multicreatenewdeadlinewindow', {
            width: this.up('window').getWidth(),
            height: this.up('window').getHeight(),
            deadlinemodel: this.deadlinemodel,
            suggestedDeadline: this.suggestedDeadline,
            deadlineRecord: this.deadlineRecord,
            onSaveSuccess: function(record) {
                this.close();
                me.deadlineRecord = record;
                var publishing_time = me.assignmentrecord.data.publishing_time;
                var period_end_time = me.assignmentrecord.data.parentnode__end_time;
                if(record.data.deadline &lt;= publishing_time || record.data.deadline &gt;= period_end_time) {
                    var error = Ext.create('Ext.XTemplate',
                        'Deadline must be between {publishing_time:date} and {period_end_time:date}.'
                    ).apply({publishing_time: publishing_time, period_end_time: period_end_time});
                    Ext.MessageBox.show({
                        title: 'Error',
                        msg: error,
                        buttons: Ext.Msg.OK,
                        icon: Ext.Msg.ERROR
                    });
                } else {
                    me.createAll(parsedArray);
                }
            }
        });
        createDeadlineWindow.show();
    },


    statics: {
        parseUsernamesAndTags: function(rawstr) {
            var tags = [];
            var tagSplit = rawstr.split(/\s*\(\s*/);
            if(tagSplit.length &gt; 1) {
                rawstr = tagSplit[0];
                var tagsString = tagSplit[1];
                tagsString = tagsString.replace(/\)/, &quot;&quot;);
                tags = tagsString.split(/\s*,\s*/);
            }
            return {
                usernames: rawstr.split(/\s*,\s*/),
                tags: tags
            };
        }
    },
});
</pre>
</body>
</html>
