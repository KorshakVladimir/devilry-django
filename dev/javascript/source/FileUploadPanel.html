<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='devilry-student-FileUploadPanel'>/**
</span> * Panel for file upload.
 */
Ext.define('devilry.student.FileUploadPanel', {
    extend: 'Ext.form.Panel',
    alias: 'widget.fileuploadpanel',
    cls: 'widget-fileuploadpanel',

    config: {
<span id='devilry-student-FileUploadPanel-cfg-initialhelptext'>        /**
</span>         * @cfg
         * A help text to show with the upload field.
         */
        initialhelptext: undefined,

<span id='devilry-student-FileUploadPanel-cfg-deadlineid'>        /**
</span>         * @cfg
         * Id of the deadline.
         */
        deadlineid: undefined,

<span id='devilry-student-FileUploadPanel-cfg-deadline_recordcontainer'>        /**
</span>         * @cfg
         * Only used to display &quot;Click to view&quot; link. (optional)
         */
        deadline_recordcontainer: undefined,

<span id='devilry-student-FileUploadPanel-cfg-deliverymodelname'>        /**
</span>         * @cfg
         * The name of the Delivery ``Ext.data.Model``.
         */
        deliverymodelname: undefined
    },

    uploadedFilesTpl: Ext.create('Ext.XTemplate',
        '&lt;tpl if=&quot;deliverysuccessful&quot;&gt;',
        '   &lt;section class=&quot;ok&quot;&gt;',
        '       &lt;h1&gt;Success&lt;/h1&gt;',
        '       &lt;p&gt;Delivery created.',
        '           &lt;tpl if=&quot;deadline&quot;&gt;',
        '               &lt;a href=&quot;{DEVILRY_MAIN_PAGE}/student/assignmentgroup/{deadline.assignment_group}?deliveryid={delivery.id}&quot;&gt;Click here&lt;/a&gt; to view the delivery.',
        '           &lt;/tpl&gt;',
        '       &lt;/p&gt;',
        '   &lt;/section&gt;',
        '&lt;/tpl&gt;',
        '&lt;tpl if=&quot;!deliverysuccessful&quot;&gt;',
        '   &lt;tpl if=&quot;filenames.length &amp;gt; 0&quot;&gt;',
        '      &lt;section class=&quot;info&quot;&gt;',
        '          &lt;h1&gt;File uploaded successfully&lt;/h1&gt;',
        '          &lt;p&gt;You have uploaded the following {filenames.length} files.&lt;/p&gt;',
        '          &lt;ul&gt;',
        '          &lt;tpl for=&quot;filenames&quot;&gt;',
        '              &lt;li&gt;{.}&lt;/li&gt;',
        '          &lt;/tpl&gt;',
        '          &lt;/ul&gt;',
        '          &lt;p&gt;Click the &lt;span class=&quot;menuref&quot;&gt;deliver&lt;/span&gt; button to deliver these {filenames.length} files, or upload more files.&lt;/p&gt;',
        '      &lt;/section&gt;',
        '   &lt;/tpl&gt;',
        '   &lt;tpl if=&quot;filenames.length == 0&quot;&gt;',
        '      &lt;section class=&quot;help&quot;&gt;',
        '          &lt;h1&gt;Create delivery&lt;/h1&gt;',
        '          &lt;p&gt;{initialhelptext}&lt;/p&gt;',
        '      &lt;/section&gt;',
        '   &lt;/tpl&gt;',
        '&lt;/tpl&gt;'
    ),

    constructor: function(config) {
        this.initConfig(config);
        this.callParent([config]);
    },

    initComponent: function() {
        //this.uploadedFiles = ['HelloWorld.py', 'This is a test.txt', 'This-is-a-long-filename-loooooong.longstuff.java'];
        this.uploadedFiles = [];
        this.infoBoxView = Ext.widget('box', {
            tpl: this.uploadedFilesTpl,
        });
        this.updateInfoBox();

        this.deliverbutton = Ext.widget('button', {
            text: 'Deliver!',
            scale: 'large',
            disabled: true,
            listeners: {
                scope: this,
                click: this.onDeliver
            }
        });

        Ext.apply(this, {
            items: [this.infoBoxView, {
                xtype: 'fileuploadfield',
                name: 'uploaded_file',
                fieldLabel: 'Delivery',
                hideLabel: true,
                labelWidth: 50,
                width: '100%',
                anchor: '100%',
                msgTarget: 'side',
                allowBlank: true,
                emptyText: 'Select file...',
                buttonText: 'Browse...',
                buttonConfig: {
                    scale: 'large'
                },
                listeners: {
                    scope: this,
                    change: this.onAddFile
                }
            }],

            dockedItems: [{
                xtype: 'toolbar',
                dock: 'bottom',
                ui: 'footer',
                items: ['-&gt;', this.deliverbutton]
            }]
        });
        this.callParent(arguments);
    },


<span id='devilry-student-FileUploadPanel-method-updateInfoBox'>    /**
</span>     * @private
     */
    updateInfoBox: function(finished) {
        this.infoBoxView.update({
            filenames: this.uploadedFiles,
            initialhelptext: this.initialhelptext,
            deliverysuccessful: finished,
            delivery: (this.deliveryrecord? this.deliveryrecord.data: null),
            DEVILRY_MAIN_PAGE: DevilrySettings.DEVILRY_MAIN_PAGE,
            deadline: (this.deadline_recordcontainer.record? this.deadline_recordcontainer.record.data: null)
        });
    },



<span id='devilry-student-FileUploadPanel-method-createInitialDelivery'>    /**
</span>     * @private
     */
    createInitialDelivery: function() {
        this.getEl().mask('Initializing delivery...');
        var delivery = Ext.create(this.deliverymodelname, {
            deadline: this.deadlineid,
            id: null,
            successful: false
        });
        delivery.save({
            scope: this,
            success: this.onCreateDeliverySuccess,
            failure: this.onCreateDeliveryFailure
        });
    },

<span id='devilry-student-FileUploadPanel-method-onCreateDeliverySuccess'>    /**
</span>     * @private
     */
    onCreateDeliverySuccess: function(deliveryrecord) {
        this.deliveryrecord = deliveryrecord;
        this.getEl().unmask();
        this.uploadFileInForm();
    },

<span id='devilry-student-FileUploadPanel-method-onCreateDeliveryFailure'>    /**
</span>     * @private
     */
    onCreateDeliveryFailure: function(x) {
        this.getEl().unmask();
        Ext.Msg.alert('Error', 'Could not create delivery on the selected deadline.'); // TODO: Check status code for permission denied.
    },



<span id='devilry-student-FileUploadPanel-method-onAddFile'>    /**
</span>     * @private
     */
    onAddFile: function () {
        if(!this.deliveryrecord) {
            this.createInitialDelivery();
        } else {
            this.uploadFileInForm();
        }
    },

<span id='devilry-student-FileUploadPanel-method-uploadFileInForm'>    /**
</span>     * @private
     */
    uploadFileInForm: function() {
        var form = this.getForm();
        var url = Ext.String.format(
            '{0}/student/add-delivery/fileupload/{1}',
            DevilrySettings.DEVILRY_MAIN_PAGE, this.deadlineid
        );
        if(form.isValid()){
            form.submit({
                url: url,
                scope: this,
                params: {deliveryid: this.deliveryrecord.data.id},
                waitMsg: 'Uploading your file...',
                success: this.onAddFileSuccess,
                failure: this.onAddFileFailure
            });
        }
    },

<span id='devilry-student-FileUploadPanel-method-onAddFileSuccess'>    /**
</span>     * @private
     */
    onAddFileSuccess: function(form, res) {
        this.uploadedFiles.push(res.result.file);
        this.updateInfoBox();
        this.deliverbutton.enable(); // really only needed on first upload, but it does not hurt.
    },

<span id='devilry-student-FileUploadPanel-method-onAddFileFailure'>    /**
</span>     * @private
     */
    onAddFileFailure: function(form, res) {
        Ext.Msg.alert('Failure', 'Error during upload, TRY AGAIN!');
    },



<span id='devilry-student-FileUploadPanel-method-onDeliver'>    /**
</span>     * @private
     */
    onDeliver: function() {
        this.deliveryrecord.data.successful = true;
        this.getEl().mask('Saving...');
        this.deliveryrecord.save({
            scope: this,
            success: this.onDeliverSuccess,
            failure: this.onDeliverFailure
        });
    },

<span id='devilry-student-FileUploadPanel-method-onDeliverSuccess'>    /**
</span>     * @private
     */
    onDeliverSuccess: function() {
        this.uploadedFiles = [];
        this.deliverbutton.disable();
        this.updateInfoBox(true);
        this.deliveryrecord = null;
        this.getEl().unmask();
    },

<span id='devilry-student-FileUploadPanel-method-onDeliverFailure'>    /**
</span>     * @private
     */
    onDeliverFailure: function() {
        this.getEl().unmask();
        Ext.Msg.alert('Failure', 'Error when finalizing the delivery, TRY AGAIN!');
    }
});
</pre>
</body>
</html>
