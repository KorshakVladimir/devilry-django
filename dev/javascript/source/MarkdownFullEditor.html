<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">Ext.define('devilry.markup.MarkdownFullEditor', {
    extend: 'Ext.panel.Panel',
    alias: 'widget.markdownfulleditor',
    layout: 'fit',
    requires: [
        'devilry.extjshelpers.HelpWindow'
    ],

    markdownHelp: Ext.create('Ext.XTemplate',
        '   &lt;h1&gt;Devilry-flavoured markdown&lt;/h1&gt;',
        '   &lt;p&gt;Devilry uses a special configuration of a markup language named Markdown.&lt;/p&gt;',
        '   &lt;ul class=&quot;right_toc&quot;&gt;',
        '       &lt;li&gt;&lt;a href=&quot;#{idprefix}-block-elements&quot;&gt;Block elements&lt;/a&gt;',
        '           &lt;ul&gt;',
        '               &lt;li&gt;&lt;a href=&quot;#{idprefix}-para&quot;&gt;Paragraphs&lt;/a&gt;&lt;/li&gt;',
        '               &lt;li&gt;&lt;a href=&quot;#{idprefix}-headers&quot;&gt;Headers&lt;/a&gt;&lt;/li&gt;',
        '               &lt;li&gt;&lt;a href=&quot;#{idprefix}-blockquotes&quot;&gt;Blockquotes&lt;/a&gt;&lt;/li&gt;',
        '               &lt;li&gt;&lt;a href=&quot;#{idprefix}-lists&quot;&gt;Lists&lt;/a&gt;&lt;/li&gt;',
        '               &lt;li&gt;&lt;a href=&quot;#{idprefix}-codeblocks&quot;&gt;Code&lt;/a&gt;&lt;/li&gt;',
        '           &lt;/ul&gt;',
        '       &lt;/li&gt;',
        '       &lt;li&gt;&lt;a href=&quot;#{idprefix}-inline-elements&quot;&gt;Inline elements&lt;/a&gt;',
        '           &lt;ul&gt;',
        '               &lt;li&gt;&lt;a href=&quot;#{idprefix}-links&quot;&gt;Links&lt;/a&gt;&lt;/li&gt;',
        '               &lt;li&gt;&lt;a href=&quot;#{idprefix}-emphasis&quot;&gt;Emphasis&lt;/a&gt;&lt;/li&gt;',
        '               &lt;li&gt;&lt;a href=&quot;#{idprefix}-code&quot;&gt;Code&lt;/a&gt;&lt;/li&gt;',
        '           &lt;/ul&gt;',
        '       &lt;/li&gt;',
        '       &lt;li&gt;&lt;a href=&quot;#{idprefix}-escaping&quot;&gt;Escaping&lt;/a&gt;&lt;/li&gt;',
        '       &lt;li&gt;&lt;a href=&quot;#{idprefix}-math&quot;&gt;LaTeX math&lt;/a&gt;',
        '           &lt;ul&gt;',
        '               &lt;li&gt;&lt;a href=&quot;#{idprefix}-inlinemath&quot;&gt;Inline&lt;/a&gt;&lt;/li&gt;',
        '               &lt;li&gt;&lt;a href=&quot;#{idprefix}-blockmath&quot;&gt;Block&lt;/a&gt;&lt;/li&gt;',
        '           &lt;/ul&gt;',
        '       &lt;/li&gt;',
        '   &lt;/ul&gt;',


        '   &lt;h2 id=&quot;{idprefix}-block-elements&quot;&gt;Block elements&lt;/h2&gt;',
        '   &lt;h3 id=&quot;{idprefix}-para&quot;&gt;Paragraphs and Breaks&lt;/h3&gt;',
        '   &lt;p&gt;To create a paragraph, simply create a block of text that is not separated by one or more blank lines. Blocks of text separated by one or more blank lines will be parsed as paragraphs.&lt;/p&gt;',
        '   &lt;p&gt;If you want to create a line break, end a line with two or more spaces, then hit Return/Enter.&lt;/p&gt;',
        
        '   &lt;h3 id=&quot;{idprefix}-headers&quot;&gt;Headers&lt;/h3&gt;',
        '   &lt;p&gt;Write the header text on its own line. Prefix your header text with the number of # characters to specify heading depth. For example:&lt;br/&gt;&lt;code&gt;# Heading 1&lt;/code&gt;&lt;br/&gt;&lt;code&gt;## My Heading 2&lt;/code&gt;&lt;/p&gt;',
        '   &lt;p&gt;&lt;/p&gt;',

        '   &lt;h3 id=&quot;{idprefix}-blockquotes&quot;&gt;Blockquotes&lt;/h3&gt;',
        '   &lt;p&gt;Markdown creates blockquotes email-style by prefixing each line with the &gt;. This looks best if you decide to hard-wrap text and prefix each line with a &gt; character, but Markdown supports just putting &gt; before your paragraph.&lt;/p&gt;',

        '   &lt;h3 id=&quot;{idprefix}-lists&quot;&gt;Lists&lt;/h3&gt;',
        '   &lt;p&gt;Markdown supports both ordered and unordered lists. To create an ordered list, simply prefix each line with a number (any number will do). To create an unordered list, you can prefix each line with &lt;strong&gt;-&lt;/strong&gt;.&lt;/p&gt;',

        '   &lt;h3 id=&quot;{idprefix}-codeblocks&quot;&gt;Code blocks&lt;/h3&gt;',
        '   &lt;p&gt;Markdown wraps code blocks in pre-formatted tags to preserve indentation in your code blocks. To create a code block, indent the entire block by at least 4 spaces. Markdown will strip the extra indentation youâ€™ve added to the code block.&lt;/p&gt;',
        '   &lt;p&gt;To get &lt;strong&gt;syntax highlighting&lt;/strong&gt;, add &lt;code&gt;:::somelanguage&lt;/code&gt; at the top of a code block. For example:&lt;/p&gt;',
        '   &lt;pre&gt;    :::python\n    def sum(a, b):\n        return a + b&lt;/pre&gt;',
        '   &lt;p&gt;The syntax hilighter uses Pygments. Check out the &lt;a href=&quot;https://github.com/devilry/devilry-django/wiki/Markdown&quot;&gt;Devilry wiki&lt;/a&gt; for supported programming languages.&lt;/p&gt;',


        '   &lt;h2 id=&quot;{idprefix}-inline-elements&quot;&gt;Inline elements&lt;/h2&gt;',
        '   &lt;h3 id=&quot;{idprefix}-links&quot;&gt;Links&lt;/h3&gt;',
        '   &lt;p&gt;To create a link, create a pair of brackets surrounding your link text, immediately followed by a pair of parentheses and write your URL within the parentheses. Example: &lt;code&gt;[Devilry website](http://devilry.org)&lt;/code&gt;.&lt;/p&gt;',
        '   &lt;p&gt;If you want to create a link that displays the actual URL, markdown allows you to quickly wrap the URL in &amp;lt; and &amp;gt; to do so. For example, the link &lt;a href=&quot;http://devilry.org&quot;&gt;http://devilry.org&lt;/a&gt; is easily produced by writing &lt;code&gt;&amp;lt;http://devilry.org&amp;gt;&lt;/code&gt;.&lt;/p&gt;',
        
        '   &lt;h3 id=&quot;{idprefix}-emphasis&quot;&gt;Emphasis&lt;/h3&gt;',
        '   &lt;p&gt;Surround you text by single underscore (i.e.: &lt;code&gt;_my text_&lt;/code&gt;) for italic text, and by double asterisks (i.e.: &lt;code&gt;**my text**&lt;/code&gt;) for bold text.&lt;/p&gt;',

        '   &lt;h3 id=&quot;{idprefix}-code&quot;&gt;Code&lt;/h3&gt;',
        '   &lt;p&gt;To create inline spans of code, simply wrap the code in backticks (`). Markdown will turn `myFunction` into &lt;code&gt;myFunction&lt;/code&gt;.&lt;/p&gt;',


        '   &lt;h2 id=&quot;{idprefix}-escaping&quot;&gt;Escaping&lt;/h2&gt;',
        '   &lt;p&gt;If you want to use a special Markdown character in your document (such as displaying literal asterisks), you can escape the character with a backslash. Markdown will ignore the character directly after a backslash. Example:&lt;/p&gt;',
        '   &lt;pre&gt;This is how the &amp;#92;_ (underscore) and &amp;#92;* asterisks characters look.&lt;/pre&gt;',

        '   &lt;h2 id=&quot;{idprefix}-math&quot;&gt;LaTeX Math&lt;/h2&gt;',
        '   &lt;p&gt;We provide two methods for writing &lt;a href=&quot;http://www.mathjax.org/&quot;&gt;MathJax&lt;/a&gt; compatible math. &lt;strong&gt;Note:&lt;/strong&gt; You must escape &lt;em&gt;backslash&lt;/em&gt; as &lt;a href=&quot;#{idprefix}-escaping&quot;&gt;described above&lt;/a&gt;.&lt;/p&gt;',

        '   &lt;h3 id=&quot;{idprefix}-inlinemath&quot;&gt;Inline&lt;/h3&gt;',
        '   &lt;p&gt;For inline math, use &lt;code&gt;$math$your math here$/math$&lt;/code&gt;. For example:&lt;/p&gt;',
        '   &lt;pre&gt;You know that $math$2^3 = 10$/math$ right?&lt;/pre&gt;',

        '   &lt;h3 id=&quot;{idprefix}-blockmath&quot;&gt;Block&lt;/h3&gt;',
        '   &lt;p&gt;For a block of math (a centered paragrath), use &lt;code&gt;$mathBlock$your math here$/mathBlock$&lt;/code&gt;. For example:&lt;/p&gt;',
        '   &lt;pre&gt;$mathblock$\n^3/_7\n$/mathblock$&lt;/pre&gt;'
    ),

    initComponent: function() {
        this.helpwindow = Ext.widget('helpwindow', {
            title: 'Devilry-flavoured markdown',
            closeAction: 'hide',
            helptext: this.markdownHelp.apply(idprefix=this.getId())
        });


        Ext.apply(this, {
            dockedItems: [{
                xtype: 'toolbar',
                cls: 'edit-toolbar',
                dock: 'top',
                items: [{
                    xtype: 'button',
                    text: 'h1',
                    cls: 'headbtn',
                    scale: 'medium',
                    listeners: {
                        scope: this,
                        click: this.onH1
                    }
                }, {
                    xtype: 'button',
                    text: 'h2',
                    cls: 'headbtn',
                    scale: 'medium',
                    listeners: {
                        scope: this,
                        click: this.onH2
                    }
                }, {
                    xtype: 'button',
                    text: 'h3',
                    cls: 'headbtn',
                    scale: 'medium',
                    listeners: {
                        scope: this,
                        click: this.onH3
                    }
                }, {xtype: 'box', width: 15}, {
                    xtype: 'button',
                    text: 'b',
                    cls: 'bbtn',
                    scale: 'medium',
                    listeners: {
                        scope: this,
                        click: this.onBold
                    }
                }, {
                    xtype: 'button',
                    text: 'i',
                    cls: 'ibtn',
                    scale: 'medium',
                    listeners: {
                        scope: this,
                        click: this.onItalic
                    }
                }, {
                    xtype: 'button',
                    text: '{}',
                    scale: 'medium',
                    cls: 'codebtn',
                    listeners: {
                        scope: this,
                        click: this.onCode
                    }
                }, {
                    xtype: 'button',
                    text: 'a',
                    cls: 'linkbtn',
                    scale: 'medium',
                    listeners: {
                        scope: this,
                        click: this.onUrl
                    }
                }, '-&gt;', {
                    xtype: 'button',
                    text: '?',
                    cls: 'helpbtn',
                    scale: 'medium',
                    listeners: {
                        scope: this,
                        click: this.onHelp
                    }
                }]
            }],
            items: [{
                xtype: 'textareafield'
            }]
        });
        this.callParent(arguments);
    },

<span id='global-method-onH1'>    /**
</span>     * @private
     */
    onH1: function() {
        this.surroundCursorSelection('\n# ', '');
    },
<span id='global-method-onH2'>    /**
</span>     * @private
     */
    onH2: function() {
        this.surroundCursorSelection('\n## ', '');
    },
<span id='global-method-onH3'>    /**
</span>     * @private
     */
    onH3: function() {
        this.surroundCursorSelection('\n### ', '');
    },

<span id='global-method-onBold'>    /**
</span>     * @private
     */
    onBold: function() {
        this.surroundCursorSelection('**');
    },
<span id='global-method-onItalic'>    /**
</span>     * @private
     */
    onItalic: function() {
        this.surroundCursorSelection('_');
    },
<span id='global-method-onCode'>    /**
</span>     * @private
     */
    onCode: function() {
        this.surroundCursorSelection('`');
    },
<span id='global-method-onUrl'>    /**
</span>     * @private
     */
    onUrl: function() {
        this.surroundCursorSelection('[', '](http://)');
    },

<span id='global-method-onBulletList'>    /**
</span>     * @private
     */
    onBulletList: function() {
        this.surroundCursorSelection('\n- ', '');
    },
<span id='global-method-onNumberedList'>    /**
</span>     * @private
     */
    onNumberedList: function() {
        this.surroundCursorSelection('\n1. ', '');
    },
<span id='global-method-onBlockQuote'>    /**
</span>     * @private
     */
    onBlockQuote: function() {
        this.surroundCursorSelection('\n&gt; ', '');
    },


<span id='global-method-getValue'>    /**
</span>     * @private
     */
    getValue: function() {
        return this.getField().getValue();
    },

<span id='global-method-setValue'>    /**
</span>     * @private
     */
    setValue: function(value) {
        this.getField().setValue(value);
    },

<span id='global-method-getField'>    /**
</span>     * @private
     */
    getField: function() {
        return this.down('textareafield');
    },

<span id='global-method-getCursorSelection'>    /**
</span>     * @private
     */
    getCursorSelection: function() {
        var field = this.getField().inputEl;
        if (Ext.isIE) {
            var bookmark = document.selection.createRange().getBookmark();
            var selection = field.dom.createTextRange();
            selection.moveToBookmark(bookmark);

            var before = field.dom.createTextRange();
            before.collapse(true);
            before.setEndPoint(&quot;EndToStart&quot;, selection);

            var selLength = selection.text.length;

            var start = before.text.length;
            return {
                start: start,
                end: start + selLength
            };
        } else {
            return {
                start: field.dom.selectionStart,
                end: field.dom.selectionEnd
            };
        }
    },
    
<span id='global-method-surroundCursorSelection'>    /**
</span>     * @private
     */
    surroundCursorSelection: function(prefix, suffix) {
        if(suffix == undefined) {
            suffix = prefix;
        }
        var selection = this.getCursorSelection();
        var curText = this.getValue();
        var textPrefix = curText.substring(0, selection.start);
        var textSuffix = curText.substring(selection.end, curText.length);
        var selectionText = curText.substring(selection.start, selection.end);
        var result = textPrefix + prefix + selectionText + suffix + textSuffix;
        this.setValue(result);

        var cursorPosition = selection.start + prefix.length;
        this.getField().selectText(cursorPosition, cursorPosition);
    },


<span id='global-method-onHelp'>    /**
</span>     * @private
     */
    onHelp: function() {
        this.helpwindow.show();
    }
});
</pre>
</body>
</html>
