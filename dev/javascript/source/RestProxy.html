<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='devilry-extjshelpers-RestProxy'>/** 
</span> * REST proxy subclass which handles errors from {@link devilry.extjshelpers.RestSubmit}. 
 *
 * Since ExtJS for some reason goes into panic mode for any HTTP status
 * code except 200 (and ignores the response text), we need to override
 * setException in the REST proxy and manually decode the responseText.
 * ([see this forum thread](http://www.sencha.com/forum/showthread.php?135143-RESTful-Model-How-to-indicate-that-the-PUT-operation-failed&amp;highlight=store+failure))
 *
 * However how do we get this into the form when we do not have any link to the form?
 *
 *  - We add the response and the the decoded responsedata to the operation
 *    object, which is available to onFailure in Submit.
 *
 * # Usage
 * 
 * First we need to use the proxy, for example in a ``Ext.data.Model``:
 *
 *     Ext.define('MyModel', {{
 *               extend: 'Ext.data.Model',
 *               requires: ['devilry.extjshelpers.RestProxy'],
 *               fields: [...],
                 proxy: Ext.create('devilry.extjshelpers.RestProxy', {
 *                   ...
 *               }
 *     });
 *
 * Then we can handle errors and access the error data as plain text or JSON.
 * See {@link #setException} for more details):
 *
 *     myform.getForm().doAction('devilryrestsubmit', {
 *         submitEmptyText: true,
 *         waitMsg: 'Saving item...',
 *         success: function(form, action) {...},
 *         failure: function(form, action) {
 *             var errorraw = action.operation.responseText;
 *             console.log(errorraw);
 *             var errorjson = action.operation.responseData;
 *             console.log(errorjson);
 *         }
 *     });
 *
 *
 * # See also
 * This should be used with {@link devilry.extjshelpers.RestSubmit}.
 * */
Ext.define('devilry.extjshelpers.RestProxy', {
    extend: 'Ext.data.proxy.Rest',
    alias: 'proxy.devilryrestproxy',

<span id='devilry-extjshelpers-RestProxy-cfg-result_fieldgroups'>    /**
</span>     * @cfg
     * Forwarded to {@link #setDevilryResultFieldgroups}.
     */
    result_fieldgroups: undefined,

<span id='devilry-extjshelpers-RestProxy-cfg-orderby'>    /**
</span>     * @cfg
     * Forwarded to {@link #setDevilryOrderby}.
     */
    orderby: undefined,

<span id='devilry-extjshelpers-RestProxy-cfg-filters'>    /**
</span>     * @cfg
     * Forwarded to {@link #setDevilryOrderby}.
     */
    filters: undefined,

    constructor: function(config) {
        Ext.apply(this, {
            reader: {
                type: 'json',
                root: 'items',
                totalProperty: 'total'
            },
            writer: {
                type: 'json'
           }
        });

        this.callParent([config]);

        if(!this.extraParams) {
            this.extraParams = {};
        }
        this.extraParams.getdata_in_qrystring = true;

        if(this.result_fieldgroups) {
            this.setDevilryResultFieldgroups(this.result_fieldgroups);
        }
        if(this.orderby) {
            this.setDevilryOrderby(this.orderby);
        }
        if(this.filters) {
            this.setDevilryFilters(this.filters);
        }
    },


<span id='devilry-extjshelpers-RestProxy-method-copy'>    /**
</span>     * Copy the extraParams and url of this proxy into a config object. Apply
     * the given options to the config, and create a new proxy object.
     */
    copy: function(options) {
        var config = {
            extraParams: this.extraParams,
            url: this.url
        };
        if(options) {
            Ext.apply(config, options);
        }
        var newproxy = Ext.create('devilry.extjshelpers.RestProxy', config);
        return newproxy;
    },
    

<span id='devilry-extjshelpers-RestProxy-method-setException'>    /**
</span>     * Overrides error handling. Adds error information to the ``operation`` parameter.
     *
     * The error data is added to:
     *
     * - ``operation.responseText``: The data in the body of the HTTP response.
     * - ``operation.responseData``: If ``responseText`` can be decoded as JSON,
     *   this contains the decoded JSON object.
     */
    setException: function(operation, response){
        operation.response = response;
        operation.responseText = response.responseText;
        try {
            operation.responseData = Ext.JSON.decode(operation.responseText); // May want to use a Reader
        } catch(e) {
            // No operation.responseData if it can not be decoded as JSON.
        }
        operation.setException({
            status: response.status,
            statusText: response.statusText
        });
    },

    setDevilryResultFieldgroups: function(fieldgroups) {
        if(Ext.typeOf(fieldgroups) !== 'array') {
            throw &quot;setDevilryResultFieldgroups(): fieldgroups must be an array&quot;;
        }
        this.extraParams.result_fieldgroups = Ext.JSON.encode(fieldgroups);
    },
    setDevilryFilters: function(filters) {
        if(Ext.typeOf(filters) !== 'array') {
            throw &quot;setDevilryFilters(): filters must be an array&quot;;
        }
        this.extraParams.filters = Ext.JSON.encode(filters);
    },
    setDevilryOrderby: function(orderby) {
        if(Ext.typeOf(orderby) !== 'array') {
            throw &quot;setDevilryOrderby(): orderby must be an array&quot;;
        }
        this.extraParams.orderby = Ext.JSON.encode(orderby);
    },

    statics: {
        formatHtmlErrorMessage: function(operation, message) {
            var tpl = Ext.create('Ext.XTemplate', 
                '&lt;div class=&quot;section errormessages&quot;&gt;',
                '&lt;tpl if=&quot;message&quot;&gt;&lt;p&gt;{message}&lt;/p&gt;&lt;/tpl&gt;',
                '&lt;tpl if=&quot;httperror&quot;&gt;&lt;p&gt;{httperror.status} {httperror.statusText}&lt;/p&gt;&lt;/tpl&gt;',
                '&lt;tpl for=&quot;errormessages&quot;&gt;',
                '   &lt;p&gt;{.}&lt;/p&gt;',
                '&lt;/tpl&gt;',
                '&lt;/div&gt;'
            );
            var tpldata = {message: message};
            if(operation.responseData &amp;&amp; operation.responseData.errormessages) {
                tpldata.errormessages = operation.responseData.errormessages;
            } else if(operation.error.status === 0) {
                tpldata.httperror = {'status': 'Lost connection with server.'};
            } else {
                tpldata.httperror = operation.error;
            }
            return tpl.apply(tpldata);
        },

        showErrorMessagePopup: function(operation, title, message) {
            Ext.MessageBox.show({
                title: title,
                msg: devilry.extjshelpers.RestProxy.formatHtmlErrorMessage(operation),
                buttons: Ext.Msg.OK,
                icon: Ext.Msg.ERROR
            });
        }
    }
});
</pre>
</body>
</html>
