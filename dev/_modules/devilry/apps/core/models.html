

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>devilry.apps.core.models &mdash; Devilry v1.0 documentation</title>
    <link rel="stylesheet" href="../../../../_static/devilry.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="Devilry v1.0 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Devilry v1.0 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for devilry.apps.core.models</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. attribute:: pathsep</span>

<span class="sd">    Path separator used by node-paths. The value is ``&#39;.&#39;``, and it must not</span>
<span class="sd">    be changed.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Q</span><span class="p">,</span> <span class="n">Max</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">django.contrib.contenttypes.models</span> <span class="kn">import</span> <span class="n">ContentType</span>
<span class="kn">from</span> <span class="nn">django.contrib.contenttypes</span> <span class="kn">import</span> <span class="n">generic</span>
<span class="kn">from</span> <span class="nn">django.utils.formats</span> <span class="kn">import</span> <span class="n">date_format</span>

<span class="kn">from</span> <span class="nn">deliverystore</span> <span class="kn">import</span> <span class="n">load_deliverystore_backend</span><span class="p">,</span> <span class="n">FileNotFoundError</span>
<span class="kn">import</span> <span class="nn">gradeplugin</span>



<span class="c"># TODO: indexes</span>
<span class="c"># TODO: short_name ignorecase match on save.</span>

<span class="n">pathsep</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span> <span class="c"># path separator for Node-paths</span>


<div class="viewcode-block" id="AbstractIsAdmin"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AbstractIsAdmin">[docs]</a><span class="k">class</span> <span class="nc">AbstractIsAdmin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Abstract class implemented by all classes where it is natural to</span>
<span class="sd">    need to check if a user has admin rights. &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="AbstractIsAdmin.q_is_admin"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AbstractIsAdmin.q_is_admin">[docs]</a>    <span class="k">def</span> <span class="nf">q_is_admin</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a django.db.models.Q object matching all objects of this</span>
<span class="sd">        type where the given user is admin. The matched result is not</span>
<span class="sd">        guaranteed to contain unique items, so you should use distinct() on</span>
<span class="sd">        the queryset if this is required.</span>

<span class="sd">        This must be implemented in all subclassed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="AbstractIsAdmin.where_is_admin"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AbstractIsAdmin.where_is_admin">[docs]</a>    <span class="k">def</span> <span class="nf">where_is_admin</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get all objects of this type where the given user is admin. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">q_is_admin</span><span class="p">(</span><span class="n">user_obj</span><span class="p">))</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="AbstractIsAdmin.where_is_admin_or_superadmin"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AbstractIsAdmin.where_is_admin_or_superadmin">[docs]</a>    <span class="k">def</span> <span class="nf">where_is_admin_or_superadmin</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get all objects of this type where the given user is admin, or</span>
<span class="sd">        all objects if the user is superadmin. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_obj</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">where_is_admin</span><span class="p">(</span><span class="n">user_obj</span><span class="p">)</span>

</div></div>
<span class="k">class</span> <span class="nc">AbstractIsCandidate</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="c"># TODO: document this shit</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">q_is_candidate</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">q_published</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">active</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">where_is_candidate</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">q_is_candidate</span><span class="p">(</span><span class="n">user_obj</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">published_where_is_candidate</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">q_published</span><span class="p">(</span><span class="n">old</span><span class="o">=</span><span class="n">old</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="n">active</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">q_is_candidate</span><span class="p">(</span><span class="n">user_obj</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">active_where_is_candidate</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">published_where_is_candidate</span><span class="p">(</span><span class="n">user_obj</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">old_where_is_candidate</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">published_where_is_candidate</span><span class="p">(</span><span class="n">user_obj</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<div class="viewcode-block" id="AbstractIsExaminer"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AbstractIsExaminer">[docs]</a><span class="k">class</span> <span class="nc">AbstractIsExaminer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Abstract class implemented by all classes where it is natural to</span>
<span class="sd">    need to check if a user is examiner. &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="AbstractIsExaminer.q_published"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AbstractIsExaminer.q_published">[docs]</a>    <span class="k">def</span> <span class="nf">q_published</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a django.models.Q object which matches all items of this type</span>
<span class="sd">        where :attr:`Assignment.publishing_time` is in the future.</span>

<span class="sd">        :param old: Include assignments where :attr:`Period.end_time`</span>
<span class="sd">            is in the past?</span>
<span class="sd">        :param active: Include assignments where :attr:`Period.end_time`</span>
<span class="sd">            is in the future?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="AbstractIsExaminer.q_is_examiner"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AbstractIsExaminer.q_is_examiner">[docs]</a>    <span class="k">def</span> <span class="nf">q_is_examiner</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a django.models.Q object which matches items</span>
<span class="sd">        where the given user is examiner.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="AbstractIsExaminer.where_is_examiner"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AbstractIsExaminer.where_is_examiner">[docs]</a>    <span class="k">def</span> <span class="nf">where_is_examiner</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get all items of this type where the given ``user_obj`` is</span>
<span class="sd">        examiner on one of the assignment groups.</span>

<span class="sd">        :param user_obj: A django.contrib.auth.models.User_ object.</span>
<span class="sd">        :rtype: QuerySet</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">q_is_examiner</span><span class="p">(</span><span class="n">user_obj</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="AbstractIsExaminer.published_where_is_examiner"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AbstractIsExaminer.published_where_is_examiner">[docs]</a>    <span class="k">def</span> <span class="nf">published_where_is_examiner</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all published &lt;assignment-classifications&gt;` items of this type</span>
<span class="sd">        where the given ``user_obj`` is examiner on one of the assignment</span>
<span class="sd">        groups. Combines :meth:`q_is_examiner` and :meth:`q_published`.</span>

<span class="sd">        :param user_obj: :meth:`q_is_examiner`.</span>
<span class="sd">        :param old: :meth:`q_published`.</span>
<span class="sd">        :param active: :meth:`q_published`.</span>
<span class="sd">        :return: A django.db.models.query.QuerySet with duplicate</span>
<span class="sd">            assignments eliminated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">q_published</span><span class="p">(</span><span class="n">old</span><span class="o">=</span><span class="n">old</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="n">active</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">q_is_examiner</span><span class="p">(</span><span class="n">user_obj</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="AbstractIsExaminer.active_where_is_examiner"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AbstractIsExaminer.active_where_is_examiner">[docs]</a>    <span class="k">def</span> <span class="nf">active_where_is_examiner</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shortcut for :meth:`published_where_is_examiner` with</span>
<span class="sd">        ``old=False``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">published_where_is_examiner</span><span class="p">(</span><span class="n">user_obj</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">active</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="AbstractIsExaminer.old_where_is_examiner"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AbstractIsExaminer.old_where_is_examiner">[docs]</a>    <span class="k">def</span> <span class="nf">old_where_is_examiner</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shortcut for :meth:`published_where_is_examiner` with</span>
<span class="sd">        ``active=False``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">published_where_is_examiner</span><span class="p">(</span><span class="n">user_obj</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

</div></div>
<span class="k">class</span> <span class="nc">SaveInterface</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">can_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check if the give user has permission to save (or create) this</span>
<span class="sd">        node.</span>

<span class="sd">        A user can create a new node if it:</span>

<span class="sd">            - Is a superuser.</span>
<span class="sd">            - Is admin on any parentnode.</span>

<span class="sd">        A user can save if it:</span>

<span class="sd">            - Is a superuser.</span>
<span class="sd">            - Is admin on any parentnode.</span>
<span class="sd">            - Is admin on the node.</span>

<span class="sd">        :param user_obj: A django.contrib.auth.models.User_ object.</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>


<div class="viewcode-block" id="splitpath"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.splitpath">[docs]</a><span class="k">def</span> <span class="nf">splitpath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">expected_len</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Split the path on :attr:`pathsep` and return the resulting list.</span>
<span class="sd">    Example:</span>

<span class="sd">    &gt;&gt;&gt; splitpath(&#39;uio.ifi.matnat&#39;)</span>
<span class="sd">    [&#39;uio&#39;, &#39;ifi&#39;, &#39;matnat&#39;]</span>
<span class="sd">    &gt;&gt;&gt; splitpath(&#39;uio.ifi.matnat&#39;, expected_len=2)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    ValueError: Path must have exactly 2 parts</span>

<span class="sd">    :param expected_len:</span>
<span class="sd">        Expected length of the resulting list. If the resulting list is not</span>
<span class="sd">        exactly the given length, ``ValueError`` is raised. If</span>
<span class="sd">        ``expected_len`` is 0 (default), no checking is done.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pathsep</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">expected_len</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">!=</span> <span class="n">expected_len</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Path must have exactly </span><span class="si">%d</span><span class="s"> parts&#39;</span> <span class="o">%</span> <span class="n">expected_len</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>

</div>
<span class="k">class</span> <span class="nc">ShortNameField</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">SlugField</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Short name field used by several of the core models.</span>

<span class="sd">    We have a hierarchy of objects with a short name, but they are not</span>
<span class="sd">    strictly equal (eg. we cannot use a superclass because Subject has a</span>
<span class="sd">    unique short_name).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">patt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^[a-z0-9_-]+$&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">max_length</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
            <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Short name&#39;</span><span class="p">),</span>
            <span class="n">db_index</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
            <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;Max 20 characters. Only numbers, lowercase characters, &#39;_&#39; &quot;</span> \
                    <span class="s">&quot;and &#39;-&#39;. &quot;</span> <span class="p">))</span>
        <span class="n">kw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ShortNameField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ShortNameField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">patt</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;Can only contain numbers, lowercase letters, &#39;_&#39; and &#39;-&#39;. &quot;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">LongNameField</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">verbose_name</span><span class="o">=</span><span class="s">&#39;Long name&#39;</span><span class="p">,</span>
            <span class="n">db_index</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
            <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&#39;A longer name, more descriptive than &quot;Short name&quot;. &#39;</span>\
                <span class="s">&#39;This is the name visible to students.&#39;</span><span class="p">))</span>
        <span class="n">kw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LongNameField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>


<div class="viewcode-block" id="BaseNode"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.BaseNode">[docs]</a><span class="k">class</span> <span class="nc">BaseNode</span><span class="p">(</span><span class="n">AbstractIsAdmin</span><span class="p">,</span> <span class="n">SaveInterface</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The base class of the Devilry hierarchy. Implements basic functionality</span>
<span class="sd">    used by the other Node classes. This is an abstract datamodel, so it</span>
<span class="sd">    is never used directly.</span>


<span class="sd">    .. attribute:: short_name</span>

<span class="sd">        A django.db.models.SlugField_ with max 20 characters. Only numbers,</span>
<span class="sd">        letters, &#39;_&#39; and &#39;-&#39;.</span>

<span class="sd">    .. attribute:: long_name</span>

<span class="sd">        A django.db.models.CharField_ with max 100 characters. Gives a longer </span>
<span class="sd">        description than :attr:`short_name`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">get_path</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_name</span>
    <span class="n">get_path</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Path&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_full_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">get_full_path</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_name</span>
    <span class="n">get_full_path</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Unique Path&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_admins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get a string with the username of all administrators on this node</span>
<span class="sd">        separated by comma and a space like: ``&quot;uioadmin, superuser&quot;``.</span>
<span class="sd">        </span>
<span class="sd">        Note that admins on parentnode(s) is not included.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">u&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">u</span><span class="o">.</span><span class="n">username</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">admins</span><span class="o">.</span><span class="n">all</span><span class="p">()])</span>
    <span class="n">get_admins</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Administrators&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check if the given user is admin on this node or any parentnode.</span>
<span class="sd">        </span>
<span class="sd">        :param user_obj: A django.contrib.auth.models.User_ object.</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">admins</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">user_obj</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">User</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">is_admin</span><span class="p">(</span><span class="n">user_obj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_can_save_id_none</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Used by all except Node, which overrides. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">is_admin</span><span class="p">(</span><span class="n">user_obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">can_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">user_obj</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_save_id_none</span><span class="p">(</span><span class="n">user_obj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_admin</span><span class="p">(</span><span class="n">user_obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

</div>
<div class="viewcode-block" id="Node"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Node">[docs]</a><span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">BaseNode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class is typically used to represent a hierarchy of institutions, </span>
<span class="sd">    faculties and departments.</span>


<span class="sd">    .. attribute:: parentnode</span>

<span class="sd">        A django.db.models.ForeignKey_ that points to the parent node, which</span>
<span class="sd">        is always a `Node`_.</span>

<span class="sd">    .. attribute:: admins</span>

<span class="sd">        A django.db.models.ManyToManyField_ that holds all the admins of the</span>
<span class="sd">        `Node`_.</span>

<span class="sd">    .. attribute:: child_nodes</span>

<span class="sd">        A set of child_nodes for this node</span>
<span class="sd"> </span>
<span class="sd">    .. attribute:: subjects</span>

<span class="sd">        A set of subjects for this node </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">short_name</span> <span class="o">=</span> <span class="n">ShortNameField</span><span class="p">()</span>
    <span class="n">long_name</span> <span class="o">=</span> <span class="n">LongNameField</span><span class="p">()</span>
    <span class="n">parentnode</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;self&#39;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;child_nodes&#39;</span><span class="p">)</span>
    <span class="n">admins</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Node&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Nodes&#39;</span><span class="p">)</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;short_name&#39;</span><span class="p">,</span> <span class="s">&#39;parentnode&#39;</span><span class="p">)</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;short_name&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_can_save_id_none</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">is_admin</span><span class="p">(</span><span class="n">user_obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">get_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">get_path</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_name</span>

    <span class="k">def</span> <span class="nf">get_full_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">()</span>
    <span class="n">get_full_path</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="n">BaseNode</span><span class="o">.</span><span class="n">get_full_path</span><span class="o">.</span><span class="n">short_description</span>
    
<div class="viewcode-block" id="Node.iter_childnodes"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Node.iter_childnodes">[docs]</a>    <span class="k">def</span> <span class="nf">iter_childnodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursively iterates over all child nodes, and their child nodes.</span>
<span class="sd">        For a list of direct child nodes, use atribute child_nodes instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">Node</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">parentnode</span><span class="o">=</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">node</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">iter_childnodes</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">c</span>
</div>
<div class="viewcode-block" id="Node.clean"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Node.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate the node, making sure it does not do something stupid.</span>

<span class="sd">        Always call this before save()! Read about validation here:</span>
<span class="sd">        http://docs.djangoproject.com/en/dev/ref/models/instances/#id1</span>

<span class="sd">        Raises ValidationError if:</span>

<span class="sd">            - The node is it&#39;s own parent.</span>
<span class="sd">            - The node is the child of itself or one of its childnodes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span> <span class="o">==</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;A node can not be it</span><span class="se">\&#39;</span><span class="s">s own parent.&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_name</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Node</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">short_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">short_name</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;A node can not have the same &#39;</span>\
                        <span class="s">&#39;short name as another within the same parent.&#39;</span><span class="p">))</span>


        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_childnodes</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;A node can not be the child of one of it</span><span class="se">\&#39;</span><span class="s">s own children.&#39;</span><span class="p">))</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_nodepks_where_isadmin</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get a list with the primary key of all nodes where the given</span>
<span class="sd">        `user_obj` is admin. &quot;&quot;&quot;</span>
        <span class="n">admnodes</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">admins</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">add_admnodes</span><span class="p">(</span><span class="n">admnodes</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">admnodes</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
                <span class="n">add_admnodes</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">child_nodes</span><span class="p">)</span>
        <span class="n">add_admnodes</span><span class="p">(</span><span class="n">admnodes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">l</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">q_is_admin</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">cls</span><span class="o">.</span><span class="n">_get_nodepks_where_isadmin</span><span class="p">(</span><span class="n">user_obj</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Node.get_by_path_kw"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Node.get_by_path_kw">[docs]</a>    <span class="k">def</span> <span class="nf">get_by_path_kw</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">pathlist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Used by :meth:`get_by_path` to create the required kwargs for</span>
<span class="sd">        Node.objects.get(). Might be a starting point for more sophisticated</span>
<span class="sd">        queries including paths. Example::</span>

<span class="sd">            ifi = Node.objects.get(**Node.get_by_path_kw([&#39;uio&#39;, &#39;ifi&#39;]))</span>

<span class="sd">        :param pathlist: A list of node-names, like ``[&#39;uio&#39;, &#39;ifi&#39;]``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;short_name&#39;</span>
        <span class="k">for</span> <span class="n">short_name</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">pathlist</span><span class="p">):</span>
            <span class="n">kw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">short_name</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;parentnode__&#39;</span> <span class="o">+</span> <span class="n">key</span>
        <span class="k">return</span> <span class="n">kw</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Node.get_by_path"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Node.get_by_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_by_path</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get a node by path.</span>

<span class="sd">        Raises :exc:`Node.DoesNotExist` if the query does not match.</span>
<span class="sd">        </span>
<span class="sd">        :param path: The path to a Node, like ``&#39;uio.ifi&#39;``.</span>
<span class="sd">        :type path: str</span>
<span class="sd">        :return: A Node-object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Node</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">**</span><span class="n">Node</span><span class="o">.</span><span class="n">get_by_path_kw</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)))</span>

</div></div>
<div class="viewcode-block" id="Subject"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Subject">[docs]</a><span class="k">class</span> <span class="nc">Subject</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">BaseNode</span><span class="p">,</span> <span class="n">AbstractIsExaminer</span><span class="p">,</span> <span class="n">AbstractIsCandidate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    .. attribute:: parentnode</span>

<span class="sd">        A django.db.models.ForeignKey_ that points to the parent node,</span>
<span class="sd">        which is always a `Node`_.</span>

<span class="sd">    .. attribute:: admins</span>

<span class="sd">        A django.db.models.ManyToManyField_ that holds all the admins of the</span>
<span class="sd">        `Node`_.</span>

<span class="sd">    .. attribute:: short_name</span>

<span class="sd">        A django.db.models.SlugField_ with max 20 characters. Only numbers,</span>
<span class="sd">        letters, &#39;_&#39; and &#39;-&#39;. Unlike all other children of</span>
<span class="sd">        :class:`BaseNode`, Subject.short_name is **unique**. This is mainly</span>
<span class="sd">        to avoid the overhead of having to recurse all the way to the top of</span>
<span class="sd">        the node hierarchy for every unique path.</span>


<span class="sd">    .. attribute:: periods</span>

<span class="sd">        A set of periods for this subject </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Subjects&#39;</span><span class="p">)</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;short_name&#39;</span><span class="p">]</span>

    <span class="n">short_name</span> <span class="o">=</span> <span class="n">ShortNameField</span><span class="p">(</span><span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">long_name</span> <span class="o">=</span> <span class="n">LongNameField</span><span class="p">()</span>
    <span class="n">parentnode</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;subjects&#39;</span><span class="p">)</span>
    <span class="n">admins</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">q_is_admin</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Q</span><span class="p">(</span><span class="n">admins__pk</span><span class="o">=</span><span class="n">user_obj</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span> \
                <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">parentnode__pk__in</span><span class="o">=</span><span class="n">Node</span><span class="o">.</span><span class="n">_get_nodepks_where_isadmin</span><span class="p">(</span><span class="n">user_obj</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Subject.get_by_path"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Subject.get_by_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_by_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get a Subject by path.</span>

<span class="sd">        Only matches on :attr:`short_name` for subjects because it is</span>
<span class="sd">        guaranteed to be unique.</span>

<span class="sd">        Raises :exc:`Subject.DoesNotExist` if the query does not match.</span>
<span class="sd">        </span>
<span class="sd">        :param path: The :attr:`short_name` of a subject.</span>
<span class="sd">        :return: A Subject-object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Subject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">short_name</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Subject.get_path"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Subject.get_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Only returns :attr:`short_name` for subject since it is</span>
<span class="sd">        guaranteed to be unique. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_name</span>
</div>
    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Subject</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">q_published</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">periods__assignments__publishing_time__lt</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">active</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">periods__end_time__gte</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">old</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">periods__end_time__lt</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">q</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">q_is_examiner</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">(</span><span class="n">periods__assignments__assignmentgroups__examiners</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">q_is_candidate</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">(</span><span class="n">periods__assignments__assignmentgroups__candidates</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Period"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Period">[docs]</a><span class="k">class</span> <span class="nc">Period</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">BaseNode</span><span class="p">,</span> <span class="n">AbstractIsExaminer</span><span class="p">,</span> <span class="n">AbstractIsCandidate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Period represents a period of time, for example a half-year term</span>
<span class="sd">    at a university.</span>


<span class="sd">    .. attribute:: parentnode</span>

<span class="sd">        A django.db.models.ForeignKey_ that points to the parent node,</span>
<span class="sd">        which is always a `Subject`_.</span>

<span class="sd">    .. attribute:: start_time</span>

<span class="sd">        A django.db.models.DateTimeField_ representing the starting time of</span>
<span class="sd">        the period.</span>

<span class="sd">    .. attribute:: end_time</span>

<span class="sd">        A django.db.models.DateTimeField_ representing the ending time of</span>
<span class="sd">        the period.</span>

<span class="sd">    .. attribute:: admins</span>

<span class="sd">        A django.db.models.ManyToManyField_ that holds all the admins of the</span>
<span class="sd">        node.</span>

<span class="sd">    .. attribute:: assignments</span>

<span class="sd">        A set of assignments for this period </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Period&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Periods&#39;</span><span class="p">)</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;short_name&#39;</span><span class="p">,</span> <span class="s">&#39;parentnode&#39;</span><span class="p">)</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;short_name&#39;</span><span class="p">]</span>

    <span class="n">short_name</span> <span class="o">=</span> <span class="n">ShortNameField</span><span class="p">()</span>
    <span class="n">long_name</span> <span class="o">=</span> <span class="n">LongNameField</span><span class="p">()</span>
    <span class="n">parentnode</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Subject</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;periods&#39;</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span>
            <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&#39;Start time and end time defines when the period is active.&#39;</span><span class="p">))</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span>
            <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&#39;Start time and end time defines when the period is active.&#39;</span><span class="p">))</span>
    <span class="n">admins</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">minimum_points</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Students must get at least this many points to &#39;</span>\
                    <span class="s">&#39;pass the period.&#39;</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">q_published</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">assignments__publishing_time__lt</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">active</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">end_time__gte</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">old</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">end_time__lt</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">q</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">q_is_candidate</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">(</span><span class="n">assignmentgroups__candidates__student</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">student_sum_scaled_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">AssignmentGroup</span><span class="o">.</span><span class="n">published_where_is_candidate</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">parentnode__parentnode</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">groups</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Sum</span><span class="p">(</span><span class="s">&#39;scaled_points&#39;</span><span class="p">))[</span><span class="s">&#39;scaled_points__sum&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">student_passes_period</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">AssignmentGroup</span><span class="o">.</span><span class="n">published_where_is_candidate</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">parentnode__parentnode</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">is_passing_grade</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">parentnode__must_pass</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">groups</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">totalpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">student_sum_scaled_points</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">totalpoints</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimum_points</span>

    <span class="k">def</span> <span class="nf">get_must_pass_assignments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignments</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">must_pass</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">q_is_admin</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">(</span><span class="n">admins</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span> <span class="o">|</span> \
                <span class="n">Q</span><span class="p">(</span><span class="n">parentnode__admins</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span> <span class="o">|</span> \
                <span class="n">Q</span><span class="p">(</span><span class="n">parentnode__parentnode__pk__in</span><span class="o">=</span><span class="n">Node</span><span class="o">.</span><span class="n">_get_nodepks_where_isadmin</span><span class="p">(</span><span class="n">user_obj</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Period.not_ended_where_is_admin"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Period.not_ended_where_is_admin">[docs]</a>    <span class="k">def</span> <span class="nf">not_ended_where_is_admin</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a QuerySet matching all Periods where the given user is</span>
<span class="sd">        admin and end_time is in the future.</span>
<span class="sd">        </span>
<span class="sd">        :param user_obj: A django.contrib.auth.models.User_ object.</span>
<span class="sd">        :rtype: QuerySet</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">where_is_admin</span><span class="p">(</span><span class="n">user_obj</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">end_time__gt</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Period.not_ended_where_is_admin_or_superadmin"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Period.not_ended_where_is_admin_or_superadmin">[docs]</a>    <span class="k">def</span> <span class="nf">not_ended_where_is_admin_or_superadmin</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a QuerySet matching all Periods where the given user is</span>
<span class="sd">        admin or superadmin and end_time is in the future.</span>
<span class="sd">        </span>
<span class="sd">        :param user_obj: A django.contrib.auth.models.User_ object.</span>
<span class="sd">        :rtype: QuerySet</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_obj</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">end_time__gt</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">not_ended_where_is_admin</span><span class="p">(</span><span class="n">user_obj</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Period.get_by_path"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Period.get_by_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_by_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get a Period by path.</span>

<span class="sd">        Raises :exc:`Period.DoesNotExist` if the query does not match.</span>
<span class="sd">        Raises :exc:`ValueError` if the path does not contain exactly two</span>
<span class="sd">        path-elements (uses :func:`splitpath`).</span>
<span class="sd">        </span>
<span class="sd">        :param path: The path to a Period, like ``&#39;inf1100.spring09&#39;``.</span>
<span class="sd">        :return: A Period-object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subject</span><span class="p">,</span> <span class="n">period</span> <span class="o">=</span> <span class="n">splitpath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">expected_len</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Period</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">parentnode__short_name</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span>
                <span class="n">short_name</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Period.clean"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Period.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate the period.</span>

<span class="sd">        Always call this before save()! Read about validation here:</span>
<span class="sd">        http://docs.djangoproject.com/en/dev/ref/models/instances/#id1</span>

<span class="sd">        Raises ValidationError if start_time is after end_time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Start time must be before end time.&#39;</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Period</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Period.is_active"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Period.is_active">[docs]</a>    <span class="k">def</span> <span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns true if the period is active</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">&lt;</span> <span class="n">now</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">&gt;</span> <span class="n">now</span>
</div>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">q_is_examiner</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">(</span><span class="n">assignments__assignmentgroups__examiners</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Assignment"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Assignment">[docs]</a><span class="k">class</span> <span class="nc">Assignment</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">BaseNode</span><span class="p">,</span> <span class="n">AbstractIsExaminer</span><span class="p">,</span> <span class="n">AbstractIsCandidate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    .. attribute:: parentnode</span>

<span class="sd">        A django.db.models.ForeignKey_ that points to the parent node,</span>
<span class="sd">        which is always a `Period`_.</span>

<span class="sd">    .. attribute:: publishing_time</span>

<span class="sd">        A django.db.models.DateTimeField_ representing the publishing time of</span>
<span class="sd">        the assignment.</span>

<span class="sd">    .. attribute:: anonymous</span>

<span class="sd">        A models.BooleanField specifying if the assignment should be</span>
<span class="sd">        anonymously for correcters.</span>

<span class="sd">    .. attribute:: admins</span>

<span class="sd">        A django.db.models.ManyToManyField_ that holds all the admins of the</span>
<span class="sd">        Node.</span>

<span class="sd">    .. attribute:: grade_plugin</span>

<span class="sd">        A django.db.models.CharField_ that holds the key of the current</span>
<span class="sd">        grade-plugin. More info on grade-plugins</span>
<span class="sd">        :ref:`here &lt;grade-plugins&gt;`.</span>

<span class="sd">    .. attribute:: assignmentgroups</span>

<span class="sd">        A set of the :class:`AssignmentGroup` for this assignment.</span>

<span class="sd">    .. attribute:: filenames</span>
<span class="sd">    </span>
<span class="sd">        A optional string of filenames separated by whitespace.</span>

<span class="sd">    .. attribute:: pointscale</span>

<span class="sd">        The points will be scaled down or up making the _this_</span>
<span class="sd">        number the maximum number of points. Defaults to 1.</span>

<span class="sd">    .. attribute:: autoscale</span>
<span class="sd">            </span>
<span class="sd">        If this field is True, the pointscale will automatically be set</span>
<span class="sd">        to the maximum number of points possible with the selected grade</span>
<span class="sd">        plugin.</span>

<span class="sd">    .. attribute:: maxpoints</span>

<span class="sd">        The maximum number of points possible without scaling. This is set</span>
<span class="sd">        using :meth:`devilry.core.gradeplugin.GradeModel.get_maxpoints`.</span>

<span class="sd">    .. attribute:: attempts</span>

<span class="sd">        The number of attempts a student get on this assignment. This is</span>
<span class="sd">        not a hard limit, but it makes the work of the examiners easier</span>
<span class="sd">        because the system will close groups (leaving students unable to</span>
<span class="sd">        deliver more attempts) when they have this many published</span>
<span class="sd">        feedbacks. Examiners can open closed groups, and they are</span>
<span class="sd">        notified when a group is automatically closed.</span>

<span class="sd">        If this is None, closing of groups has to be handled manually.</span>

<span class="sd">    .. attribute:: must_pass</span>
<span class="sd">        </span>
<span class="sd">        Each student must get a passing grade on this assignment to get a</span>
<span class="sd">        passing grade on the period. Defaults to False.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Assignment&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Assignments&#39;</span><span class="p">)</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;short_name&#39;</span><span class="p">,</span> <span class="s">&#39;parentnode&#39;</span><span class="p">)</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;short_name&#39;</span><span class="p">]</span>

    <span class="n">short_name</span> <span class="o">=</span> <span class="n">ShortNameField</span><span class="p">()</span>
    <span class="n">long_name</span> <span class="o">=</span> <span class="n">LongNameField</span><span class="p">()</span>
    <span class="n">parentnode</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Period</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;assignments&#39;</span><span class="p">)</span>
    <span class="n">publishing_time</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span>
            <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Publishing time&quot;</span><span class="p">))</span>
    <span class="n">anonymous</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Anonymous&quot;</span><span class="p">))</span>
    <span class="n">students_can_see_points</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Students can see points&quot;</span><span class="p">))</span>
    <span class="n">admins</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Administrators&quot;</span><span class="p">))</span>
    <span class="n">grade_plugin</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Grade plugin&quot;</span><span class="p">),</span>
            <span class="n">choices</span><span class="o">=</span><span class="n">gradeplugin</span><span class="o">.</span><span class="n">registry</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">gradeplugin</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">getdefaultkey</span><span class="p">())</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Filenames&quot;</span><span class="p">),</span>
            <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Filenames separated by newline or space. If &#39;</span>
                <span class="s">&#39;filenames are used, students will not be able to deliver &#39;</span>
                <span class="s">&#39;files where the filename is not among the given filenames.&#39;</span><span class="p">))</span>
    <span class="n">must_pass</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Must pass&quot;</span><span class="p">),</span>
            <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Each student must get a passing grade on this &#39;</span> \
                <span class="s">&#39;assignment to get a passing grade on the period.&#39;</span><span class="p">))</span>
    <span class="n">pointscale</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Scaled maximum points&quot;</span><span class="p">),</span>
            <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&#39;The points will be scaled down or up making the _this_ &#39;</span>
                <span class="s">&#39;number the maximum number of points on this assignment. &#39;</span>
                <span class="s">&#39;You use this to adjust how much an assignment counts &#39;</span>
                <span class="s">&#39;towards the final grade (or towards passing the period). &#39;</span>
                <span class="s">&#39;A typical example is when you have one assignment where &#39;</span>
                <span class="s">&#39;it is possible to get 30 points, and one assignment &#39;</span>
                <span class="s">&#39;where it is possible to get 1 point (like &#39;</span>
                <span class="s">&#39;with the approved/notapproved plugin). If you want both &#39;</span>
                <span class="s">&#39;to count for maximum 40 points, you set this field to 40 &#39;</span>
                <span class="s">&#39;on both assignments.&#39;</span><span class="p">))</span>
    <span class="n">maxpoints</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;The maximum number of points possible without &#39;</span>\
                <span class="s">&#39;scaling.&#39;</span><span class="p">))</span>
    <span class="n">autoscale</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Autoscale&quot;</span><span class="p">),</span>
            <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;If this field is set, the pointscale will &#39;</span>\
                <span class="s">&#39;automatically be set to the maximum number of points &#39;</span>\
                <span class="s">&#39;possible with the selected grade plugin.&#39;</span><span class="p">))</span>
    <span class="n">attempts</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Attempts&quot;</span><span class="p">),</span>
            <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;The number of attempts a student get on this &#39;</span>
                <span class="s">&#39;assignment. This is not a hard limit, but it makes the &#39;</span>
                <span class="s">&#39;work of the examiners easier because the system will &#39;</span> 
                <span class="s">&#39;close groups (leaving students unable to deliver more &#39;</span>
                <span class="s">&#39;attempts) when they have this many published feedbacks. &#39;</span>
                <span class="s">&#39;Examiners can open closed groups, and they are notified &#39;</span>
                <span class="s">&#39;when a group is automatically closed. Leave this &#39;</span>
                <span class="s">&#39;empty if you do not want to use this feature.&#39;</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">q_published</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">publishing_time__lt</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">active</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">parentnode__end_time__gte</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">old</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">parentnode__end_time__lt</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">q</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">q_is_candidate</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">(</span><span class="n">assignmentgroups__candidates__student</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_maxpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gradeplugincls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_gradeplugin_registryitem</span><span class="p">()</span><span class="o">.</span><span class="n">model_cls</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gradeplugincls</span><span class="o">.</span><span class="n">get_maxpoints</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gradeplugincls</span><span class="o">.</span><span class="n">get_maxpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_scalepoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignmentgroups</span><span class="o">.</span><span class="n">iterator</span><span class="p">():</span>
            <span class="n">group</span><span class="o">.</span><span class="n">scaled_points</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">_get_scaled_points</span><span class="p">()</span>
            <span class="n">group</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<div class="viewcode-block" id="Assignment.save"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Assignment.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Save and recalculate the value of :attr:`maxpoints` and</span>
<span class="sd">        :attr:`pointscale`. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_maxpoints</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoscale</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pointscale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxpoints</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Assignment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_scalepoints</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Assignment.get_gradeplugin_registryitem"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Assignment.get_gradeplugin_registryitem">[docs]</a>    <span class="k">def</span> <span class="nf">get_gradeplugin_registryitem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the :class:`devilry.core.gradeplugin.RegistryItem`</span>
<span class="sd">        for the current :attr:`grade_plugin`. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">gradeplugin</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grade_plugin</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Assignment.validate_gradeplugin"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Assignment.validate_gradeplugin">[docs]</a>    <span class="k">def</span> <span class="nf">validate_gradeplugin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check if grade plugin is valid (exists). </span>
<span class="sd">        Raise :exc:`devilry.core.gradeplugin.GradePluginDoesNotExistError`</span>
<span class="sd">        on error. &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_gradeplugin_registryitem</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">gradeplugin</span><span class="o">.</span><span class="n">GradePluginDoesNotExistError</span><span class="p">(</span>
                <span class="s">&#39;Invalid grade plugin &quot;</span><span class="si">%s</span><span class="s">&quot; on assignment: </span><span class="si">%s</span><span class="s">. This is &#39;</span>\
                <span class="s">&#39;usually because a grade plugin has been removed from &#39;</span>\
                <span class="s">&#39;the INSTALLED_APPS setting. There is no easy fix for &#39;</span>\
                <span class="s">&#39;this except to re-enable the missing grade plugin.&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">grade_plugin</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Assignment.get_filenames"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Assignment.get_filenames">[docs]</a>    <span class="k">def</span> <span class="nf">get_filenames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the filenames as a list of strings. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Assignment.validate_filenames"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Assignment.validate_filenames">[docs]</a>    <span class="k">def</span> <span class="nf">validate_filenames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filenames</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Raise ValueError unless each filename in the iterable</span>
<span class="sd">        ``filenames`` is one of the filenames on this assignment. Nothing is</span>
<span class="sd">        done if :attr:`filenames` is not set, or set to a empty string. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filenames</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">valid</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Invalid filename: </span><span class="si">%(filename)s</span><span class="s">&quot;</span> <span class="o">%</span>
                        <span class="nb">dict</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)))</span>
</div>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">q_is_admin</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">(</span><span class="n">admins</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span> <span class="o">|</span> \
                <span class="n">Q</span><span class="p">(</span><span class="n">parentnode__admins</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span> <span class="o">|</span> \
                <span class="n">Q</span><span class="p">(</span><span class="n">parentnode__parentnode__admins</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span> <span class="o">|</span> \
                <span class="n">Q</span><span class="p">(</span><span class="n">parentnode__parentnode__parentnode__pk__in</span><span class="o">=</span><span class="n">Node</span><span class="o">.</span><span class="n">_get_nodepks_where_isadmin</span><span class="p">(</span><span class="n">user_obj</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">q_is_examiner</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">(</span><span class="n">assignmentgroups__examiners</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Assignment.get_by_path"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Assignment.get_by_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_by_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get a Assignment by path.</span>

<span class="sd">        Raises :exc:`Assignment.DoesNotExist` if the query does not match.</span>
<span class="sd">        Raises :exc:`ValueError` if the path does not contain exactly three</span>
<span class="sd">        path-elements (uses :func:`splitpath`).</span>
<span class="sd">        </span>
<span class="sd">        :param path:</span>
<span class="sd">            The path to a Assignment, like ``&#39;inf1100.spring09.oblig1&#39;``.</span>
<span class="sd">        :return: A Assignment-object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subject</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">assignment</span> <span class="o">=</span> <span class="n">splitpath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">expected_len</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">parentnode__parentnode__short_name</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span>
                <span class="n">parentnode__short_name</span><span class="o">=</span><span class="n">period</span><span class="p">,</span>
                <span class="n">short_name</span><span class="o">=</span><span class="n">assignment</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Assignment.assignment_groups_where_is_examiner"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Assignment.assignment_groups_where_is_examiner">[docs]</a>    <span class="k">def</span> <span class="nf">assignment_groups_where_is_examiner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get all assignment groups within this assignment where the given</span>
<span class="sd">        ``user_obj`` is examiner.</span>
<span class="sd">        </span>
<span class="sd">        :param user_obj: A django.contrib.auth.models.User_ object.</span>
<span class="sd">        :rtype: QuerySet</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignmentgroups</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Q</span><span class="p">(</span><span class="n">examiners</span><span class="o">=</span><span class="n">user_obj</span><span class="p">))</span>
    </div>
<div class="viewcode-block" id="Assignment.assignment_groups_where_can_examine"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Assignment.assignment_groups_where_can_examine">[docs]</a>    <span class="k">def</span> <span class="nf">assignment_groups_where_can_examine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get all assignment groups within this assignment where the given</span>
<span class="sd">        ``user_obj`` is examiner or admin. If the user is superadmin, all</span>
<span class="sd">        assignments are returned.</span>
<span class="sd">        </span>
<span class="sd">        :param user_obj: A django.contrib.auth.models.User_ object.</span>
<span class="sd">        :rtype: QuerySet</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_obj</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignmentgroups</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignmentgroups</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Q</span><span class="p">(</span><span class="n">examiners</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span> <span class="o">|</span>
                <span class="n">Q</span><span class="p">(</span><span class="n">parentnode__admins</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span> <span class="o">|</span>
                <span class="n">Q</span><span class="p">(</span><span class="n">parentnode__parentnode__admins</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span> <span class="o">|</span>
                <span class="n">Q</span><span class="p">(</span><span class="n">parentnode__parentnode__parentnode__admins</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span> <span class="o">|</span>
                <span class="n">Q</span><span class="p">(</span><span class="n">parentnode__parentnode__parentnode__parentnode__pk__in</span><span class="o">=</span><span class="n">Node</span><span class="o">.</span><span class="n">_get_nodepks_where_isadmin</span><span class="p">(</span><span class="n">user_obj</span><span class="p">)))</span>
            </div>
<div class="viewcode-block" id="Assignment.clean"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Assignment.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate the assignment.</span>

<span class="sd">        Always call this before save()! Read about validation here:</span>
<span class="sd">        http://docs.djangoproject.com/en/dev/ref/models/instances/#id1</span>

<span class="sd">        Raises ValidationError if ``publishing_time`` is not between</span>
<span class="sd">        :attr:`Period.start_time` and ``Period.end_time``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Assignment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">publishing_time</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">publishing_time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">start_time</span>  <span class="ow">or</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">publishing_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">end_time</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s">&quot;Publishing time must be within it&#39;s period (</span><span class="si">%(period)s</span><span class="s">).&quot;</span>
                      <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span><span class="p">))))</span>

</div></div>
<div class="viewcode-block" id="Candidate"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Candidate">[docs]</a><span class="k">class</span> <span class="nc">Candidate</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    .. attribute:: assignment_group</span>

<span class="sd">        The :class:`AssignmentGroup` where this groups belongs.</span>

<span class="sd">    .. attribute:: student</span>

<span class="sd">        A student (a foreign key to a User).</span>

<span class="sd">    .. attribute:: candidate_id</span>

<span class="sd">        A optional candidate id. This can be anything as long as it is not</span>
<span class="sd">        more than 30 characters. When the assignment is anonymous, this is</span>
<span class="sd">        the &quot;name&quot; shown to examiners instead of the username of the</span>
<span class="sd">        student.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">student</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
    <span class="n">assignment_group</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;AssignmentGroup&#39;</span><span class="p">,</span>
            <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;candidates&#39;</span><span class="p">)</span>

    <span class="c"># TODO unique within assignment as an option.</span>
    <span class="n">candidate_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
<div class="viewcode-block" id="Candidate.get_identifier"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Candidate.get_identifier">[docs]</a>    <span class="k">def</span> <span class="nf">get_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gives the identifier of the candidate. When the Assignment is anyonymous</span>
<span class="sd">        the candidate_id is returned. Else, the student name is returned. This </span>
<span class="sd">        method should always be used when retrieving the candidate identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_group</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">anonymous</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">candidate_id</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">candidate_id</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;candidate-id missing&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">candidate_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">student</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>

    </div>
    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_identifier</span><span class="p">()</span>

<div class="viewcode-block" id="Candidate.clean"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Candidate.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate the assignment.</span>

<span class="sd">        Always call this before save()! Read about validation here:</span>
<span class="sd">        http://docs.djangoproject.com/en/dev/ref/models/instances/#id1</span>

<span class="sd">        Raises ValidationError if:</span>

<span class="sd">            - candidate id is empty on anonymous assignment.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_group</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">anonymous</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">candidate_id</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s">&quot;Candidate id cannot be empty when assignment is anonymous.)&quot;</span><span class="p">))</span>
        
        <span class="nb">super</span><span class="p">(</span><span class="n">Candidate</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>



<span class="c"># TODO: Constraint: cannot be examiner and student on the same assignmentgroup as an option.</span></div></div>
<div class="viewcode-block" id="AssignmentGroup"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup">[docs]</a><span class="k">class</span> <span class="nc">AssignmentGroup</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">AbstractIsAdmin</span><span class="p">,</span> <span class="n">AbstractIsExaminer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a student or a group of students. </span>


<span class="sd">    .. attribute:: parentnode</span>

<span class="sd">        A django.db.models.ForeignKey_ that points to the parent node,</span>
<span class="sd">        which is always an `Assignment`_.</span>

<span class="sd">    .. attribute:: name</span>

<span class="sd">        A optional name for the group.</span>

<span class="sd">    .. attribute:: candidates</span>

<span class="sd">        A django ``RelatedManager`` that holds the :class:`candidates</span>
<span class="sd">        &lt;Candidate&gt;` on this group.</span>

<span class="sd">    .. attribute:: examiners</span>

<span class="sd">        A django.db.models.ManyToManyField_ that holds the examiner(s) that are</span>
<span class="sd">        to correct and grade the assignment.</span>

<span class="sd">    .. attribute:: is_open</span>

<span class="sd">        A django.db.models.BooleanField_ that tells you if the group can add</span>
<span class="sd">        deliveries or not.</span>

<span class="sd">    .. attribute:: deliveries</span>

<span class="sd">        A set of deliveries for this assignmentgroup </span>

<span class="sd">    .. attribute:: deadlines</span>

<span class="sd">        A set of deadlines for this assignmentgroup </span>

<span class="sd">    .. attribute:: status</span>

<span class="sd">        Stores data that can be deduces from other data in the database, but</span>
<span class="sd">        since this requires complex queries, we store it as a integer</span>
<span class="sd">        instead, with the following values:</span>

<span class="sd">            0. No deliveries</span>
<span class="sd">            1. Not corrected</span>
<span class="sd">            2. Corrected, not published</span>
<span class="sd">            3. Corrected and published</span>
<span class="sd">                The group has at least one published feedback.</span>

<span class="sd">    .. attribute:: status_mapping</span>

<span class="sd">        Maps :attr:`status` to a translated string for examiners and</span>
<span class="sd">        admins. ``status_mapping[0]`` contains a localized version of ``&quot;No</span>
<span class="sd">        deliveries&quot;``, and so on.</span>

<span class="sd">    .. attribute:: status_mapping_student</span>

<span class="sd">        Maps :attr:`status` to a translated string for students. The same as</span>
<span class="sd">        :attr:`status_mapping` except that ``status_mapping_student[2]``</span>
<span class="sd">        contains ``&quot;Not corrected&quot;``, and ``status_mapping_student[3]``</span>
<span class="sd">        contains ``&quot;Corrected&quot;``. This is because the student should never</span>
<span class="sd">        know about unpublished feedback.</span>

<span class="sd">    .. attribute:: points</span>

<span class="sd">        The number of points this group got on their latest published</span>
<span class="sd">        delivery. This fields is only updated when a published feedback</span>
<span class="sd">        is saved.</span>

<span class="sd">    .. attribute:: scaled_points</span>

<span class="sd">        The :attr:`points` of this group scaled according to</span>
<span class="sd">        :attr:`Assignment.pointscale` and :attr:`Assignment.maxpoints`.</span>

<span class="sd">        Calculated as: `float(pointscale)/maxpoints * points`.</span>

<span class="sd">        **Note:** This field is a cache for the calculation above.</span>

<span class="sd">    .. attribute:: NO_DELIVERIES</span>

<span class="sd">        The numberic value corresponding to :attr:`status` *no deliveries*.</span>

<span class="sd">    .. attribute:: NOT_CORRECTED</span>

<span class="sd">        The numberic value corresponding to :attr:`status` *not corrected*.</span>

<span class="sd">    .. attribute:: CORRECTED_NOT_PUBLISHED</span>

<span class="sd">        The numberic value corresponding to :attr:`status` *corrected, not</span>
<span class="sd">        published*.</span>

<span class="sd">    .. attribute:: CORRECTED_AND_PUBLISHED</span>

<span class="sd">        The numberic value corresponding to :attr:`status` *corrected, and</span>
<span class="sd">        published*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">status_mapping</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_</span><span class="p">(</span><span class="s">&quot;No deliveries&quot;</span><span class="p">),</span>
        <span class="n">_</span><span class="p">(</span><span class="s">&quot;Not corrected&quot;</span><span class="p">),</span>
        <span class="n">_</span><span class="p">(</span><span class="s">&quot;Corrected, not published&quot;</span><span class="p">),</span>
        <span class="n">_</span><span class="p">(</span><span class="s">&quot;Corrected and published&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">status_mapping_student</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">status_mapping</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">status_mapping</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">status_mapping</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="c"># &quot;not published&quot; means not &quot;not corrected&quot; is displayed to student</span>
        <span class="n">_</span><span class="p">(</span><span class="s">&quot;Corrected&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">status_mapping_cssclass</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_</span><span class="p">(</span><span class="s">&quot;status_no_deliveries&quot;</span><span class="p">),</span>
        <span class="n">_</span><span class="p">(</span><span class="s">&quot;status_not_corrected&quot;</span><span class="p">),</span>
        <span class="n">_</span><span class="p">(</span><span class="s">&quot;status_corrected_not_published&quot;</span><span class="p">),</span>
        <span class="n">_</span><span class="p">(</span><span class="s">&quot;status_corrected_and_published&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">status_mapping_student_cssclass</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">status_mapping_cssclass</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">status_mapping_cssclass</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">status_mapping_cssclass</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="c"># &quot;not published&quot; means not &quot;not corrected&quot; is displayed to student</span>
        <span class="n">status_mapping_cssclass</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">NO_DELIVERIES</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">NOT_CORRECTED</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">CORRECTED_NOT_PUBLISHED</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">CORRECTED_AND_PUBLISHED</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="n">parentnode</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Assignment</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;assignmentgroups&#39;</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">examiners</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">related_name</span><span class="o">=</span><span class="s">&quot;examiners&quot;</span><span class="p">)</span>
    <span class="n">is_open</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">help_text</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;If this is checked, the group can add deliveries.&#39;</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span>
            <span class="n">default</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">choices</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">status_mapping</span><span class="p">),</span>
            <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Status&#39;</span><span class="p">))</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Final number of points for this group. This &#39;</span>\
                <span class="s">&#39;number is controlled by the grade plugin, and should not &#39;</span>\
                <span class="s">&#39;be changed manually.&#39;</span><span class="p">))</span>
    <span class="n">scaled_points</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">is_passing_grade</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">_get_scaled_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">pointscale</span><span class="p">)</span>
        <span class="n">maxpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">maxpoints</span>
        <span class="k">if</span> <span class="n">maxpoints</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">scale</span><span class="o">/</span><span class="n">maxpoints</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaled_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_scaled_points</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AssignmentGroup</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">q_is_admin</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">(</span><span class="n">parentnode__admins</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span> <span class="o">|</span> \
                <span class="n">Q</span><span class="p">(</span><span class="n">parentnode__parentnode__admins</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span> <span class="o">|</span> \
                <span class="n">Q</span><span class="p">(</span><span class="n">parentnode__parentnode__parentnode__admins</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span> <span class="o">|</span> \
                <span class="n">Q</span><span class="p">(</span><span class="n">parentnode__parentnode__parentnode__parentnode__pk__in</span><span class="o">=</span><span class="n">Node</span><span class="o">.</span><span class="n">_get_nodepks_where_isadmin</span><span class="p">(</span><span class="n">user_obj</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="AssignmentGroup.q_is_candidate"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.q_is_candidate">[docs]</a>    <span class="k">def</span> <span class="nf">q_is_candidate</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a django.models.Q object matching AssignmentGroups where</span>
<span class="sd">        the given student is candidate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">(</span><span class="n">candidates__student</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="AssignmentGroup.where_is_candidate"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.where_is_candidate">[docs]</a>    <span class="k">def</span> <span class="nf">where_is_candidate</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a QuerySet matching all AssignmentGroups where the</span>
<span class="sd">        given user is student.</span>
<span class="sd">        </span>
<span class="sd">        :param user_obj: A django.contrib.auth.models.User_ object.</span>
<span class="sd">        :rtype: QuerySet</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">AssignmentGroup</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">q_is_candidate</span><span class="p">(</span><span class="n">user_obj</span><span class="p">))</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="AssignmentGroup.published_where_is_candidate"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.published_where_is_candidate">[docs]</a>    <span class="k">def</span> <span class="nf">published_where_is_candidate</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a QuerySet matching all :ref:`published</span>
<span class="sd">        &lt;assignment-classifications&gt;` assignment groups where the given user</span>
<span class="sd">        is student.</span>
<span class="sd">        </span>
<span class="sd">        :param user_obj: A django.contrib.auth.models.User_ object.</span>
<span class="sd">        :rtype: QuerySet</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">AssignmentGroup</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">q_is_candidate</span><span class="p">(</span><span class="n">user_obj</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">q_published</span><span class="p">(</span><span class="n">old</span><span class="o">=</span><span class="n">old</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="n">active</span><span class="p">))</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="AssignmentGroup.active_where_is_candidate"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.active_where_is_candidate">[docs]</a>    <span class="k">def</span> <span class="nf">active_where_is_candidate</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a QuerySet matching all :ref:`active</span>
<span class="sd">        &lt;assignment-classifications&gt;` assignment groups where the given user</span>
<span class="sd">        is student.</span>

<span class="sd">        :param user_obj: A django.contrib.auth.models.User_ object.</span>
<span class="sd">        :rtype: QuerySet</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">published_where_is_candidate</span><span class="p">(</span><span class="n">user_obj</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="AssignmentGroup.old_where_is_candidate"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.old_where_is_candidate">[docs]</a>    <span class="k">def</span> <span class="nf">old_where_is_candidate</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a QuerySet matching all :ref:`old</span>
<span class="sd">        &lt;assignment-classifications&gt;` assignment groups where the given user</span>
<span class="sd">        is student.</span>

<span class="sd">        :param user_obj: A django.contrib.auth.models.User_ object.</span>
<span class="sd">        :rtype: QuerySet</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">published_where_is_candidate</span><span class="p">(</span><span class="n">user_obj</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

</div>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">q_published</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">parentnode__publishing_time__lt</span> <span class="o">=</span> <span class="n">now</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">active</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">parentnode__parentnode__end_time__gte</span> <span class="o">=</span> <span class="n">now</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">old</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">parentnode__parentnode__end_time__lt</span> <span class="o">=</span> <span class="n">now</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">q</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">q_is_examiner</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">(</span><span class="n">examiners</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">u&#39;</span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">get_path</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_candidates</span><span class="p">())</span>
    
<div class="viewcode-block" id="AssignmentGroup.get_students"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.get_students">[docs]</a>    <span class="k">def</span> <span class="nf">get_students</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get a string containing all students in the group separated by</span>
<span class="sd">        comma and a space, like: ``superman, spiderman, batman``.</span>

<span class="sd">        **WARNING:** You should never use this method when the user is not</span>
<span class="sd">        an administrator. Use :meth:`get_candidates`</span>
<span class="sd">        instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">u&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">student</span><span class="o">.</span><span class="n">username</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">candidates</span><span class="o">.</span><span class="n">all</span><span class="p">()])</span></div>
    <span class="n">get_students</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Students&#39;</span><span class="p">)</span>
 
<div class="viewcode-block" id="AssignmentGroup.get_candidates"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.get_candidates">[docs]</a>    <span class="k">def</span> <span class="nf">get_candidates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get a string containing all candiates in the group separated by</span>
<span class="sd">        comma and a space, like: ``superman, spiderman, batman`` for normal</span>
<span class="sd">        assignments, and something like: ``321, 1533, 111`` for anonymous</span>
<span class="sd">        assignments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">u&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">get_identifier</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">candidates</span><span class="o">.</span><span class="n">all</span><span class="p">()])</span></div>
    <span class="n">get_students</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Students&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="AssignmentGroup.get_examiners"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.get_examiners">[docs]</a>    <span class="k">def</span> <span class="nf">get_examiners</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get a string contaning all examiners in the group separated by</span>
<span class="sd">        comma (``&#39;,&#39;``). &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">u&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">u</span><span class="o">.</span><span class="n">username</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">examiners</span><span class="o">.</span><span class="n">all</span><span class="p">()])</span></div>
    <span class="n">get_examiners</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Examiners&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">is_admin</span><span class="p">(</span><span class="n">user_obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_candidate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">candidates</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">student</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>

<div class="viewcode-block" id="AssignmentGroup.is_examiner"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.is_examiner">[docs]</a>    <span class="k">def</span> <span class="nf">is_examiner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return True if user is examiner on this assignment group &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">examiners</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">user_obj</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="AssignmentGroup.can_examine"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.can_examine">[docs]</a>    <span class="k">def</span> <span class="nf">can_examine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return True if the user has permission to examine (creeate</span>
<span class="sd">        feedback and browse files) on this assignment group.</span>
<span class="sd">        </span>
<span class="sd">        Examiners, admins and superusers has this permission. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">user_obj</span><span class="o">.</span><span class="n">is_superuser</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_admin</span><span class="p">(</span><span class="n">user_obj</span><span class="p">)</span> \
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_examiner</span><span class="p">(</span><span class="n">user_obj</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AssignmentGroup.get_localized_status"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.get_localized_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_localized_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the current status string from :attr:`status_mapping`. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_mapping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="AssignmentGroup.get_localized_student_status"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.get_localized_student_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_localized_student_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the current status string from</span>
<span class="sd">        :attr:`status_mapping_student`. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_mapping_student</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="AssignmentGroup.get_status_cssclass"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.get_status_cssclass">[docs]</a>    <span class="k">def</span> <span class="nf">get_status_cssclass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the current status string from</span>
<span class="sd">        :attr:`status_mapping_cssclass`. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_mapping_cssclass</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="AssignmentGroup.get_status_student_cssclass"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.get_status_student_cssclass">[docs]</a>    <span class="k">def</span> <span class="nf">get_status_student_cssclass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the current status string from</span>
<span class="sd">        :attr:`status_mapping_student_cssclass`. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_mapping_student_cssclass</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">]</span>
</div>
    <span class="k">def</span> <span class="nf">_get_status_from_qry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">NO_DELIVERIES</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">feedback__isnull</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">qry</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">NOT_CORRECTED</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qry</span> <span class="o">=</span> <span class="n">qry</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">feedback__published</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">qry</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">CORRECTED_NOT_PUBLISHED</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">CORRECTED_AND_PUBLISHED</span>

    <span class="k">def</span> <span class="nf">_update_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Query for the correct status, and set :attr:`status`. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_status_from_qry</span><span class="p">()</span>

<div class="viewcode-block" id="AssignmentGroup.get_number_of_deliveries"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.get_number_of_deliveries">[docs]</a>    <span class="k">def</span> <span class="nf">get_number_of_deliveries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the number of deliveries by this assignment group. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="AssignmentGroup.get_latest_delivery"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.get_latest_delivery">[docs]</a>    <span class="k">def</span> <span class="nf">get_latest_delivery</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the latest delivery by this assignment group,</span>
<span class="sd">        or ``None`` if there is no deliveries. &quot;&quot;&quot;</span>
        <span class="n">qry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">qry</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">qry</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                    <span class="n">models</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;time_of_delivery&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="AssignmentGroup.get_latest_delivery_with_feedback"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.get_latest_delivery_with_feedback">[docs]</a>    <span class="k">def</span> <span class="nf">get_latest_delivery_with_feedback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the latest delivery by this assignment group with feedback,</span>
<span class="sd">        or ``None`` if there is no deliveries with feedback. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">feedback__isnull</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">qry</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">qry</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                        <span class="n">models</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;time_of_delivery&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="AssignmentGroup.get_deliveries_with_published_feedback"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.get_deliveries_with_published_feedback">[docs]</a>    <span class="k">def</span> <span class="nf">get_deliveries_with_published_feedback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the the deliveries by this assignment group which have</span>
<span class="sd">        published feedback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">feedback__published</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AssignmentGroup.get_latest_delivery_with_published_feedback"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.get_latest_delivery_with_published_feedback">[docs]</a>    <span class="k">def</span> <span class="nf">get_latest_delivery_with_published_feedback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the latest delivery with published feedback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_deliveries_with_published_feedback</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                <span class="s">&#39;-time_of_delivery&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</div>
    <span class="k">def</span> <span class="nf">_get_gradeplugin_cached_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_latest_delivery_with_published_feedback</span><span class="p">()</span>
        <span class="n">points</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">must_pass</span><span class="p">:</span>
            <span class="n">is_passing_grade</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">is_passing_grade</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">feedback</span><span class="o">.</span><span class="n">get_grade</span><span class="p">()</span><span class="o">.</span><span class="n">is_passing_grade</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is_passing_grade</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">feedback</span><span class="o">.</span><span class="n">grade</span><span class="o">.</span><span class="n">get_points</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">is_passing_grade</span>

    <span class="k">def</span> <span class="nf">update_gradeplugin_cached_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_passing_grade</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gradeplugin_cached_fields</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<div class="viewcode-block" id="AssignmentGroup.get_grade_as_short_string"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.get_grade_as_short_string">[docs]</a>    <span class="k">def</span> <span class="nf">get_grade_as_short_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the grade as a &quot;short string&quot;. &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_latest_delivery_with_published_feedback</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">feedback</span><span class="o">.</span><span class="n">get_grade_as_short_string</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="AssignmentGroup.can_save"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.can_save">[docs]</a>    <span class="k">def</span> <span class="nf">can_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check if the user has permission to save this AssignmentGroup. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_obj</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">is_admin</span><span class="p">(</span><span class="n">user_obj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    </div>
<div class="viewcode-block" id="AssignmentGroup.can_add_deliveries"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.can_add_deliveries">[docs]</a>    <span class="k">def</span> <span class="nf">can_add_deliveries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns true if a student can add deliveries on this assignmengroup</span>
<span class="sd">        </span>
<span class="sd">        Both the assignmentgroups is_open attribute, and the periods start</span>
<span class="sd">        and end time is checked.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_open</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">is_active</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="AssignmentGroup.get_active_deadline"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.AssignmentGroup.get_active_deadline">[docs]</a>    <span class="k">def</span> <span class="nf">get_active_deadline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the active deadline.</span>
<span class="sd">            </span>
<span class="sd">        :return:</span>
<span class="sd">            Latest deadline, or None if no deadline is set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">deadlines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deadlines</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-deadline&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">deadlines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">deadlines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

</div></div>
<div class="viewcode-block" id="Deadline"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Deadline">[docs]</a><span class="k">class</span> <span class="nc">Deadline</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    .. attribute:: assignment_group</span>

<span class="sd">        The assignment group where the deadline is registered.</span>

<span class="sd">    .. attribute:: deadline</span>

<span class="sd">        The deadline a DateTimeField.</span>

<span class="sd">    .. attribute:: text</span>

<span class="sd">        A optional deadline text.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">assignment_group</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">AssignmentGroup</span><span class="p">,</span>
            <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;deadlines&#39;</span><span class="p">)</span> 
    <span class="n">deadline</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">()</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Deadline&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Deadlines&#39;</span><span class="p">)</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-deadline&#39;</span><span class="p">]</span>
    
<div class="viewcode-block" id="Deadline.clean"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Deadline.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate the deadline.</span>

<span class="sd">        Always call this before save()! Read about validation here:</span>
<span class="sd">        http://docs.djangoproject.com/en/dev/ref/models/instances/#id1</span>

<span class="sd">        Raises ValidationError if:</span>

<span class="sd">            - ``deadline`` is before ``Assignment.publishing_time``. </span>
<span class="sd">            - ``deadline`` is not before ``Period.end_time``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deadline</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deadline</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_group</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">publishing_time</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Deadline cannot be before publishing time.&#39;</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deadline</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_group</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">end_time</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s">&quot;Deadline must be within it&#39;s period (</span><span class="si">%(period)s</span><span class="s">).&quot;</span>
                      <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_group</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">parentnode</span><span class="p">))))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Deadline</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deadline</span><span class="p">)</span>

<div class="viewcode-block" id="Deadline.is_old"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Deadline.is_old">[docs]</a>    <span class="k">def</span> <span class="nf">is_old</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return True if :attr:`deadline` expired. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">deadline</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>


<span class="c"># TODO: Constraint: Can only be delivered by a person in the assignment group?</span>
<span class="c">#                   Or maybe an administrator?</span></div></div>
<div class="viewcode-block" id="Delivery"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Delivery">[docs]</a><span class="k">class</span> <span class="nc">Delivery</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">AbstractIsAdmin</span><span class="p">,</span> <span class="n">AbstractIsCandidate</span><span class="p">,</span> <span class="n">AbstractIsExaminer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A class representing a given delivery from an `AssignmentGroup`_.</span>


<span class="sd">    .. attribute:: assignment_group</span>

<span class="sd">        A django.db.models.ForeignKey_ pointing to the `AssignmentGroup`_</span>
<span class="sd">        that handed in the Delivery.</span>

<span class="sd">    .. attribute:: time_of_delivery</span>

<span class="sd">        A django.db.models.DateTimeField_ that holds the date and time the</span>
<span class="sd">        Delivery was uploaded.</span>

<span class="sd">    .. attribute:: number</span>

<span class="sd">        A django.db.models.PositiveIntegerField with the delivery-number</span>
<span class="sd">        within this assignment-group. This number is automatically</span>
<span class="sd">        incremented within each assignmentgroup, starting from 1. Must be</span>
<span class="sd">        unique within the assignment-group. Automatic incrementation is used</span>
<span class="sd">        if number is None when calling :meth:`save` (or :meth:`begin`).</span>

<span class="sd">    .. attribute:: delivered_by</span>

<span class="sd">        A django.db.models.ForeignKey_ pointing to the user that uploaded</span>
<span class="sd">        the Delivery</span>

<span class="sd">    .. attribute:: successful</span>

<span class="sd">        A django.db.models.BooleanField_ telling whether or not the Delivery</span>
<span class="sd">        was successfully uploaded.</span>

<span class="sd">    .. attribute:: filemetas</span>

<span class="sd">        A set of filemetas for this delivery.</span>

<span class="sd">    .. attribute:: feedback</span>

<span class="sd">       A django.db.models.OneToOneField to Feedback.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">assignment_group</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">AssignmentGroup</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;deliveries&#39;</span><span class="p">)</span>
    <span class="n">time_of_delivery</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">()</span>
    <span class="n">number</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">()</span>
    <span class="n">delivered_by</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">)</span> <span class="c"># TODO: should be candidate!</span>
    <span class="n">successful</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Delivery&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Deliveries&#39;</span><span class="p">)</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-time_of_delivery&#39;</span><span class="p">]</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;assignment_group&#39;</span><span class="p">,</span> <span class="s">&#39;number&#39;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Delivery.q_is_candidate"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Delivery.q_is_candidate">[docs]</a>    <span class="k">def</span> <span class="nf">q_is_candidate</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a django.models.Q object matching Deliveries where</span>
<span class="sd">        the given student is candidate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">(</span><span class="n">assignment_group__candidates__student</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span>
    </div>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">q_published</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">assignment_group__parentnode__publishing_time__lt</span> <span class="o">=</span> <span class="n">now</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">active</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">assignment_group__parentnode__parentnode__end_time__gte</span> <span class="o">=</span> <span class="n">now</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">old</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">assignment_group__parentnode__parentnode__end_time__lt</span> <span class="o">=</span> <span class="n">now</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">q</span>

    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">q_is_admin</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">(</span><span class="n">assignment_group__parentnode__admins</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span> <span class="o">|</span> \
                <span class="n">Q</span><span class="p">(</span><span class="n">assignment_group__parentnode__parentnode__admins</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span> <span class="o">|</span> \
                <span class="n">Q</span><span class="p">(</span><span class="n">assignment_group__parentnode__parentnode__parentnode__admins</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span> <span class="o">|</span> \
                <span class="n">Q</span><span class="p">(</span><span class="n">assignment_group__parentnode__parentnode__parentnode__parentnode__pk__in</span><span class="o">=</span><span class="n">Node</span><span class="o">.</span><span class="n">_get_nodepks_where_isadmin</span><span class="p">(</span><span class="n">user_obj</span><span class="p">))</span> \

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">q_is_examiner</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">(</span><span class="n">assignment_group__examiners</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Delivery.begin"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Delivery.begin">[docs]</a>    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">assignment_group</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Begin delivery.</span>

<span class="sd">        Creates a delivery with ``time_of_delivery`` set to current time,</span>
<span class="sd">        ``delivered_by`` set to the given ``user_obj``, ``assignment_group``</span>
<span class="sd">        set to the given ``assignment_group`` and successful set to</span>
<span class="sd">        ``false``.</span>

<span class="sd">        This should be followed up by one or more calls to :meth:`add_file`</span>
<span class="sd">        on the returned FileMeta-object, and completed by calling</span>
<span class="sd">        :meth:`finish`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">Delivery</span><span class="p">()</span>
        <span class="n">d</span><span class="o">.</span><span class="n">assignment_group</span> <span class="o">=</span> <span class="n">assignment_group</span>
        <span class="n">d</span><span class="o">.</span><span class="n">time_of_delivery</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">d</span><span class="o">.</span><span class="n">delivered_by</span> <span class="o">=</span> <span class="n">user_obj</span>
        <span class="n">d</span><span class="o">.</span><span class="n">successful</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">d</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">d</span>
</div>
<div class="viewcode-block" id="Delivery.add_file"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Delivery.add_file">[docs]</a>    <span class="k">def</span> <span class="nf">add_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">iterable_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add a file to the delivery.</span>
<span class="sd">        </span>
<span class="sd">        :param filename:</span>
<span class="sd">            A filename as defined in :class:`FileMeta`.</span>
<span class="sd">        :param iterable_data:</span>
<span class="sd">            A iterable yielding data that can be written to file using the</span>
<span class="sd">            write() method of a storage backend (byte strings).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filemeta</span> <span class="o">=</span> <span class="n">FileMeta</span><span class="p">()</span>
        <span class="n">filemeta</span><span class="o">.</span><span class="n">delivery</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">filemeta</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">filemeta</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">filemeta</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">FileMeta</span><span class="o">.</span><span class="n">deliverystore</span><span class="o">.</span><span class="n">write_open</span><span class="p">(</span><span class="n">filemeta</span><span class="p">)</span>
        <span class="n">filemeta</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">iterable_data</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">filemeta</span><span class="o">.</span><span class="n">size</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">filemeta</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">filemeta</span>
</div>
<div class="viewcode-block" id="Delivery.finish"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Delivery.finish">[docs]</a>    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Finish the delivery by updating the time of delivery, marking it</span>
<span class="sd">        as successful and saving. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_of_delivery</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">successful</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Delivery.get_feedback"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Delivery.get_feedback">[docs]</a>    <span class="k">def</span> <span class="nf">get_feedback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the feedback for this delivery. If the feedback does not</span>
<span class="sd">        exists, a new :class:`Feedback`-object is created but not saved.</span>

<span class="sd">        :return:</span>
<span class="sd">            A :class:`Feedback`-object with the delivery-attribute set</span>
<span class="sd">            to this delivery.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span>
        <span class="k">except</span> <span class="n">Feedback</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Feedback</span><span class="p">(</span><span class="n">delivery</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Delivery.get_status_number"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Delivery.get_status_number">[docs]</a>    <span class="k">def</span> <span class="nf">get_status_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the numeric status for this delivery.</span>

<span class="sd">        :return: The numeric status:</span>
<span class="sd">            :attr:`AssignmentGroup.NOT_CORRECTED`,</span>
<span class="sd">            :attr:`AssignmentGroup.CORRECTED_NOT_PUBLISHED` or</span>
<span class="sd">            :attr:`AssignmentGroup.CORRECTED_AND_PUBLISHED`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span><span class="o">.</span><span class="n">published</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">AssignmentGroup</span><span class="o">.</span><span class="n">CORRECTED_AND_PUBLISHED</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">AssignmentGroup</span><span class="o">.</span><span class="n">CORRECTED_NOT_PUBLISHED</span>
        <span class="k">except</span> <span class="n">Feedback</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">AssignmentGroup</span><span class="o">.</span><span class="n">NOT_CORRECTED</span>
</div>
<div class="viewcode-block" id="Delivery.get_localized_status"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Delivery.get_localized_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_localized_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the current status string from</span>
<span class="sd">        :attr:`AssignmentGroup.status_mapping`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_number</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">AssignmentGroup</span><span class="o">.</span><span class="n">status_mapping</span><span class="p">[</span><span class="n">status</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Delivery.get_localized_student_status"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Delivery.get_localized_student_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_localized_student_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the current status string from</span>
<span class="sd">        :attr:`AssignmentGroup.status_mapping_student`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_number</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">AssignmentGroup</span><span class="o">.</span><span class="n">status_mapping_student</span><span class="p">[</span><span class="n">status</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Delivery.get_status_cssclass"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Delivery.get_status_cssclass">[docs]</a>    <span class="k">def</span> <span class="nf">get_status_cssclass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the css class for the current status from</span>
<span class="sd">        :attr:`AssignmentGroup.status_mapping_cssclass`. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">AssignmentGroup</span><span class="o">.</span><span class="n">status_mapping_cssclass</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_status_number</span><span class="p">()]</span>
</div>
<div class="viewcode-block" id="Delivery.get_status_student_cssclass"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Delivery.get_status_student_cssclass">[docs]</a>    <span class="k">def</span> <span class="nf">get_status_student_cssclass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the css class for the current status from</span>
<span class="sd">        :attr:`AssignmentGroup.status_mapping_student_cssclass`. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">AssignmentGroup</span><span class="o">.</span><span class="n">status_mapping_student_cssclass</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_status_number</span><span class="p">()]</span>
            </div>
<div class="viewcode-block" id="Delivery.save"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Delivery.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set :attr:`number` automatically to one greater than what is was</span>
<span class="sd">        last.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">Delivery</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">assignment_group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_group</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
                            <span class="n">Max</span><span class="p">(</span><span class="s">&#39;number&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s">&#39;number__max&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Delivery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">u&#39;</span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_group</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                <span class="n">date_format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_of_delivery</span><span class="p">,</span> <span class="s">&quot;DATETIME_FORMAT&quot;</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="Feedback"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Feedback">[docs]</a><span class="k">class</span> <span class="nc">Feedback</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">AbstractIsExaminer</span><span class="p">,</span> <span class="n">AbstractIsCandidate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents the feedback for a given `Delivery`_.</span>

<span class="sd">    Typical usage for manual manipulation of feedbacks (in tests and xmlrpc)::</span>

<span class="sd">        test = Assignment(</span>
<span class="sd">                parentnode = Period.objects.get(pk=1),</span>
<span class="sd">                publishing_time = datetime.now(),</span>
<span class="sd">                anonymous = False,</span>
<span class="sd">                grade_plugin = &quot;grade_approved:approvedgrade&quot;)</span>
<span class="sd">        group = test.assignmentgroups.create(name=&quot;My group&quot;)</span>
<span class="sd">        delivery = Delivery.begin(group, User.objects.get(username=&quot;student1&quot;))</span>
<span class="sd">        delivery.add_file(&quot;test.txt&quot;, [&quot;test&quot;])</span>
<span class="sd">        delivery.finish()</span>
<span class="sd">        feedback = delivery.get_feedback()</span>
<span class="sd">        feedback.last_modified_by = User.objects.get(username=&quot;examiner1&quot;)</span>
<span class="sd">        feedback.set_grade_from_xmlrpcstring(&quot;approved&quot;)</span>
<span class="sd">        feedback.save()</span>

<span class="sd">    .. attribute:: text</span>

<span class="sd">       A django.db.models.TextField_ that holds the feedback text given by</span>
<span class="sd">       the examiner.</span>

<span class="sd">    .. attribute:: format</span>

<span class="sd">       A django.db.models.CharField_ that holds the format of the feedback</span>
<span class="sd">       text. Valid values are:</span>

<span class="sd">           ``&quot;rst&quot;``</span>
<span class="sd">               Format feedback using restructured text.</span>

<span class="sd">           ``&quot;text&quot;``</span>
<span class="sd">               Plain text - no text formatting.</span>

<span class="sd">    .. attribute:: published</span>

<span class="sd">       A django.db.models.BooleanField_ that tells if the feedback is</span>
<span class="sd">       published or not. This allows editing and saving the feedback before</span>
<span class="sd">       publishing it. Is useful for exams and other assignments when</span>
<span class="sd">       feedback and grading is published simultaneously for all Deliveries.</span>

<span class="sd">    .. attribute:: last_modified_by</span>

<span class="sd">       The django.contrib.auth.models.User_ that last modified the feedback.</span>

<span class="sd">    .. attribute:: last_modified</span>

<span class="sd">       Date/time of last modification.</span>

<span class="sd">    .. attribute:: delivery</span>

<span class="sd">       A django.db.models.OneToOneField_ that points to the `Delivery`_ to</span>
<span class="sd">       be given feedback.</span>

<span class="sd">    .. attribute:: grade</span>
<span class="sd">    </span>
<span class="sd">       A generic relation</span>
<span class="sd">       (django.contrib.contenttypes.generic.GenericForeignKey) to the</span>
<span class="sd">       grade-plugin object storing the grade for this feedback. This will</span>
<span class="sd">       always be a subclass of</span>
<span class="sd">       :class:`devilry.core.gradeplugin.GradeModel`. The</span>
<span class="sd">       :meth:`clean`-method checks that this points to a class of the type</span>
<span class="sd">       defined in :attr:`Assignment.grade_plugin`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">text_formats</span> <span class="o">=</span> <span class="p">(</span>
       <span class="p">(</span><span class="s">&#39;rst&#39;</span><span class="p">,</span> <span class="s">&#39;ReStructured Text&#39;</span><span class="p">),</span>
       <span class="p">(</span><span class="s">&#39;txt&#39;</span><span class="p">,</span> <span class="s">&#39;Plain text&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
            <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Feedback text&#39;</span><span class="p">))</span>
    <span class="n">format</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">text_formats</span><span class="p">,</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">text_formats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Feedback text format&#39;</span><span class="p">),</span>
            <span class="n">help_text</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                <span class="s">&#39;Unless you have problems with &quot;ReStructured Text&quot;, you &#39;</span>\
                <span class="s">&#39;should use it, as it allows you to mark up your &#39;</span> \
                <span class="s">&#39;feedback and thus make it more readable by the student. &#39;</span> \
                <span class="s">&#39;Only use &quot;Plain text&quot; as a fallback/last resort.&#39;</span><span class="p">)</span>
            <span class="p">)</span>
    <span class="n">published</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Published&#39;</span><span class="p">),</span>
            <span class="n">help_text</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                <span class="s">&#39;Check this to make the feedback visible to the student(s).&#39;</span><span class="p">))</span>
    <span class="n">delivery</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span><span class="n">Delivery</span><span class="p">)</span>
    <span class="n">last_modified</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">null</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">last_modified_by</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">content_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">ContentType</span><span class="p">)</span>
    <span class="n">object_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">()</span>
    <span class="n">grade</span> <span class="o">=</span> <span class="n">generic</span><span class="o">.</span><span class="n">GenericForeignKey</span><span class="p">(</span><span class="s">&#39;content_type&#39;</span><span class="p">,</span> <span class="s">&#39;object_id&#39;</span><span class="p">)</span>

    <span class="c"># @classmethod</span>
    <span class="c"># def published_where_is_candidate(cls, user_obj, old=True, active=True):</span>
    <span class="c">#     &quot;&quot;&quot; Returns a QuerySet matching all :ref:`published</span>
    <span class="c">#     &lt;assignment-classifications&gt;` feedbacks where the given user</span>
    <span class="c">#     is student.</span>
        
    <span class="c">#     :param user_obj: A django.contrib.auth.models.User_ object.</span>
    <span class="c">#     :rtype: QuerySet</span>
    <span class="c">#     &quot;&quot;&quot;</span>
    <span class="c">#     return Feedback.objects.filter(</span>
    <span class="c">#             cls.q_is_candidate(user_obj) &amp;</span>
    <span class="c">#             cls.q_published(old=old, active=active))</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Feedback.q_is_candidate"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Feedback.q_is_candidate">[docs]</a>    <span class="k">def</span> <span class="nf">q_is_candidate</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a django.models.Q object matching Deliveries where</span>
<span class="sd">        the given student is candidate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">(</span><span class="n">delivery__assignment_group__candidates__student</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span>
    </div>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">q_published</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">delivery__assignment_group__parentnode__publishing_time__lt</span> <span class="o">=</span> <span class="n">now</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">active</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">deliver__assignment_group__parentnode__parentnode__end_time__gte</span> <span class="o">=</span> <span class="n">now</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">old</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">delivery__assignment_group__parentnode__parentnode__end_time__lt</span> <span class="o">=</span> <span class="n">now</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">q</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Feedback.q_is_examiner"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Feedback.q_is_examiner">[docs]</a>    <span class="k">def</span> <span class="nf">q_is_examiner</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a django.models.Q object matching Deliveries where</span>
<span class="sd">        the given student is candidate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">(</span><span class="n">delivery__assignment_group__examiners</span><span class="o">=</span><span class="n">user_obj</span><span class="p">)</span>
    </div>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Feedback</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delivery</span><span class="o">.</span><span class="n">assignment_group</span><span class="o">.</span><span class="n">update_gradeplugin_cached_fields</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;Feedback on </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">delivery</span>

<div class="viewcode-block" id="Feedback.get_grade_object_info"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Feedback.get_grade_object_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_grade_object_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get information about the grade object as a string. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;content_type: </span><span class="si">%s</span><span class="s">, object_id:</span><span class="si">%s</span><span class="s">, &#39;</span> \
                <span class="s">&#39;grade: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_id</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">grade</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Feedback.get_grade"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Feedback.get_grade">[docs]</a>    <span class="k">def</span> <span class="nf">get_grade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get :attr:`grade`, but raise :exc:`ValueError` if the grade</span>
<span class="sd">        object is not a subclass of</span>
<span class="sd">        :class:`devilry.core.gradeplugin.GradeModel`. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grade</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_gradeobj</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grade</span>
</div>
<div class="viewcode-block" id="Feedback.validate_gradeobj"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Feedback.validate_gradeobj">[docs]</a>    <span class="k">def</span> <span class="nf">validate_gradeobj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Validate the grade object integrity. When this fails, the</span>
<span class="sd">        database integrity is corrupt. Raises one of the subclasses of</span>
<span class="sd">        :exc:`devilry.core.gradeplugin.GradePluginError` on error. &quot;&quot;&quot;</span>
        <span class="n">assignment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delivery</span><span class="o">.</span><span class="n">assignment_group</span><span class="o">.</span><span class="n">parentnode</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_assignment</span><span class="p">()</span><span class="o">.</span><span class="n">get_gradeplugin_registryitem</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">gradeplugin</span><span class="o">.</span><span class="n">GradePluginDoesNotExistError</span><span class="p">(</span><span class="s">&#39;Feedback with &#39;</span>\
                    <span class="s">&#39;id </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">) belongs in a assignment (</span><span class="si">%s</span><span class="s">) with a &#39;</span>\
                    <span class="s">&#39;invalid gradeplugin. &#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">assignment</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grade</span><span class="p">,</span> <span class="n">ri</span><span class="o">.</span><span class="n">model_cls</span><span class="p">):</span>
            <span class="n">correct_ct</span> <span class="o">=</span> <span class="n">ri</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">gradeplugin</span><span class="o">.</span><span class="n">WrongContentTypeError</span><span class="p">(</span>
                <span class="s">&#39;Grade-plugin on feedback with id &quot;</span><span class="si">%s</span><span class="s">&quot; (</span><span class="si">%s</span><span class="s">) must be &quot;</span><span class="si">%s</span><span class="s">&quot;, as on the &#39;</span> \
                <span class="s">&#39;assignment: </span><span class="si">%s</span><span class="s">. It is: </span><span class="si">%s</span><span class="s">. The content type on the feedback &#39;</span>\
                <span class="s">&#39;should be &quot;</span><span class="si">%s</span><span class="s"> (pk:</span><span class="si">%s</span><span class="s">)&quot;, not &quot;</span><span class="si">%s</span><span class="s"> (pk:</span><span class="si">%s</span><span class="s">)&quot;.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ri</span><span class="o">.</span><span class="n">get_key</span><span class="p">(),</span> <span class="n">assignment</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_grade_object_info</span><span class="p">(),</span>
                    <span class="n">correct_ct</span><span class="p">,</span> <span class="n">correct_ct</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Feedback.get_grade_as_short_string"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Feedback.get_grade_as_short_string">[docs]</a>    <span class="k">def</span> <span class="nf">get_grade_as_short_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the grade as a short string suitable for short one-line</span>
<span class="sd">        display.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grade</span><span class="o">.</span><span class="n">get_grade_as_short_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Feedback.get_grade_as_long_string"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Feedback.get_grade_as_long_string">[docs]</a>    <span class="k">def</span> <span class="nf">get_grade_as_long_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the grade as a longer string formatted with restructured</span>
<span class="sd">        text.</span>

<span class="sd">        :return:</span>
<span class="sd">            None if getting long string is not supported by the grade</span>
<span class="sd">            plugin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grade</span><span class="o">.</span><span class="n">get_grade_as_long_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Feedback.set_grade_from_xmlrpcstring"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Feedback.set_grade_from_xmlrpcstring">[docs]</a>    <span class="k">def</span> <span class="nf">set_grade_from_xmlrpcstring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grade</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the grade from string. This is primarly intended for xmlrpc, and</span>
<span class="sd">        a grade-plugin is not required to support it.</span>
<span class="sd">        </span>
<span class="sd">        Raises :exc:`NotImplementedError` if the grade-plugin do not support</span>
<span class="sd">        setting grades from string.</span>

<span class="sd">        Raises :exc:`ValueError` if the grade-plugin given grade is invalid</span>
<span class="sd">        for this grade-plugin. The error message in the exception is suited</span>
<span class="sd">        for direct display to the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delivery</span><span class="o">.</span><span class="n">assignment_group</span><span class="o">.</span><span class="n">parentnode</span><span class="o">.</span><span class="n">grade_plugin</span>
        <span class="n">model_cls</span> <span class="o">=</span> <span class="n">gradeplugin</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">model_cls</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grade</span><span class="p">:</span>
            <span class="n">ok_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grade</span><span class="o">.</span><span class="n">set_grade_from_xmlrpcstring</span><span class="p">(</span><span class="n">grade</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grade</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gradeobj</span> <span class="o">=</span> <span class="n">model_cls</span><span class="p">()</span>
            <span class="n">ok_message</span> <span class="o">=</span> <span class="n">gradeobj</span><span class="o">.</span><span class="n">set_grade_from_xmlrpcstring</span><span class="p">(</span><span class="n">grade</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">gradeobj</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grade</span> <span class="o">=</span> <span class="n">gradeobj</span>
        <span class="k">return</span> <span class="n">ok_message</span>
</div>
<div class="viewcode-block" id="Feedback.get_grade_as_xmlrpcstring"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Feedback.get_grade_as_xmlrpcstring">[docs]</a>    <span class="k">def</span> <span class="nf">get_grade_as_xmlrpcstring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the grade as a string compatible with</span>
<span class="sd">        :meth:`set_grade_from_xmlrpcstring`. This is primarly intended for xmlrpc,</span>
<span class="sd">        and a grade-plugin is not required to support it.</span>

<span class="sd">        If you need a simple string representation, use :meth:`get_grade_as_short_string`</span>
<span class="sd">        instead.</span>

<span class="sd">        Raises :exc:`NotImplementedError` if the grade-plugin do not support</span>
<span class="sd">        getting grades as string.</span>

<span class="sd">        :return:</span>
<span class="sd">            None if getting grade as xmlrpcstring is not supported by</span>
<span class="sd">            the grade plugin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grade</span><span class="o">.</span><span class="n">get_grade_as_xmlrpcstring</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="Feedback.get_assignment"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Feedback.get_assignment">[docs]</a>    <span class="k">def</span> <span class="nf">get_assignment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shortcut for getting the assignment</span>
<span class="sd">        (``delivery.assignment_group.parentnode``).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">delivery</span><span class="o">.</span><span class="n">assignment_group</span><span class="o">.</span><span class="n">parentnode</span>
</div>
<div class="viewcode-block" id="Feedback.clean"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.Feedback.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate the Feedback, making sure it does not do something stupid.</span>

<span class="sd">        Always call this before save()! Read about validation here:</span>
<span class="sd">        http://docs.djangoproject.com/en/dev/ref/models/instances/#id1</span>

<span class="sd">        Raises ValidationError if:</span>

<span class="sd">            - :attr:`grade` is not a instance of the model-class</span>
<span class="sd">              defined in</span>
<span class="sd">              :attr:`devilry.core.gradeplugin.RegistryItem.model_cls`</span>
<span class="sd">              referred by :attr:`Assignment.grade_plugin`.</span>
<span class="sd">            - The node is the child of itself or one of its childnodes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grade</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_gradeobj</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Feedback</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="FileMeta"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.FileMeta">[docs]</a><span class="k">class</span> <span class="nc">FileMeta</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents the metadata for a file belonging to a `Delivery`_.</span>

<span class="sd">    .. attribute:: delivery</span>

<span class="sd">        A django.db.models.OneToOneField_ that points to the `Delivery`_ to</span>
<span class="sd">        be given feedback.</span>

<span class="sd">    .. attribute:: filename</span>

<span class="sd">        Name of the file.</span>

<span class="sd">    .. attribute:: size</span>

<span class="sd">        Size of the file in bytes.</span>

<span class="sd">    .. attribute:: deliverystore</span>

<span class="sd">        The current :ref:`DeliveryStore &lt;devilry.apps.core.deliverystore&gt;`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">delivery</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Delivery</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;filemetas&#39;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>

    <span class="n">deliverystore</span> <span class="o">=</span> <span class="n">load_deliverystore_backend</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;FileMeta&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;FileMetas&#39;</span><span class="p">)</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;delivery&#39;</span><span class="p">,</span> <span class="s">&#39;filename&#39;</span><span class="p">)</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="FileMeta.remove_file"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.FileMeta.remove_file">[docs]</a>    <span class="k">def</span> <span class="nf">remove_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove the file using the</span>
<span class="sd">        :meth:`~devilry.core.deliverystore.DeliveryStoreInterface.remove`-method</span>
<span class="sd">        of the :attr:`deliverystore`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">deliverystore</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FileMeta.file_exists"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.FileMeta.file_exists">[docs]</a>    <span class="k">def</span> <span class="nf">file_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the file exists using the</span>
<span class="sd">        :meth:`~devilry.core.deliverystore.DeliveryStoreInterface.exists`-method</span>
<span class="sd">        of the :attr:`deliverystore`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">deliverystore</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FileMeta.read_open"><a class="viewcode-back" href="../../../../core.models.html#devilry.apps.core.models.FileMeta.read_open">[docs]</a>    <span class="k">def</span> <span class="nf">read_open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open file for reading using the</span>
<span class="sd">        :meth:`~devilry.core.deliverystore.DeliveryStoreInterface.read_open`-method</span>
<span class="sd">        of the :attr:`deliverystore`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">deliverystore</span><span class="o">.</span><span class="n">read_open</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>

</div>
<span class="k">def</span> <span class="nf">filemeta_deleted_handler</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">filemeta</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;instance&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">filemeta</span><span class="o">.</span><span class="n">remove_file</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">FileNotFoundError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="c"># TODO: We should have some way of cleaning files which have no</span>
        <span class="c"># corresponding FileMeta from DeliveryStores (could happen if the</span>
        <span class="c"># disk is not mounted when this kicks in..</span>
        <span class="k">pass</span>

<span class="k">def</span> <span class="nf">feedback_grade_delete_handler</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">feedback</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;instance&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">feedback</span><span class="o">.</span><span class="n">grade</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">feedback</span><span class="o">.</span><span class="n">grade</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">feedback_update_assignmentgroup_status_handler</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">feedback</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;instance&#39;</span><span class="p">]</span>
    <span class="n">feedback</span><span class="o">.</span><span class="n">delivery</span><span class="o">.</span><span class="n">assignment_group</span><span class="o">.</span><span class="n">_update_status</span><span class="p">()</span>
    <span class="n">feedback</span><span class="o">.</span><span class="n">delivery</span><span class="o">.</span><span class="n">assignment_group</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">delivery_update_assignmentgroup_status_handler</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">delivery</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;instance&#39;</span><span class="p">]</span>
    <span class="n">delivery</span><span class="o">.</span><span class="n">assignment_group</span><span class="o">.</span><span class="n">_update_status</span><span class="p">()</span>
    <span class="n">delivery</span><span class="o">.</span><span class="n">assignment_group</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="kn">from</span> <span class="nn">django.db.models.signals</span> <span class="kn">import</span> <span class="n">pre_delete</span><span class="p">,</span> <span class="n">post_save</span>
<span class="n">pre_delete</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">filemeta_deleted_handler</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">FileMeta</span><span class="p">)</span>
<span class="n">pre_delete</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">feedback_grade_delete_handler</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">Feedback</span><span class="p">)</span>
<span class="n">post_save</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">feedback_update_assignmentgroup_status_handler</span><span class="p">,</span>
        <span class="n">sender</span><span class="o">=</span><span class="n">Feedback</span><span class="p">)</span>
<span class="n">post_save</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">delivery_update_assignmentgroup_status_handler</span><span class="p">,</span>
        <span class="n">sender</span><span class="o">=</span><span class="n">Delivery</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Devilry v1.0 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, The Devilry Team.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>